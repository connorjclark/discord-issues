## ‚ùåLayered Lock Blocks Don't Work by Default (#2029)
@connorjclark (discord: connorclark) opened this issue on 11/14/2022
Status: unknown
Tags: 
Source: #dev-discussion https://discord.com/channels/876899628556091432/1041621976596348948


=== @connorjclark (discord: connorclark) 11/14/2022 07:53

~2x faster rendering, hardware cursors, simplified rendering code quite a bit, and attempting to handle scaling better (see the options in launcher re: scaling mode and force integer scaling)

Posting a test build before releasing as nightly.

https://github.com/connorjclark/ZeldaClassic/releases/tag/connorjclark-nightly-2022-11-14

@<role: Tester>
(meta) thread name was changed: Rendering refactor feedback

=== @connorjclark (discord: connorclark) 11/14/2022 07:56

Oops, forgot to add `scaling_mode` to the launcher. Control that setting manually in the cfg files - 0 for nearest neighbor scaling, 1 for linear scaling.

=== @arceusplayer11 (discord: Deedee) 11/14/2022 08:36

oooh
have to try this tomorrow

=== @ Majora 11/14/2022 16:59

Well shit. I thought i'd get cute with it and try to do this shit on the Surface at Mcdonalds but I get a black screen trying to launch ZC. Haven't tried ZQ yet. Although this wasn't a clean launch, I fiddled in ZCL for a bit before launching
Also, what relationship, if any, is there between Window Width/Height and Resolution?
![image](https://cdn.discordapp.com/attachments/1041621976596348948/1041759349816709231/Capture.PNG?ex=65e5fdff&is=65d388ff&hm=4a948f82cbfdf18693d183288e69d0373378a70b9a7dce3bf6e893d8072a1a3b&)

=== @connorjclark (discord: connorclark) 11/14/2022 17:02

(replying to @ Majora "Also, what relationship, if a‚Ä¶"): This needs to be cleaned up. Just use whatever one seems to change the size. Conceptually these are same

=== @ Majora 11/14/2022 17:02

oh, gotcha

=== @ mitchfork 11/14/2022 17:03

Yup, going to type up detailed feedback, but can confirm ZC goes to black screen to me regardless of settings.  Windows 10, 64 bit

=== @connorjclark (discord: connorclark) 11/14/2022 17:03

I don't have windows still so ugh. Allegro OS differences I guess.

=== @ mitchfork 11/14/2022 17:03

ZQ opens fine (but will send details once I test more)

=== @ mitchfork 11/14/2022 17:15

ZC: 
- Cannot open.  Only get black screen.  I do have a cursor (with an improper alpha channel) but nothing loads.

ZQuest:
- I see no difference between nearest neighbor and linear scaling (screenshots attached from toggling this).  The setting is not being overwritten or changed incorrectly, it's just setting `scaling mode = 0` or `scaling mode = 1` doesn't have any effect.  I suspect that linear mode is not actually working for me.
- All of the new toggles (autosave window size, lock aspect ratio, save window position, force int scale) seem like they are working as expected.
- The cursor scale is now properly unlocked from the window scale.  HUGE improvement, especially for small mode, where the cursor has been mega-size since the a5 transfer.  Please leave as-is.

ZLauncher:
- Alpha channel on cursor is not properly setup - see photo (print screen doesn't capture the cursor)
- Fields such as "Window Height" and "Saved Window X" only update when ZLauncher is relaunched or the value is edited in ZLauncher.  This means there are some inconsistencies with saved values when ZQ is closed.  The actual program behavior is fine, the values in ZLauncher will just be incorrect sometimes.  Unsure if this is a big enough deal to warrant a complicated fix, just wanted to note

![image](https://cdn.discordapp.com/attachments/1041621976596348948/1041763406086148228/PXL_20221114_170921309.jpg?ex=65e601c7&is=65d38cc7&hm=7c7f526b467e97a90ea8c8c17666ec40c05091408e6e7cea24c9bb6393ab8945&)
Photo showing alpha channel stuff

=== @EmilyV99 (discord: Emily) 11/14/2022 17:19

What does your last point on zlauncher mean exactly?

=== @ mitchfork 11/14/2022 17:21

(replying to @EmilyV99 (discord: Emily) "What does your last point on‚Ä¶"): - If I set the resolution in ZLauncher to, say, 500x500 and launch, it will be at 500x500.  
- If I adjust the resolution to 1000x1000 (and have the option "Autosave Window Size Changes" checked), it will save 1000x1000 to the cfg file and open at that resolution (proper behavior), but ZLauncher will continue to have 500x500 in the fields.
- If I exit ZLauncher and reopen it, it will properly update to 1000x1000

=== @connorjclark (discord: connorclark) 11/14/2022 17:22

Do any fields update in launcher without a refresh if a program changes them?

=== @EmilyV99 (discord: Emily) 11/14/2022 17:22

(replying to @ mitchfork "- If I set the resolution in‚Ä¶"): .... Yeah, that's how the launcher has ALWAYS worked for ALL settings

=== @ Majora 11/14/2022 17:22

Nope, nothing updates without user input.
I don't think any settings save until a program closes

=== @connorjclark (discord: connorclark) 11/14/2022 17:22

It's a good point, maybe file as a new FR though and one day can address it

=== @EmilyV99 (discord: Emily) 11/14/2022 17:23

To do anything else would require the launcher constantly polling the config files, which would be likely not good

=== @ mitchfork 11/14/2022 17:23

I don't think so, I think if you edit the cfg manually ZLauncher won't match until you relaunch.  So it's not new, and like I said maybe not worth the headache of fixing.  These settings just make it more visible

=== @connorjclark (discord: connorclark) 11/14/2022 17:23

@EmilyV99 (discord: Emily) we can maybe use a file watcher

=== @EmilyV99 (discord: Emily) 11/14/2022 17:23

I don't know what that is
If you have fancy ideas go ahead and fancy

=== @connorjclark (discord: connorclark) 11/14/2022 17:23

OS tells you when a change happens

=== @EmilyV99 (discord: Emily) 11/14/2022 17:23

But that's absolute minimum priority
So many things are more important than that

=== @connorjclark (discord: connorclark) 11/14/2022 17:24

@ mitchfork thanks for detailed report.

No need for further testing from Windows until I work out the big breakage there.

=== @connorjclark (discord: connorclark) 11/14/2022 17:25

(replying to @connorjclark (discord: connorclark) "This needs to be cleaned up.‚Ä¶"): @arceusplayer11 (discord: Deedee) thoughts on how to consolidate the options here?

=== @EmilyV99 (discord: Emily) 11/14/2022 17:26

The resolution dropdown should just be removed
The window w/h should be a full replacement

=== @ mitchfork 11/14/2022 17:28

idk, it's nice to have a way to just say "i want it double size" and let the program do the math but it is conflicting

=== @EmilyV99 (discord: Emily) 11/14/2022 17:28

You can do that in ZQ or ZC in the "video mode" dialog

=== @ Majora 11/14/2022 17:28

Dropdown is bugged anyways. Picking 1280x960 makes it jump to 1600x1200.

=== @ mitchfork 11/14/2022 17:28

yeah true.  And that still works perfectly in ZQ as far as I can tell

![image](https://cdn.discordapp.com/attachments/1041621976596348948/1041766809587679243/scale0.png?ex=65e604f2&is=65d38ff2&hm=71b2fc7df621048fb8480e6bbbe49d1fbdfe3032ce6ce92efaf43836252ae078&)
Also just for noting - screenshots of ZQ with the scaling mode set to different things.  Just to document that I'm not seeing any difference

=== @arceusplayer11 (discord: Deedee) 11/14/2022 18:08

(replying to @connorjclark (discord: connorclark) "@arceusplayer11 (discord: Deedee) thought‚Ä¶"): I think removing resolution completely and using window w/h; but also having some way of defaulting it to 1x/1.5x/2x/etc from the launcher

=== @connorjclark (discord: connorclark) 11/14/2022 18:13

I'll just remove it for now keep just input

=== @EmilyV99 (discord: Emily) 11/14/2022 18:14

(replying to @arceusplayer11 (discord: Deedee) "I think removing resolution c‚Ä¶"): Aye, similar to how I did in the video mode dialog
Which just has buttons that set hardcoded values into the textfields

=== @connorjclark (discord: connorclark) 11/14/2022 18:14

Maybe you could do a button near the resolution fields to assign presets
Yea

=== @EmilyV99 (discord: Emily) 11/14/2022 18:15

I can handle that at some point once everything is merged

=== @connorjclark (discord: connorclark) 11/14/2022 18:15

For now I'll just delete shit cuz it's easy üòÇ

=== @EmilyV99 (discord: Emily) 11/14/2022 18:15

(replying to @EmilyV99 (discord: Emily) "I can handle that at some poi‚Ä¶"): Just be sure to remind me lol

=== @arceusplayer11 (discord: Deedee) 11/15/2022 02:38

@connorjclark (discord: connorclark) any way I can help with this?

=== @connorjclark (discord: connorclark) 11/15/2022 02:48

> it's just setting scaling mode = 0 or scaling mode = 1 doesn't have any effect

fixed this!

=== @connorjclark (discord: connorclark) 11/15/2022 02:49

(replying to @arceusplayer11 (discord: Deedee) "@connorjclark (discord: connorclark) any way‚Ä¶"): hmm, maybe you can tell me what the `al_get_display_width()`  is in windows? I'm about to setup a virtual box to try to debug but doing visual studio like that would be tough...
https://github.com/connorjclark/ZeldaClassic/tree/render-refactor is the branch

=== @arceusplayer11 (discord: Deedee) 11/15/2022 02:50

you want me to trace the return value of it?

=== @connorjclark (discord: connorclark) 11/15/2022 02:50

yeah
just see what the heck is happening in `_a5_setup_screen`
does it error, any interesting logs, etc.

=== @arceusplayer11 (discord: Deedee) 11/15/2022 02:51

Alright, can do; might be a second cause I'm looking at another issue

=== @connorjclark (discord: connorclark) 11/15/2022 04:23

Will be calling it a night soonish

=== @arceusplayer11 (discord: Deedee) 11/15/2022 07:27

yeah sorry, attention span is bad

=== @connorjclark (discord: connorclark) 11/15/2022 07:42

https://github.com/connorjclark/ZeldaClassic/releases/tag/connorjclark-nightly-2022-11-15

Newer stuff, but still no fix for windows player

=== @ mitchfork 11/15/2022 15:57

Seems like this fixed everything I found on the ZLauncher/ZQuest side üëç

=== @connorjclark (discord: connorclark) 11/16/2022 22:54

My attempt to use a virtual machine to test windows stuff failed horribly.

=== @EmilyV99 (discord: Emily) 11/16/2022 22:55

Oof

=== @connorjclark (discord: connorclark) 11/16/2022 22:55

I guess I should just setup my desktop on the kitchen table at this point.

=== @arceusplayer11 (discord: Deedee) 11/17/2022 08:43

Trying to test it now; took a bit cause I had to clone the repo and despite it being easy it felt spooky since it's been a while since I've done it

=== @arceusplayer11 (discord: Deedee) 11/17/2022 09:01

@connorjclark (discord: connorclark) get_width traces as 494 (unless I'm getting a trace mixed up)
I'm able to open it fine at the right size
![image](https://cdn.discordapp.com/attachments/1041621976596348948/1042726245944795186/image.png?ex=65e9827d&is=65d70d7d&hm=115cdf0e63709b7f6232c50f1ac8b3fffcf895fe60cc77c75977bdea7c58dac6&)
But that could be due to me reusing a config
There is black artifacting on the title screen, unsure if that's a thing that was there before ora thing that's newly introduced

=== @ Orithan 11/17/2022 09:03

This was not a thing before

=== @arceusplayer11 (discord: Deedee) 11/17/2022 09:04

fiddling around with the resizing, I can get the screen to be cropped (this is the entire window) (happens when shrinking)
![image](https://cdn.discordapp.com/attachments/1041621976596348948/1042726872561238076/image.png?ex=65e98313&is=65d70e13&hm=cc266a112ba29741835ff3f612139e83c77daac38d6cc5cd4b266b2288770aec&)
I can also get the screen to be offcenter from the letterboxing
![image](https://cdn.discordapp.com/attachments/1041621976596348948/1042727062147960882/image.png?ex=65e98340&is=65d70e40&hm=ffbc762e5d0cfd5b836d5d880042c3a1b4275d055ef5dd08b5095384256021e8&)

=== @connorjclark (discord: connorclark) 11/17/2022 09:06

I don't think there is a windows problem anymore. I set this:

```
skip_logo = 0
skip_title = 0
```

and got a black screen until I hit Enter
so it was probably that?

=== @arceusplayer11 (discord: Deedee) 11/17/2022 09:07

noticing the screen tints blue when paused; before it would tint grey. Is this intentional? Not opposed to it, just wondering
![image](https://cdn.discordapp.com/attachments/1041621976596348948/1042727576461906062/image.png?ex=65e983bb&is=65d70ebb&hm=2a3f316083126f0d40e061dc79486c437871e5dd96d390d83a090ac4fbb306aa&)

=== @connorjclark (discord: connorclark) 11/17/2022 09:07

I always skip those things so that explains why they don't work yet üòõ

=== @arceusplayer11 (discord: Deedee) 11/17/2022 09:07

ahhh

=== @connorjclark (discord: connorclark) 11/17/2022 09:07

It was intentional.

=== @arceusplayer11 (discord: Deedee) 11/17/2022 09:08

I'm noticing that if you minimize while it's tinted/paused, the screen goes black until you click it again

=== @arceusplayer11 (discord: Deedee) 11/17/2022 09:09

oh, huh. Deleted the config file, now the title screen is pure black
dafuq
oooh, hardware mouse!!!
üòÑ
The transparency on the mouse doesn't work, it draws the transparent parts as black
but I think that was already reported?

=== @connorjclark (discord: connorclark) 11/17/2022 09:12

It works for me, so we'll need to figure out what the difference is.

=== @connorjclark (discord: connorclark) 11/17/2022 09:14

Does the cursor render correctly for you in zlauncher?

=== @arceusplayer11 (discord: Deedee) 11/17/2022 09:15

Oh, yes, it does!
hard to state just how much hardware cursor makes this feel more smooth

=== @arceusplayer11 (discord: Deedee) 11/17/2022 09:18

trying out zquest; combo placing feels a lot slower than it used to be

=== @arceusplayer11 (discord: Deedee) 11/17/2022 09:22


![image](https://cdn.discordapp.com/attachments/1041621976596348948/1042731417689407518/2022-11-17_04-19-56.mp4?ex=65e9874e&is=65d7124e&hm=84525b9dba54bb6f9441538f45fb7208a384fb684144f02733a9e1aa1bc7fe73&)
let's see if this video embeds...
seems to

=== @arceusplayer11 (discord: Deedee) 11/17/2022 09:23

it seems like the combo only places when I'm dragging the mouse either once I stop holding the mouse button, or move the mouse over to the next combo
maybe the screen isn't redrawing when it's supposed to? (flags seem to work mostly fine though)
also, noticing that sometimes when I click/unclick quickly, ZQuest doesn't catch it and won't place the combo/f;ag, where before I'm pretty sure it always caught it before

=== @connorjclark (discord: connorclark) 11/17/2022 09:26

yeah looks like the drawing isn't always happening when mouse is down

I'm going to bed now, but I'll check out all the things you find tomorrow probably.

=== @arceusplayer11 (discord: Deedee) 11/17/2022 09:26

üëç

=== @arceusplayer11 (discord: Deedee) 11/17/2022 09:30

not a bug, but whenever you see this; currently, the code that handles the config for maintaining aspect ratio only does it after you're done resizing. I think I've seen programs do it while resizing; is it feasible for us to do the same? am I even remembering correctly?

=== @connorjclark (discord: connorclark) 11/17/2022 19:35

(replying to @arceusplayer11 (discord: Deedee) "Trying to test it now; took a‚Ä¶"): btw you could also do `git remote add connor https://github.com/connorjclark/ZeldaClassic.git` in your normal checkout, then all my branches are available like `git checkout connor/render-refactor`
`git fetch connor` to grab updates
no need to juggle multiple checkouts

=== @connorjclark (discord: connorclark) 11/17/2022 22:46

(replying to @arceusplayer11 (discord: Deedee) "maybe the screen isn't redraw‚Ä¶"): fixed- had to pass force=true to update_hw_screen in `refresh()`

=== @connorjclark (discord: connorclark) 11/17/2022 22:47

(replying to @arceusplayer11 (discord: Deedee) "also, noticing that sometimes‚Ä¶"): Are you sure this is specific to this build? I'm not sure how my changes could have impacted this.

=== @arceusplayer11 (discord: Deedee) 11/17/2022 23:03

(replying to @connorjclark (discord: connorclark) "Are you sure this is specific‚Ä¶"): I checked the main 2.55 branch and am not noticing it
I'll check in 107 (to see if it's a problem with the hardware cursor)

=== @arceusplayer11 (discord: Deedee) 11/17/2022 23:05

doesn't appear to happen in 107

=== @arceusplayer11 (discord: Deedee) 11/17/2022 23:09

wait, no, it happens in 107

=== @arceusplayer11 (discord: Deedee) 11/17/2022 23:11

okay, nevermind, I think it's just my touchpad sometimes registering clicks as a middle click

=== @arceusplayer11 (discord: Deedee) 11/17/2022 23:21

(replying to @connorjclark (discord: connorclark) "fixed- had to pass force=true‚Ä¶"): doesn't appear to be fixed
unless you didn't push it? seems like the last commit was 4 minutes before you sent that
no, you did make that change
No clue why that didn't fix it though

=== @connorjclark (discord: connorclark) 11/17/2022 23:31

@<role: Tester> latest: https://github.com/connorjclark/ZeldaClassic/releases/tag/connorjclark-nightly-2022-11-17-4

=== @connorjclark (discord: connorclark) 11/17/2022 23:36

(replying to @arceusplayer11 (discord: Deedee) "No clue why that didn't fix i‚Ä¶"): True, I still see it too.

=== @connorjclark (discord: connorclark) 11/17/2022 23:46

Fixed for real this time.

=== @EmilyV99 (discord: Emily) 11/17/2022 23:53

For the record, the intent behind the `bool force` is
calling update_hw_screen in a loop, would only do the draw every 1/60th of a second
but in some situations, it needed to be called a single time before a holding call
there was an issue some months ago when I changed zc to use the hw_screen stuff where when binding controls, it wouldn't draw the prompt to press a button

=== @connorjclark (discord: connorclark) 11/17/2022 23:54

Yeah, I know, I thought it was the same deal in this loop. But the loop was just busy looping when the mouse didnt change tiles.

=== @EmilyV99 (discord: Emily) 11/17/2022 23:54

adding that was the fix

=== @connorjclark (discord: connorclark) 11/17/2022 23:54

I've uesed the force=true thing once or twice to accomplish the same you've described
It should now look smoother, with all the things animating while the mouse is dragged around.

=== @EmilyV99 (discord: Emily) 11/17/2022 23:55

I would expect that loop to only have needed an `update_hw_screen()` at the top of the loop
but, your solution does that as well

=== @connorjclark (discord: connorclark) 11/17/2022 23:55

That misses on some animation stuffs

=== @EmilyV99 (discord: Emily) 11/17/2022 23:55

aye, that was the old behavior regardless, so that's all it would need for a fix
yours adds the animations playing
which I suppose can't hurt, so
üëç

=== @connorjclark (discord: connorclark) 11/17/2022 23:56

it looked pretty jank üëÄ
like I was harming ZQ by dragging my mouse lol
BTW, I made sure the Matrix thing and the various titlescreens should all work.
the credits were a bit tricky too

=== @EmilyV99 (discord: Emily) 11/17/2022 23:57

Yeah, there's a bunch of total jank there
just looking through your commits now, I understand at least half of what I'm seeing
which is more than I expected

=== @connorjclark (discord: connorclark) 11/17/2022 23:58

but now...we're pretty close to a decent implementation of mixing allegro 5 and allegro 4 bitmaps on the screen, in a resolution-independent manner.
via the `render.cpp` files

=== @EmilyV99 (discord: Emily) 11/17/2022 23:59

looking at just the code, looks like fancy stuff
probably will grab a test build later

=== @connorjclark (discord: connorclark) 11/18/2022 00:10

The "render tree" thing in base/render.cpp is super basic - really it just encapsulates very well the various scaling which used to be _all over the place_. It supports x,y and scale transforms which are applied to all children, but only ZC really uses it, and even then the hierarchy is basic (there's a root element, and only it has children).

It could perhaps make possible some extensions to the ZQ gui ‚Äìlike multiple screens being visible, or panels moving/scaling with the resolution differently than other panels... idk yet what'd would be good to do here, but the render tree should help make it easier to implement whatever ideas we have.

=== @EmilyV99 (discord: Emily) 11/18/2022 00:20

That sounds really good

=== @connorjclark (discord: connorclark) 11/18/2022 01:05

```
diff --git a/src/launcher/launcher_dialog.cpp b/src/launcher/launcher_dialog.cpp
index 18d5e2b4c..93bee02dd 100644
--- a/src/launcher/launcher_dialog.cpp
+++ b/src/launcher/launcher_dialog.cpp
@@ -487,7 +487,7 @@ std::shared_ptr<GUI::Widget> LauncherDialog::view()
                 )),
                 TabRef(name = "ZQ Creator", Row(framed = true,
                     Rows<2>(fitParent = true,
-                        CONFIG_CHECKBOX_I("Fullscreen","zquest.cfg","zquest","fullscreen",0,"Not exactly 'stable'."),
+                        CONFIG_CHECKBOX_I("Fullscreen","zquest.cfg","zquest","fullscreen",0,"Exactly stable."),
                         CONFIG_CHECKBOX_I("Small Mode","zquest.cfg","zquest","small",0,"If enabled, the 'classic' small mode interface will be used. This mode has less screen space, and lacks features such as favorite combos, favorite commands, multiple combo rows, next-screen preview, etc."),
                         CONFIG_CHECKBOX("VSync","zquest.cfg","zquest","vsync",1),
                         CONFIG_CHECKBOX("Show FPS","zquest.cfg","zquest","showfps",0),
```

ü§î lol
well that didn't render very clearly.
![image](https://cdn.discordapp.com/attachments/1041621976596348948/1042968761520631808/image.png?ex=65ea645a&is=65d7ef5a&hm=bdb820a25af575642b8d80ac6772e5634c6f7fa21527a6821db3ba4c1eee887a&)

=== @EmilyV99 (discord: Emily) 11/18/2022 01:07

you actually have fullscreen working properly for once?

=== @connorjclark (discord: connorclark) 11/18/2022 01:15

Doesn't seem to crash for me anymore. Can't speak for windows.

=== @EmilyV99 (discord: Emily) 11/18/2022 01:17

It has never worked properly for over a decade as far as I'm aware
so

=== @connorjclark (discord: connorclark) 11/18/2022 01:25

That's a long time

Would it crash immediately or after some use randomly?

=== @EmilyV99 (discord: Emily) 11/18/2022 01:25

Immediately, and it wouldn't crash
it would glitch out horribly
in a way that would make me afraid of seizure if I had epilepsy

=== @connorjclark (discord: connorclark) 11/18/2022 01:27

I think I know why it was doing that, I'll explain after I pick up my poke bowl

=== @EmilyV99 (discord: Emily) 11/18/2022 01:27

hmm, though it actually seems to work in the master branch right now
and I know *other people* have had it working before
but *I* could never get it to work, on any computer I tried
....though I don't think I tried since my recent graphics card upgrade until just now and it's working
so ü§∑‚Äç‚ôÄÔ∏è

=== @EmilyV99 (discord: Emily) 11/18/2022 01:29

uhhh
though while it works fine on the master branch now for me
it does NOT work on your render refactor branch

![image](https://cdn.discordapp.com/attachments/1041621976596348948/1042974817135112223/image.png?ex=65ea69fd&is=65d7f4fd&hm=3b0e18ae4287eea6767fec9454746a7c3bd04224aefc0e4b969122d7c577db72&)
....this is apparently fullscreen.
also any time it reloads the screen there it seems to black out entirely

=== @connorjclark (discord: connorclark) 11/18/2022 01:30

Do you have my latest code

=== @EmilyV99 (discord: Emily) 11/18/2022 01:31

I thought so
but haven't fucked with remotes this much before
and apparently it just was able to pull more things
even though I had just pulled
one second

=== @connorjclark (discord: connorclark) 11/18/2022 01:32

well i push a lot
lol
if you're on the branch, all you should need to do it a normal git pull

=== @EmilyV99 (discord: Emily) 11/18/2022 01:32

well when I checked out the branch it was in a detached head state
so I had to get it to be a normal local branch first

=== @connorjclark (discord: connorclark) 11/18/2022 01:33

oof ok i'm outta my comfort zone then lol

=== @EmilyV99 (discord: Emily) 11/18/2022 01:33


![image](https://cdn.discordapp.com/attachments/1041621976596348948/1042975795569754112/image.png?ex=65ea6ae7&is=65d7f5e7&hm=ca3b0600adaa718b8ffad325fd54a40bb4401dcb5f19bcc7961e260a2e77209b&)
Now pulling fails compile miserably
....because you missed a comma right here
![image](https://cdn.discordapp.com/attachments/1041621976596348948/1042975904860737556/image.png?ex=65ea6b01&is=65d7f601&hm=91c31f6755dccd645fc96474970814af2361c957b8a68f82c50fe90149bc0799&)
launcher_dialog.cpp L521
oh, and multiple other issues looks like

=== @connorjclark (discord: connorclark) 11/18/2022 01:34

fixed

=== @EmilyV99 (discord: Emily) 11/18/2022 01:34


![image](https://cdn.discordapp.com/attachments/1041621976596348948/1042976112923398234/image.png?ex=65ea6b32&is=65d7f632&hm=ceccc85df4aa9c19b0b7e39b67241e11a5c7c483a8f0f59fcb6176c9262e2d44&)
referencing a nonexistant variable here in this block
zelda.cpp L5339

=== @connorjclark (discord: connorclark) 11/18/2022 01:35

just comment shit out real quick so you can see
it's just that block

=== @EmilyV99 (discord: Emily) 11/18/2022 01:35

and matching block in zquest.cpp
![image](https://cdn.discordapp.com/attachments/1041621976596348948/1042976255978524722/image.png?ex=65ea6b54&is=65d7f654&hm=66946057beee74c57fc51fca8ed24418b31ae6f8f443998a94d0963292f97bde&)

=== @connorjclark (discord: connorclark) 11/18/2022 01:35

that code bricks me on mac üòõ

=== @EmilyV99 (discord: Emily) 11/18/2022 01:36

just those 3 errors though

![image](https://cdn.discordapp.com/attachments/1041621976596348948/1042976689640194108/image.png?ex=65ea6bbc&is=65d7f6bc&hm=861c333d76b01224f1ea97d86348ab50aa6dc1270b54e6d6ed033a0ef6dcd894&)
and now it's working
(caught my graphics card overlay there lol)
but
tabbing out and back in

![image](https://cdn.discordapp.com/attachments/1041621976596348948/1042976823379755018/image.png?ex=65ea6bdc&is=65d7f6dc&hm=0f72192c91ba389dcc448ac9d69c850d978e6495afbf43162512e84c77cd0c5d&)
it blacks out still
Clicking to unpause fixes it though
![image](https://cdn.discordapp.com/attachments/1041621976596348948/1042976908645765200/image.png?ex=65ea6bf0&is=65d7f6f0&hm=7c15237a21cd64e768a757e6c00d4ccf7f9987970f80fe6b69e2fd38ba0cf338&)

=== @connorjclark (discord: connorclark) 11/18/2022 01:37

I think deedee reported that, should be ok again if you click i think

=== @EmilyV99 (discord: Emily) 11/18/2022 01:38

yeah
it's just not drawing properly on switching into the window when the pause is up
....uhhh

![image](https://cdn.discordapp.com/attachments/1041621976596348948/1042977093891403827/image.png?ex=65ea6c1c&is=65d7f71c&hm=83d445e96e6a2ebb686bfd16363c7b3dd2858d782b9c5e939a469f645a9a4e91&)
I turned off fullscreen
and
it's still
fullscreen
....ah I see
toggling fullscreen seems to require relaunching the program to apply
which was NOT the case previously
that's definitely an issue

=== @connorjclark (discord: connorclark) 11/18/2022 01:40

`bool windowed=is_windowed_mode()!=0;` is this value always the same on windows for you?

=== @EmilyV99 (discord: Emily) 11/18/2022 01:40

where is that

=== @connorjclark (discord: connorclark) 11/18/2022 01:41

wondering if the input to `set_gfx_mode` is right here
`onFullScreen`

=== @EmilyV99 (discord: Emily) 11/18/2022 01:41


![image](https://cdn.discordapp.com/attachments/1041621976596348948/1042977923642163271/image.png?ex=65ea6ce2&is=65d7f7e2&hm=5740d5f4d35aa3ce20c765c45ad4fa77865edcb0c1e7cd61929ed89b5dfb2d1a&)
these ternaries at the top are not always the same, they display the correct text based on the flag

=== @connorjclark (discord: connorclark) 11/18/2022 01:42

OSX doesn't support fullscreen apps, not really, it's a fake "windowed fullscreen" which never hijacks the res. so hard for to test this rn :/

=== @EmilyV99 (discord: Emily) 11/18/2022 01:42

so I presume based on that that `is_windowed_mode()` is returning the proper boolean value

=== @connorjclark (discord: connorclark) 11/18/2022 01:42

ok

=== @EmilyV99 (discord: Emily) 11/18/2022 01:42

(I built release not debug so would need a bit to do proper breakpoint checking)
(but that seems correct)

=== @connorjclark (discord: connorclark) 11/18/2022 01:47

for both issues you just mentioned, I wonder if `set_display_switch_mode(SWITCH_BACKAMNESIA)`  or `set_display_switch_mode(SWITCH_BACKGROUND)` is to blame

=== @connorjclark (discord: connorclark) 11/18/2022 01:51

there's various windows-only-fullscreen-specific stuff going on here. Also unclear if allegro5 just handles kinda stuff for us and a4 is just getting in the way here. Maybe should just always do `set_display_switch_mode(pause_in_background ? SWITCH_PAUSE : SWITCH_BACKGROUND);`

=== @EmilyV99 (discord: Emily) 11/18/2022 01:53

For the record, the switching in blacking out is entirely unrelated to fullscreen

=== @connorjclark (discord: connorclark) 11/18/2022 01:54

I just pushed two different tests for changing the switch mode, different for zc and zq, lmk if anything changed.
(for zc) also pause_in_background config will vary the switch mode

=== @EmilyV99 (discord: Emily) 11/18/2022 01:55

(replying to @connorjclark (discord: connorclark) "I just pushed two different t‚Ä¶"): Was there an issue in ZQ? I only tested ZC thus far and don't know how I would go about testing zq there

=== @connorjclark (discord: connorclark) 11/18/2022 01:55

You mentioned the fullscreen toggle not working.

=== @EmilyV99 (discord: Emily) 11/18/2022 01:55

oh, fix for that
only tested that in zc

=== @connorjclark (discord: connorclark) 11/18/2022 01:56

yeah I think both may be related.
I assumed the "fullscreen never worked" comment only applied to ZQ.

=== @EmilyV99 (discord: Emily) 11/18/2022 01:56

That only applied to ZC

=== @connorjclark (discord: connorclark) 11/18/2022 01:56

Since that's where the dialog `?` was
oooh
backwards oops

=== @EmilyV99 (discord: Emily) 11/18/2022 01:56

or well, only ever TESTED it in ZC
and again, worked for other people, just I never got it to work, even on multiple different devices
so driver bullshit

=== @EmilyV99 (discord: Emily) 11/18/2022 01:58

pulled, nothing fixed
aside from the compile errors
fullscreen still doesn't switch immediately, switch in still blacks out

=== @EmilyV99 (discord: Emily) 11/18/2022 01:59

`pause_in_background` was `0` in all the tests, will test with `1` now
...no difference whatsoever
is `game_pal()` somehow getting called somewhere?
that clears the screen to black when called

=== @EmilyV99 (discord: Emily) 11/18/2022 02:03

hmm, doesn't seem to be

=== @EmilyV99 (discord: Emily) 11/18/2022 02:05

toggling back-and-forth between fullscreen/windowed prints this to the console:
![image](https://cdn.discordapp.com/attachments/1041621976596348948/1042983844049059860/image.png?ex=65ea7266&is=65d7fd66&hm=33f319963a5dcfd3083aa4732378a4e225c04082bafbe0fa0e088866f58829ea&)
which is `Z_message("gfx mode set at -%d %dbpp %d x %d \n", is_windowed_mode(), get_color_depth(), resx, resy);`
so the `is_windowed_mode()` is absolutely changing value

=== @EmilyV99 (discord: Emily) 11/18/2022 02:07

Where is the blue tint applied over the screen?

=== @connorjclark (discord: connorclark) 11/18/2022 02:07

in `zc/render.cpp` try making this change:
![image](https://cdn.discordapp.com/attachments/1041621976596348948/1042984308731813968/image.png?ex=65ea72d4&is=65d7fdd4&hm=9317737b7dd0d5f9686ca60df930c4a053fcba9fa8fbdce45452f358468abd44&)
removing `ALLEGRO_NO_PRESERVE_TEXTURE` flag
that may fix the losing focus bug
docs say this is needed "For some platforms"... perhaps windows but not osx.
(replying to @EmilyV99 (discord: Emily) "Where is the blue tint applie‚Ä¶"): `zc/render.cpp` and `base/render.cpp`

=== @EmilyV99 (discord: Emily) 11/18/2022 02:08

(replying to @connorjclark (discord: connorclark) "removing `ALLEGRO_NO_PRESERVE‚Ä¶"): that fixed the switch in bug

=== @connorjclark (discord: connorclark) 11/18/2022 02:09

cool, I'll commit that

=== @EmilyV99 (discord: Emily) 11/18/2022 02:09

so now just the fullscreen not switching when toggled

=== @connorjclark (discord: connorclark) 11/18/2022 02:11

That's the case in ZC and ZQ right?

=== @EmilyV99 (discord: Emily) 11/18/2022 02:11

aye

=== @connorjclark (discord: connorclark) 11/18/2022 02:15

reading docs is good, actually
https://liballeg.org/a5docs/trunk/display.html#al_set_display_flag

![image](https://cdn.discordapp.com/attachments/1041621976596348948/1042986322350067784/image.png?ex=65ea74b4&is=65d7ffb4&hm=14d5a9e4fb3fd18324185e9efab75698ca9be090103f3847fdbb96b9f7ebe517&)
I was trying to not re-create the display (b/c that invalidates all the a5 bitmaps in the render tree...)

=== @EmilyV99 (discord: Emily) 11/18/2022 02:16

oof

=== @connorjclark (discord: connorclark) 11/18/2022 02:17

`al_convert_memory_bitmaps` is supposed to help there to restore said bitmaps on a new display but ... looks like those bitmaps also need a special flag that i forgot. So i'll try that

=== @EmilyV99 (discord: Emily) 11/18/2022 02:17

~~Also, new issue:~~
If clicking the `X` on the window OR pressing `Alt+F4` while paused, nothing occurs. Not until you click the screen to unpause does it pop up the `Would you like to quit?` dialog.

![image](https://cdn.discordapp.com/attachments/1041621976596348948/1042987137877938206/image.png?ex=65ea7577&is=65d80077&hm=574b29f0e0f954478b6aedd51318b62b132104b8a83b4c6f50ea06c1133812e3&)
This section of code is what handles both of those cases
...that's zquest's though
It happens in `syskeys()` here as well
![image](https://cdn.discordapp.com/attachments/1041621976596348948/1042987348754972763/image.png?ex=65ea75a9&is=65d800a9&hm=d39f50bf78dec24078073186c5894f4495a3badc3b3c2e2b8e1f58ce3a56d14b&)

=== @EmilyV99 (discord: Emily) 11/18/2022 02:21

hmmmm\

=== @EmilyV99 (discord: Emily) 11/18/2022 02:25

.....oh
that issue is completely unrelated to your rendering changes
and exists on master as well
and I only JUST noticed this? huh, surprised I didn't catch that sooner

=== @EmilyV99 (discord: Emily) 11/18/2022 02:32

(was easy to fix, too!)

=== @EmilyV99 (discord: Emily) 11/18/2022 02:36

....ah, alas
won't be able to put that fix on master without conflicting with render refactor, they touch the same areas

=== @EmilyV99 (discord: Emily) 11/18/2022 02:37

*oop*
well the AGN repo now has a `render-refactor` branch because I didn't double check the gui was pushing correctly
...it hasn't ever been wrong before, but *remotes* bleh
ah, not that I can push to your fork anyway @connorjclark (discord: connorclark)
mind giving me push access?

=== @connorjclark (discord: connorclark) 11/18/2022 02:42

Just pushed a potential fix for fullscreen toggle

=== @connorjclark (discord: connorclark) 11/18/2022 02:44

(replying to @EmilyV99 (discord: Emily) "mind giving me push access?"): done. but fair warning, if you ever force push i'll have to kill ya
üòÜ üî™

=== @connorjclark (discord: connorclark) 11/18/2022 02:45

(replying to @EmilyV99 (discord: Emily) "well the AGN repo now has a `‚Ä¶"): i deleted the branch on the upstream in the GH UI, so we don't get confused

=== @EmilyV99 (discord: Emily) 11/18/2022 02:46

oh for fucks
....I just pushed to that again
because it doesn't remember

=== @connorjclark (discord: connorclark) 11/18/2022 02:46

`git branch --set-upstream-to=connor/render-refactor`

=== @EmilyV99 (discord: Emily) 11/18/2022 02:46

the fucking selected remote

![image](https://cdn.discordapp.com/attachments/1041621976596348948/1042994250398314688/image.png?ex=65ea7c17&is=65d80717&hm=ee23add95c6f69d58ed550067d34393baad052f24cf923d0cb3b821bc154c1f2&)
This dropdown switches to `origin` every fucking time

=== @EmilyV99 (discord: Emily) 11/18/2022 02:48

(replying to @connorjclark (discord: connorclark) "`git branch --set-upstream-to‚Ä¶"): I had it set upstream already, but the GUI doesn't respect that at all. Completely ignores it.
I use the GUI for all staging/committing/pushing
and the cli for pulling/branching
and mostly the GH UI for merging via PRs
Anyway, question
How difficult would it be to, instead of just tinting the screen blue when paused, instead grayscale it?
(I was thinking we could have configs to allow customizing the tint, including a grayscale/monochrome option)
(Looking at the code, the custom tint colors seems easy; but I have no clue how to monochrome it, since you're using an allegro tint draw function)
(....would it require a separate bitmap for the monochrome version?)

=== @connorjclark (discord: connorclark) 11/18/2022 02:52

I'm not tied to what exactly we do here. Is grayscale better? I assumed it was only grayscaled because palette limitations
i picked blue because it matched the default theme I use which is blue (the moosh one) lol

=== @EmilyV99 (discord: Emily) 11/18/2022 02:52

ü§∑‚Äç‚ôÄÔ∏è I can see people not liking just the blue tint, I can see other people liking it, I'm not sure
figured giving people more options would be cool

=== @connorjclark (discord: connorclark) 11/18/2022 02:53

maybe the tint could be derived from theme ... or it could just be a normal black tint.

=== @EmilyV99 (discord: Emily) 11/18/2022 02:53

not a neccessary thing, just figured it would be a nice thing
could have options for the tint be part of the ztheme files, I can add that easily enough

=== @connorjclark (discord: connorclark) 11/18/2022 02:53

(replying to @connorjclark (discord: connorclark) "Just pushed a potential fix f‚Ä¶"): btw in case you missed

=== @EmilyV99 (discord: Emily) 11/18/2022 02:53

ah I did miss

=== @connorjclark (discord: connorclark) 11/18/2022 02:54

The configured color may need an alpha component, though it could just not and we hardcode the alpha value.
I found myself changing the alpha randomly dependent on the hue, for what felt good

=== @EmilyV99 (discord: Emily) 11/18/2022 02:54

easy enough to give that as a config too
I'd probably give RGB as 0-255 configs, and alpha as 0-100 as percentage (to avoid floating point shit in the config files)
and then just read those as necessary
Monochrome as a config would just be a 0/1 toggle then, the question being only how to implement it

=== @connorjclark (discord: connorclark) 11/18/2022 02:55

alpha is a full color channel, it should go 0-255

=== @EmilyV99 (discord: Emily) 11/18/2022 02:55

oh, ahk
all 4 values are `0 to 1` where they are used
I figured 'percentage alpha' would be more readable to users

=== @connorjclark (discord: connorclark) 11/18/2022 02:56

allegro5 gives two convenience functions, one is 0.0-1.0 and the other 0-255 domain
they are equivalent in the end, though

=== @EmilyV99 (discord: Emily) 11/18/2022 02:56

ah, makes sense

=== @connorjclark (discord: connorclark) 11/18/2022 02:56

at least, for our 8bit bitmaps.

=== @EmilyV99 (discord: Emily) 11/18/2022 02:59

....ok, so
fullscreen switching works now
BUT
when it switches *from fullscreen to windowed*, it's doing the blacking out the screen thing again
from windowed to fullscreen does NOT have that issue
only one direction
OH
and `pause_in_background` DOES affect it this time
With `pause_in_background = 1`, it's doing the exact same thing as before, blacking out the entire background
but
with `pause_in_background = 0`

![image](https://cdn.discordapp.com/attachments/1041621976596348948/1042998075851026482/image.png?ex=65ea7fa7&is=65d80aa7&hm=687d33de8bd67836b707e981d5c70b4d5e1815a0df9b784e52f9b0a8eac8864d&)
it's garbling something there instead

=== @connorjclark (discord: connorclark) 11/18/2022 03:04

At this point, I think I just need to setup my windows machine. Will do that over the weekend.
No hope working this out on my end with OSX being so different re: fullscreen.

=== @EmilyV99 (discord: Emily) 11/18/2022 03:05

aye, makes sense
For the record, in the future, instead of making a thread under dev-discussion for things like this
you can probably make a new forum channel instead, so bugs and ideas can be tracked individually
and it can move to the archive category when no longer needed

=== @connorjclark (discord: connorclark) 11/18/2022 03:06

do you remember when there were like 10000 channels though
that looked awful

=== @EmilyV99 (discord: Emily) 11/18/2022 03:07

aye, true

=== @connorjclark (discord: connorclark) 11/18/2022 03:07

I kind of like these one-off mega threads

=== @EmilyV99 (discord: Emily) 11/18/2022 03:07

adding a single forum channel for each *major rewrite of most of the engine* though isn't going to add too many

=== @EmilyV99 (discord: Emily) 11/18/2022 03:09

I'm really not sure how best to go about monochroming the background.... short of needing to monochrome the entire A4 palette, or manually do something to every pixel of the A5 bitmap?
unless.... hmm
time to just play with this some

=== @connorjclark (discord: connorclark) 11/18/2022 03:18

shader

=== @EmilyV99 (discord: Emily) 11/18/2022 03:18

I'm thinking I can just directly use `al_draw_tinted_bitmap` to monochrome it

=== @EmilyV99 (discord: Emily) 11/18/2022 03:19

Theoretically, a tint of `al_map_rgba_f(0.299, 0.587, 0.114, 1)` should do it
maybe
I'm thinking it won't
maybe
but I learn things by playing around with them so
let's see what this does

=== @connorjclark (discord: connorclark) 11/18/2022 03:20

hmm my guess would be like `al_map_rgba_f(0.01, 0.01, 0.01, 1)`
turn the color all the way down
but idk

=== @EmilyV99 (discord: Emily) 11/18/2022 03:20

Those values are based on the human eye perception of color
(replying to @connorjclark (discord: connorclark) "hmm my guess would be like `a‚Ä¶"): this would just black out the bitmap

=== @connorjclark (discord: connorclark) 11/18/2022 03:21

you gotta squint

=== @EmilyV99 (discord: Emily) 11/18/2022 03:21

....uhh
well whatever I did also just blacked out the bitmap
so

=== @EmilyV99 (discord: Emily) 11/18/2022 03:23

...Just using those values instead of your blue ones does this
![image](https://cdn.discordapp.com/attachments/1041621976596348948/1043003580522696774/image.png?ex=65ea84c7&is=65d80fc7&hm=019e5574adba241f33c8a3bd85d7807b26fbdd6f8710f818cbee325ec5ca0424&)
so clearly this is not at all what I want
the problem is, it's tinting the values separately
I need the result of those three multiplications to then be the value of *all 3* of r/g/b
and the tint function here just doesn't seem to do that

=== @EmilyV99 (discord: Emily) 11/18/2022 03:26

(replying to @connorjclark (discord: connorclark) "shader"): how do shader

=== @connorjclark (discord: connorclark) 11/18/2022 03:26

(replying to @EmilyV99 (discord: Emily) "and the tint function here ju‚Ä¶"): https://liballeg.org/a5docs/trunk/graphics.html#blending-modes
defaults to premultiplied alpha blending

=== @connorjclark (discord: connorclark) 11/18/2022 03:28

https://github.com/liballeg/allegro5/blob/master/examples/ex_shader.cpp

=== @connorjclark (discord: connorclark) 11/18/2022 03:30

here's a monochrome shader

https://www.shadertoy.com/view/Xt3fR7
better one: https://www.shadertoy.com/view/tdtcRj
looks like it's just dividing the color channels by 3...
so maybe changing the blend modes will get what you need.

=== @EmilyV99 (discord: Emily) 11/18/2022 03:31

Adding all 3 colors and dividing by 3 is a uniform distribution
but uh
none of the blending modes appear to be able to do remotely anything like that?
As far as I can see, only the `r` value can be used to determine the output `r` value, except in cases where it uses a constant color instead
there's no mode that allows `r = (sr+sg+sb)/3` or anything remotely close
or I'm very much not understanding how to do so at least
so either it isn't possible or this documentation is shit

=== @connorjclark (discord: connorclark) 11/18/2022 03:35

maybe 1) draw game bitmap as normal, no tint 2) set blend mode to ... something 3) do `al_draw_filled_rectangle` on top?
i'll just go ask in the allegro discord rn

=== @EmilyV99 (discord: Emily) 11/18/2022 03:35

Ideally I want:

=== @EmilyV99 (discord: Emily) 11/18/2022 03:36

```cpp
COLOR src;
COLOR out;
int gray = (src.r*0.299)+(src.g*0.587)+(src.b*0.114);
out.r = out.g = out.b = gray;```
assuming `COLOR` as a struct holding simple r/g/b values

=== @connorjclark (discord: connorclark) 11/18/2022 03:37

If we want that much control pretty sure we gotta use a shader
but lets see what the big brain allegro people say

=== @EmilyV99 (discord: Emily) 11/18/2022 03:39

looks like an ALLEGRO_PIXEL_SHADER is what we might want
just a question of how the fuck to set that up

=== @connorjclark (discord: connorclark) 11/18/2022 03:41

It's pretty straightforward, check out the example.

=== @EmilyV99 (discord: Emily) 11/18/2022 03:41

(replying to @connorjclark (discord: connorclark) "It's pretty straightforward,‚Ä¶"): `straightforward` is the absolute last word I would use

=== @connorjclark (discord: connorclark) 11/18/2022 03:41

Only odd part is we need to distribute the shader file alongside the exe. Could embed but...that's a bit more work.

=== @EmilyV99 (discord: Emily) 11/18/2022 03:41

looking at that example makes my head want to explode
and it doesn't help that every damn thing I look up takes like a full minute to load the documentation pages

=== @connorjclark (discord: connorclark) 11/18/2022 03:43

use https://liballeg.org/
not allegro.cc
the first is the official site
the second is the forums / someone's shitty free tier hosting

=== @EmilyV99 (discord: Emily) 11/18/2022 03:43

I see no search bar of any kind there

=== @connorjclark (discord: connorclark) 11/18/2022 03:43

https://liballeg.org/a5docs/trunk/

=== @EmilyV99 (discord: Emily) 11/18/2022 03:44

ah there
thanks

=== @EmilyV99 (discord: Emily) 11/18/2022 03:45

(replying to @connorjclark (discord: connorclark) "Only odd part is we need to d‚Ä¶"): embedding would be good
.....how much more work?

=== @EmilyV99 (discord: Emily) 11/18/2022 03:46

....getting it working at all first would probably be better though lol

=== @connorjclark (discord: connorclark) 11/18/2022 03:47

You could just inline the source text instead of using the "load from disk" shader functions.
it's just ugly
honestly idk how to have both external source file + embed, yet

=== @EmilyV99 (discord: Emily) 11/18/2022 03:47

better ugly than requiring an external file
because the former is ugly in the source, the latter is ugly to the users

=== @connorjclark (discord: connorclark) 11/18/2022 03:48

more than the dozen dlls?

=== @EmilyV99 (discord: Emily) 11/18/2022 03:49

....you know, fair.

=== @connorjclark (discord: connorclark) 11/18/2022 03:49

but it's the ultimate configuration lol
don't like the tint....
here you go
you code it
Anyway, I don't wanna get people excited, but we could easily expose some shader utilities to zscript. but would anyone even use it
Like, the most basic thing: just a pixel shader on the framebuffer
anything more would be harder

=== @EmilyV99 (discord: Emily) 11/18/2022 03:51

the problem would be being able to read anything back
such a shader would only affect the user, and not any of the colors of the A4 bitmap that zscript reads for stuff
....which I suppose isn't in itself a problem
but
ü§∑‚Äç‚ôÄÔ∏è not sure if anyone would use it
especially given there are already tint functions for tinting the whole A4 palette
and newly moosh's paldata stuff giving direct edit access to the A4 palette in full

=== @connorjclark (discord: connorclark) 11/18/2022 03:57

Btw, feel free to leave the shader thing to me, unless you actually wanna figure it out
I can just steal your maths

=== @EmilyV99 (discord: Emily) 11/18/2022 03:59

I learn by fucking with things

=== @connorjclark (discord: connorclark) 11/18/2022 03:59

It needs to be GLSL tho to be portable
fyi

=== @EmilyV99 (discord: Emily) 11/18/2022 03:59

so let's see if I can do anything
I'm copying the example best I can, so, creating glsl and hlsl

=== @ mitchfork 11/18/2022 04:00

You posted a test build earlier but it looks like there's a lot of dev activity happening since then
Should I wait for another build?

=== @connorjclark (discord: connorclark) 11/18/2022 04:00

@ mitchfork I'll send a new build soon

=== @ mitchfork 11/18/2022 04:00

üëç

=== @EmilyV99 (discord: Emily) 11/18/2022 04:00

The current dev I'm doing is just fancyness
nothing critical
but, some fullscreen and tabbing in/out stuff was fixed earlier

=== @connorjclark (discord: connorclark) 11/18/2022 04:01

Building now on GitHub

=== @ mitchfork 11/18/2022 04:02

cool.  I was never able to get fullscreen running (instant silent crash) so I'll see if that's changed for me then

=== @connorjclark (discord: connorclark) 11/18/2022 04:04

It apparently works on Windows, you just can't toggle at runtime

=== @EmilyV99 (discord: Emily) 11/18/2022 04:07

I mean, it also worked on 2.55-master when I tried it
so
ü§∑‚Äç‚ôÄÔ∏è
pretty sure it suddenly working for me has a lot more to do with my graphics card upgrade

=== @EmilyV99 (discord: Emily) 11/18/2022 04:14

@connorjclark (discord: connorclark) I got to `Failed to attach pixel shader file 'monochrome.hlsl'`

=== @connorjclark (discord: connorclark) 11/18/2022 04:14

Put it in the output folder

=== @EmilyV99 (discord: Emily) 11/18/2022 04:14

```cpp
void init_shader()
{
    if(shader_invalid || gray_shader) return;
    shader_invalid = true;
    gray_shader = al_create_shader(ALLEGRO_SHADER_AUTO);
    if(!gray_shader)
    {
        al_trace("Failed create shader!\n");
        return;
    }
    ALLEGRO_SHADER_PLATFORM platform = al_get_shader_platform(gray_shader);
    char* pshdr;
    if (platform == ALLEGRO_SHADER_HLSL)
        pshdr = "monochrome.hlsl";
    else if (platform == ALLEGRO_SHADER_GLSL)
        pshdr = "monochrome.glsl";
    else
    {
        al_trace("Failed shader platform calculation\n");
        return;
    }
    if(!al_attach_shader_source_file(gray_shader, ALLEGRO_PIXEL_SHADER, pshdr))
    {
        al_trace("Failed to attach pixel shader file '%s'\n", pshdr);
        return;
    }
    if(!al_build_shader(gray_shader))
    {
        al_trace("Failed to build pixel shader '%s'\n", pshdr);
        return;
    }
    
    shader_invalid = false;
}```

=== @connorjclark (discord: connorclark) 11/18/2022 04:14

Not next to source

=== @EmilyV99 (discord: Emily) 11/18/2022 04:15

It would go in the folder with the exes, right?
that's where it is

=== @connorjclark (discord: connorclark) 11/18/2022 04:15

Yeah. Hmm

=== @EmilyV99 (discord: Emily) 11/18/2022 04:15

so `al_attach_shader_source_file` is failing here
failing on this hlsl:```c
texture al_tex;
sampler2D s = sampler_state {
   texture = <al_tex>;
};
float3 tint;
float4 ps_main(VS_OUTPUT Input) : COLOR0
{
   float4 pixel = tex2D(s, Input.TexCoord.xy);
   float gray = (pixel.r*0.299) + (pixel.g*0.587) + (pixel.b*0.114);
   pixel.r = gray;
   pixel.g = gray;
   pixel.b = gray;
   return pixel;
}
```
ah, wait, I can apparently retrieve an error log?
let me handle that

=== @EmilyV99 (discord: Emily) 11/18/2022 04:18

`C:\Users\Emily\Documents\ZC\ZC255_64\memory(6,16): error X3000: unrecognized identifier 'VS_OUTPUT'`
...uhh

![image](https://cdn.discordapp.com/attachments/1041621976596348948/1043017456773513246/image.png?ex=65ea91b4&is=65d81cb4&hm=1c2391138c8a1f008b2423967d556bf32e48d6b1a220f826296d66e3c1045e10&)
that's directly in the example hlsl

=== @connorjclark (discord: connorclark) 11/18/2022 04:20

That is vertex shader variable
https://www.allegro.cc/forums/thread/616735/1028390#target

=== @EmilyV99 (discord: Emily) 11/18/2022 04:21

gotta love load times on links

=== @connorjclark (discord: connorclark) 11/18/2022 04:21

Can we stick to glsl?
So we don't need two shaders forever

=== @EmilyV99 (discord: Emily) 11/18/2022 04:21

ü§∑‚Äç‚ôÄÔ∏è It automatically picks which to use based on platform

![image](https://cdn.discordapp.com/attachments/1041621976596348948/1043018366039896084/image.png?ex=65ea928c&is=65d81d8c&hm=e8fdba896b9893acb64ad1035ee1675e03d67fbf544534098e04b10c088c855d&)
aha
It defines these in the vertex shader example file
and then uses them
in the pixel shader example file
without defining them again

=== @EmilyV99 (discord: Emily) 11/18/2022 04:24

`Successfully built pixel shader 'monochrome.hlsl'`
cool, it built right, but nothing looks different.

=== @connorjclark (discord: connorclark) 11/18/2022 04:24

@<role: Tester> @ mitchfork  https://github.com/connorjclark/ZeldaClassic/releases/tag/connorjclark-nightly-2022-11-18
you need to call al_use_shader just before rendering the game bitmap

=== @EmilyV99 (discord: Emily) 11/18/2022 04:25

at what stage does it need to use the shader

=== @connorjclark (discord: connorclark) 11/18/2022 04:25

So, you probably should add a shader property to the render tree item

=== @EmilyV99 (discord: Emily) 11/18/2022 04:25


![image](https://cdn.discordapp.com/attachments/1041621976596348948/1043019191919325234/image.png?ex=65ea9351&is=65d81e51&hm=c2e06e272afd743e53f8d2fceccb6005ebb99f31e9d12f4ccee35a28d1c797c6&)

=== @connorjclark (discord: connorclark) 11/18/2022 04:25

Just before call the al_draw scaled bitmap in base render

=== @EmilyV99 (discord: Emily) 11/18/2022 04:26

so, like this?
except that's not working

=== @connorjclark (discord: connorclark) 11/18/2022 04:26

Yeah I'd expect that to be needed
Not sure what else...

=== @EmilyV99 (discord: Emily) 11/18/2022 04:26

`use_gray_shader()` here just wraps some code
which inits the shader if not initialized yet
and if initialized succesfully, just calls the `al_use_shader(gray_shader)`
Does it not work for tinted draws or something?

=== @connorjclark (discord: connorclark) 11/18/2022 04:28

Add that flag in a5_display
Ugh
Look in example program display flags
For the programmable flag
Sorry, on mobile

=== @EmilyV99 (discord: Emily) 11/18/2022 04:29

`ALLEGRO_PROGRAMMABLE_PIPELINE`?

=== @connorjclark (discord: connorclark) 11/18/2022 04:29

Yea

=== @EmilyV99 (discord: Emily) 11/18/2022 04:30

a5_display is where exactly
or what is something in it I can ctrl+F for

=== @connorjclark (discord: connorclark) 11/18/2022 04:30

it's a file

=== @EmilyV99 (discord: Emily) 11/18/2022 04:30

yes where

=== @connorjclark (discord: connorclark) 11/18/2022 04:30

uhhhhh you gonna make me type it out lol I'm on mobile

=== @EmilyV99 (discord: Emily) 11/18/2022 04:31

if you can give me anything in that file
I can ctrl+f for it
and find the file

=== @connorjclark (discord: connorclark) 11/18/2022 04:31

allegory legacy / a5 /a5_display
Your editor should have a quick find based on file name no?

=== @EmilyV99 (discord: Emily) 11/18/2022 04:31

not that I'm aware of
ahk found it

=== @EmilyV99 (discord: Emily) 11/18/2022 04:33


![image](https://cdn.discordapp.com/attachments/1041621976596348948/1043021072846557244/image.png?ex=65ea9512&is=65d82012&hm=46436b26ebe76d36b128d593262d53489651a3ed79fdb1f6388ff2b7e2904f40&)
Like so? If so, did nothing

=== @ mitchfork 11/18/2022 04:38

-So going into/out of fullscreen works in large mode but not small mode, which is neat but I will never use fullscreen lol
-Fullscreen does seem to force linear scaling, even if you have nearest neighbor set
-ZC still doesn't work
-Otherwise nothing else seems broken

=== @EmilyV99 (discord: Emily) 11/18/2022 04:39

?? ZC doesn't work?
What the hell?
It's working fine for me
what is wrong with it

=== @ mitchfork 11/18/2022 04:40

http://puu.sh/JrULn/3a1b467ea7.png
Black screen, same as it was in the other recent rendering refactor builds

=== @EmilyV99 (discord: Emily) 11/18/2022 04:40

What happens if you press `Start`

=== @ mitchfork 11/18/2022 04:41

It also has to be exited from the task manager, the window X doesn't do anything
oh start brings up a box

=== @EmilyV99 (discord: Emily) 11/18/2022 04:41

what box

=== @arceusplayer11 (discord: Deedee) 11/18/2022 04:41

We're pretty sure the black screen is the title screen bugging out
just drawing the title as pure black

=== @EmilyV99 (discord: Emily) 11/18/2022 04:41

also to be frank why is skip title not a default config

=== @ mitchfork 11/18/2022 04:42

okay yeah lemme poke around and give a more detailed report then

=== @arceusplayer11 (discord: Deedee) 11/18/2022 04:42

I dunno, it kinda adds charm?

=== @EmilyV99 (discord: Emily) 11/18/2022 04:42

I have skip title and skip logo on, so neither of those would be appearing for me

=== @arceusplayer11 (discord: Deedee) 11/18/2022 04:42

AG Logo was trash

=== @ mitchfork 11/18/2022 04:42

It pops up the "No save file found" dialog

=== @EmilyV99 (discord: Emily) 11/18/2022 04:42

(replying to @ mitchfork "It pops up the "No save file‚Ä¶"): that would be correct if you've just downloaded a new build, there is no save file included
so that's working as expected
after that does it bring you to save select normally?

=== @ mitchfork 11/18/2022 04:43

yeah, and on re-opens once the save file has been created, ZC will go to the title screen normally

=== @EmilyV99 (discord: Emily) 11/18/2022 04:43

Oh?
The title screen works after that?
but not before?
that's fucking WEIRD

=== @connorjclark (discord: connorclark) 11/18/2022 04:45

Logo should work. So a dialog prompt was opened before the logo?
(but not visible)

=== @EmilyV99 (discord: Emily) 11/18/2022 04:45

The AG logo is off by default
watch terminology, as `title screen` != `logo`
The popup appeared *after pressing start* on the title screen, which is normal

=== @connorjclark (discord: connorclark) 11/18/2022 04:46

I know, both should work.

=== @ mitchfork 11/18/2022 04:46

Hmm. I've deleted my zc.sav file and can't recreate it.  But I encountered the "create save file" dialog failing to appear / black screen twice before you asked me to try `Start`

=== @connorjclark (discord: connorclark) 11/18/2022 04:46

logo and title were busted before
but I fixed that

=== @EmilyV99 (discord: Emily) 11/18/2022 04:46

Did you say yes or no to epilepsy protection?

=== @connorjclark (discord: connorclark) 11/18/2022 04:47

FWIW, I have enough information to debug it ("dialogs on startup")
I don't need anything else

=== @ mitchfork 11/18/2022 04:47

mmmm I saw no popup for epilepsy

=== @connorjclark (discord: connorclark) 11/18/2022 04:47

However, I'm logging off for the night soon.

=== @EmilyV99 (discord: Emily) 11/18/2022 04:47

(replying to @ mitchfork "mmmm I saw no popup for epile‚Ä¶"): oh?
in `zc.cfg` set `checked_epilepsy` to `0`
and see if the issue happens again

=== @connorjclark (discord: connorclark) 11/18/2022 04:47

(replying to @EmilyV99 (discord: Emily) "Like so? If so, did nothing"): not sure what to try next. maybe start by checking you can build and run the allegro example (their project is easy to checkout and build from github)

=== @ mitchfork 11/18/2022 04:49

(replying to @EmilyV99 (discord: Emily) "in `zc.cfg` set `checked_epil‚Ä¶"): yup that's exactly it.  The epilepsy check isn't appearing, but hitting `Start` must be accepting the dialog anyway.  Then everything proceeds normally and works

=== @EmilyV99 (discord: Emily) 11/18/2022 04:49

your start button is `Enter`, isn't it?
that would confirm a dialog

=== @ mitchfork 11/18/2022 04:49

yes, default bindings

=== @EmilyV99 (discord: Emily) 11/18/2022 04:49

yep. My start wouldn't do that
as my start is LShift
but yeah
@connorjclark (discord: connorclark)
![image](https://cdn.discordapp.com/attachments/1041621976596348948/1043025275899875369/image.png?ex=65ea98fc&is=65d823fc&hm=d703dd6e07d351d9923088195bb80101b5be8e33237b9230f2525ac61ec54670&)
Guessing this here is the issue

=== @ mitchfork 11/18/2022 04:51

http://puu.sh/JrUOo/15f780de47.png
Sometimes when I quit I get this, which is new

=== @ Majora 11/18/2022 04:52

Jesus christ
How much peyote did you eat

=== @connorjclark (discord: connorclark) 11/18/2022 04:52

good guess but nah, the screen bitmap is kinda inert now
just leave it to me for tah-morrow

=== @EmilyV99 (discord: Emily) 11/18/2022 04:53

well whatever it is is somewhere in that tiny block of code

=== @connorjclark (discord: connorclark) 11/18/2022 04:53

i dont think i can fix it in the next 5 minutes before my date shows up lol

=== @EmilyV99 (discord: Emily) 11/18/2022 04:55

yeah lol, have fun

=== @ mitchfork 11/18/2022 04:58

ZC
- Bug with epilepsy protection dialog as discussed in channel.
- Exiting the program usually results in destroying the palette, resulting in a second or two of garbled colors.  Never seen this before
- Setting the render mode to linear affects the game window, but not the ZC UI elements.
- All new ZLauncher checkboxes seem to work and I notice the integer scale values now accept 1.5x too.  Nice!
Just collecting everything I've noticed so far with testing
Fullscreen still doesn't work for me in ZC but w/e, driver/card shit

=== @EmilyV99 (discord: Emily) 11/18/2022 05:01

(replying to @ mitchfork "ZC
- Bug with epilepsy protec‚Ä¶"): As for the garbled colors, how are you exiting when it happens?

=== @ mitchfork 11/18/2022 05:03

huh you know what? Pressing the Windows X pops up the quit dialog and always garbles them.  If I F10 to the same dialog, it never garbles

=== @EmilyV99 (discord: Emily) 11/18/2022 05:04

Is it ALWAYS
or
is it when you have the pause open
i.e. when the screen is "blued out"
(It was literally *not able* to close via the X when pause was open until a change I just made in this build, so this would be directly caused by that if so)

=== @ mitchfork 11/18/2022 05:05

no, you're right

=== @EmilyV99 (discord: Emily) 11/18/2022 05:05

ahk, so that one is on me

=== @ mitchfork 11/18/2022 05:05

if it's unpaused and I trigger the dialog, it's normal.  if it's paused, it garbles

=== @EmilyV99 (discord: Emily) 11/18/2022 05:05

See, what used to happen
is if paused and you clicked the X
*nothing would happen*
and the dialog would pop up *when you unpaused*
so, clearly something is wrong with how I fixed that
good catch, thanks

=== @ mitchfork 11/18/2022 05:06

Yup, I've noticed that before but didn't even think to report it as a bug.  Figured it was just one of those ZC things

=== @EmilyV99 (discord: Emily) 11/18/2022 05:07

HAH

![image](https://cdn.discordapp.com/attachments/1041621976596348948/1043029671073296514/image.png?ex=65ea9d14&is=65d82814&hm=591094b077523e8a1e038106f9c041066bf570eecf5b6ee95772304264a1c772&)
My shader works properly for grayscaling
in the allegro example file
....it just isn't applying at all in zc

=== @EmilyV99 (discord: Emily) 11/18/2022 05:10

By gods I have too many windows open
![image](https://cdn.discordapp.com/attachments/1041621976596348948/1043030377830301766/image.png?ex=65ea9dbc&is=65d828bc&hm=815f4f922c46fac878f3cb7bb85c3527a2a51b4dcc86e0997a411d9ca94f680d&)

=== @connorjclark (discord: connorclark) 11/18/2022 05:20

I meant to make linear not apply to UI elements, I'm not sure it'd ever look very good...but I can change that if you think it'd look better

=== @EmilyV99 (discord: Emily) 11/18/2022 05:21

(replying to @connorjclark (discord: connorclark) "I meant to make linear not ap‚Ä¶"): I thought the point was that the UI elements drew distorted without it?

=== @EmilyV99 (discord: Emily) 11/18/2022 05:34


![image](https://cdn.discordapp.com/attachments/1041621976596348948/1043036564722302996/image.png?ex=65eaa37f&is=65d82e7f&hm=08bbe384c161acf7f9143f4109d49b17414eb1abe9f05e03441a66665f5fcd84&)
I am so frustrated
because everything works in this example file
but nothing at all works in zc

=== @EmilyV99 (discord: Emily) 11/18/2022 05:46


![image](https://cdn.discordapp.com/attachments/1041621976596348948/1043039361496776724/image.png?ex=65eaa61a&is=65d8311a&hm=af9ad46917560ba4ae47cec438992ae46754c2f530f85e3147ec3677c59e36a3&)
ahhhk
`al_use_shader` is returning false
so it's failing to *USE* the shader on the target

![image](https://cdn.discordapp.com/attachments/1041621976596348948/1043039524604874812/image.png?ex=65eaa641&is=65d83141&hm=1646082e674aedaa951d538da7a6bf1ac451667ab5c2632a7781d3a214829fdc&)
what the fuck makes it incompatible with the target bitmap

=== @EmilyV99 (discord: Emily) 11/18/2022 05:57

AHK
well
in debug
`shader   E             shader.c:193  al_use_shader                    [  12.40713] use_shader failed`

![image](https://cdn.discordapp.com/attachments/1041621976596348948/1043042373996908614/image.png?ex=65eaa8e8&is=65d833e8&hm=09f19ea8b46ec3fc8ff9b91a5970a583905195930b37854624af1a28f017e0ce&)
so `shader->vt->use_shader(shader, disp, true)` is not working

=== @connorjclark (discord: connorclark) 11/18/2022 05:58

You call al_set_target_bitmap?

=== @EmilyV99 (discord: Emily) 11/18/2022 06:05

no
and yes
tried both
but that output is with no

=== @connorjclark (discord: connorclark) 11/18/2022 06:06

Oh example doesn't even use that I think . Weird

=== @EmilyV99 (discord: Emily) 11/18/2022 06:06


![image](https://cdn.discordapp.com/attachments/1041621976596348948/1043044599318454282/image.png?ex=65eaaafb&is=65d835fb&hm=0f4cb93e974fb7485f3a3ce0156c4ab6f87d2e6c4d6e0aabaf5fe36ef5762ec9&)
If no target bitmap is set, or the target bitmap is a memory bitmap, it would give a different error there

=== @EmilyV99 (discord: Emily) 11/18/2022 06:08

*huh*
though when I set the target bitmap to `rti->bitmap`
it *succeeds*
`shader   D             shader.c:188  al_use_shader                    [   9.52191] use_shader succeeded`
but
*still nothing draws????*

=== @EmilyV99 (discord: Emily) 11/18/2022 06:26

@connorjclark (discord: connorclark) pushed to your fork as branch `render-shader-stuff`
confused
and not going to get any farther without your help, so, just pushing so you can take a look when you have time

=== @EmilyV99 (discord: Emily) 11/18/2022 06:36

oh
and should probably give these

https://cdn.discordapp.com/attachments/1041621976596348948/1043052054907719731/monochrome.hlsl?ex=65eab1ec&is=65d83cec&hm=804eecf1165cc4906a71a5d2ca4841956479ed33c8984c5c5e2ff4d91daa6354&
https://cdn.discordapp.com/attachments/1041621976596348948/1043052055197143050/monochrome_vert.glsl?ex=65eab1ec&is=65d83cec&hm=badc1f0545c09bee12bab847007aa2539f3cd6b8007860b6090238bcdecaff1a&
https://cdn.discordapp.com/attachments/1041621976596348948/1043052055440396348/monochrome_vert.hlsl?ex=65eab1ec&is=65d83cec&hm=b6523eb461b1de7f7f251dfd3659683c893d4057a7596ea7e7cf8d747e96ea40&
https://cdn.discordapp.com/attachments/1041621976596348948/1043052055700459600/monochrome.glsl?ex=65eab1ed&is=65d83ced&hm=0539e4de520109f44858e40de563d06a7b3bbc6f6aa40fcb76c30b2e852ecf2f&
Currently, these should turn everything SOLID RED.
because I just have it setting the output pixel to `1,0,0`
so it should be BLATANTLY obvious when it works

![image](https://cdn.discordapp.com/attachments/1041621976596348948/1043052324450476062/image.png?ex=65eab22d&is=65d83d2d&hm=a3d1feb2fd09f5e7613bd3f788227f672d5f12f334e7d3d502210fd13d3ccd1b&)
just removing the `1;` and `0;` should make it grayscale

=== @ mitchfork 11/18/2022 16:25

Just curious - would this refactor make it more possible to show the bottom 8 pixels of the screen?

=== @connorjclark (discord: connorclark) 11/18/2022 17:37

Not really

=== @ mitchfork 11/18/2022 17:37

ah well. nevertheless

=== @connorjclark (discord: connorclark) 11/23/2022 08:39

@EmilyV99 (discord: Emily)  should I keep this change in my branch you added `84022876de215fd28d355e8ad371c501928a6ead Fix quitting ZC not popping up quit dlg while paused` ? i think i recall james finding a bug w/ it maybe?

=== @connorjclark (discord: connorclark) 11/23/2022 08:57

Found the cause of the windowed->fullscreen crash. d3 fails to create a fullscreen display if it doesnt support the exact width/height requested.
I'll fix it tomorrow.

=== @EmilyV99 (discord: Emily) 11/23/2022 12:58

(replying to @connorjclark (discord: connorclark) "@EmilyV99 (discord: Emily)  should‚Ä¶"): Oh?
Is that the cause of that bug?

=== @connorjclark (discord: connorclark) 11/23/2022 18:32

No, unrelated

=== @connorjclark (discord: connorclark) 11/23/2022 20:10

I don't understand this code and I think it's unrelated to these changes, so I'm going to remove. Here:

```
commit 84022876de215fd28d355e8ad371c501928a6ead
Author: EmilyV99 <emilygamergirl99@gmail.com>
Date:   Thu Nov 17 21:37:11 2022 -0500

    Fix quitting ZC not popping up quit dlg while paused

diff --git a/src/zc/zc_sys.cpp b/src/zc/zc_sys.cpp
index 3b641dde5..ff358584c 100644
--- a/src/zc/zc_sys.cpp
+++ b/src/zc/zc_sys.cpp
@@ -4244,10 +4244,15 @@ void f_Quit(int32_t type)
 {
     if(type==qQUIT && !Playing)
         return;
-        
-    music_pause();
-    pause_all_sfx();
-    system_pal();
+    
+    bool from_menu = is_sys_pal;
+    
+    if(!from_menu)
+    {
+        music_pause();
+        pause_all_sfx();
+    }
+    enter_sys_pal();
     clear_keybuf();
     
     locking_keys = true;
@@ -4276,14 +4281,17 @@ void f_Quit(int32_t type)
     {
         kill_sfx();
         music_stop();
-        game_pal();
+        exit_sys_pal();
         update_hw_screen();
     }
     else
     {
-        game_pal();
-        music_resume();
-        resume_all_sfx();
+        exit_sys_pal();
+        if(!from_menu)
+        {
+            music_resume();
+            resume_all_sfx();
+        }
     }
     
     show_mouse(NULL);
@@ -8707,6 +8715,12 @@ void System()
         
     do
     {
+        if(close_button_quit)
+        {
+            close_button_quit=false;
+            f_Quit(qEXIT);
+            if(Quit) break;
+        }
         rest(17);
         
         if(mouse_down && !gui_mouse_b())
```
Also, will defer the shader stuff to a followup commit.

=== @ tim 11/23/2022 20:11

huh
is this for the quit sanity check not showing

=== @connorjclark (discord: connorclark) 11/23/2022 20:11

I don't know, I think Emily added it to my branch as a fix for something that exists in master
Zero knowledge of this, so I don't want it in my branch rn
~~and I _think_ someone pointed out an issue with it above somewhere~~

=== @EmilyV99 (discord: Emily) 11/23/2022 20:15

That allows you to close the game while paused
it should in no way affect pressing F6

=== @connorjclark (discord: connorclark) 11/23/2022 20:16

cherry pick it into main please. I'm not talking about F6, just trying to clean up / understand all my changes.
and this looks not related
gonna do some more test builds on this branch so it'll be a minute before that can land in master if it waits here

=== @connorjclark (discord: connorclark) 11/24/2022 04:39

will have a test build soon, building now

=== @connorjclark (discord: connorclark) 11/24/2022 05:05

https://github.com/connorjclark/ZeldaClassic/releases/tag/connorjclark-nightly-2022-11-24 @<role: Tester> 
known and fixed: color picker in init data cheats broken

=== @connorjclark (discord: connorclark) 11/24/2022 08:14

FYI @arceusplayer11 (discord: Deedee) some changes to windows dpi code here.  https://github.com/connorjclark/ZeldaClassic/commit/17ff9d129e193cc307f78ca349a91f092385560e

=== @connorjclark (discord: connorclark) 11/24/2022 08:28

https://github.com/liballeg/allegro5/blob/master/src/win/wsystem.c#L142 this is where allegro 5 sets the dpi awareness. So it was always being enabled, no matter what is in the cmake. I changed the cmake to PerMonitor instead of OFF, since I've read docs that say doing it via the application manifest (which cmake creates for us) is better than at runtime.

=== @connorjclark (discord: connorclark) 11/24/2022 08:59

https://github.com/connorjclark/ZeldaClassic/releases/tag/connorjclark-nightly-2022-11-24-2 should hopefully work the same, seems to for me

=== @connorjclark (discord: connorclark) 11/25/2022 22:17

@<role: Tester> @ mitchfork any testers around today?

=== @connorjclark (discord: connorclark) 11/25/2022 23:46

scaling all the ui elements now: https://github.com/connorjclark/ZeldaClassic/releases/tag/connorjclark-nightly-2022-11-26

=== @connorjclark (discord: connorclark) 11/26/2022 01:09

I think at this point it's good to merge, this commit is getting pretty big and needs a cutoff point soon.

=== @ mitchfork 11/26/2022 02:11

I'll be able to take a look tomorrow

=== @arceusplayer11 (discord: Deedee) 11/26/2022 03:43

no objections
I should take another look though

=== @ mitchfork 11/26/2022 17:04

No bugs in ZQ as far as I can tell.  All ZLauncher settings are working

=== @ mitchfork 11/26/2022 17:07

It looks like when I check "Force Integer Values for Scale" the UI in ZC doesn't scale at all.  Which I kind of like, I'm just wondering if it's intended to be tied to that setting?

=== @arceusplayer11 (discord: Deedee) 11/26/2022 17:09

booted up zquest, my mouse is invisible

=== @EmilyV99 (discord: Emily) 11/26/2022 17:10

(replying to @ mitchfork "It looks like when I check "F‚Ä¶"): It would scale, if your monitor were big enough for a bigger scale.
That option stops it from scaling except in even multiples
so it won't go above 1x scale until you hit 2x scale

=== @ mitchfork 11/26/2022 17:10

(replying to @EmilyV99 (discord: Emily) "It would scale, if your monit‚Ä¶"): I don't think this is it, the screen is scaling normally, the UI is not scaling

=== @EmilyV99 (discord: Emily) 11/26/2022 17:10

oh, it is?
nevermind then

=== @ mitchfork 11/26/2022 17:11

(replying to @arceusplayer11 (discord: Deedee) "booted up zquest, my mouse is‚Ä¶"): I am noticing more "mouse invisible" moments in ZC (not ZQ)
but it doesn't seem consistent to reproduce.  It's just happening a lot when clicking the screen to bring up the UI

=== @arceusplayer11 (discord: Deedee) 11/26/2022 17:12

okay, mouse reappears when I close and reopen

=== @ mitchfork 11/26/2022 17:14

(replying to @ mitchfork "It looks like when I check "F‚Ä¶"): More info - if you use the Video Mode settings to change to 2x, the UI scales to 2x, but dragging the window manually does not recalculate the UI scaling even if you hit 2x

=== @EmilyV99 (discord: Emily) 11/26/2022 17:14

oh? interesting

=== @ mitchfork 11/26/2022 17:15

http://puu.sh/JsAed/b3627f738c.png
also palette garble is still present, but I think the cause was worked out before
it just didn't make it into this version

=== @ mitchfork 11/26/2022 17:20

Okay, it seems like I can *consistently* get the mouse to disappear the following ways: 
- by using the Windows X to try to exit the application.  This brings up the same dialog as F10 but  always makes the mouse turn invisible for me
- If hitting F9/F10 while the mouse cursor is outside the window, it will sometimes turn invisible as well

=== @ mitchfork 11/26/2022 17:22

so seems like it's related to the cursor being outside the window border, at least

=== @arceusplayer11 (discord: Deedee) 11/26/2022 17:30

seems to work fine from a very basic test
(this refactor, that is)
sadly fonts don't scale downwards very well; you can still read it but it's much less comfy to read; I don't think window resizing is the thing to kill small mode dead because of that

=== @ mitchfork 11/26/2022 17:33

yeah but running anything under the default 1x resolution isn't something people are really going to do I think

=== @arceusplayer11 (discord: Deedee) 11/26/2022 17:33

yeah; the problem is that large mode is supposed to be the ideal way to use ZQuest
but for some people it isn't
...maybe at some point I should do a Small Mode Plus that's just a customizeable small mode with optional large mode features

=== @EmilyV99 (discord: Emily) 11/26/2022 17:35

god please no
the answer is rewriting everything new not jankifying things further

=== @connorjclark (discord: connorclark) 11/26/2022 18:12

Just checking, people are using the latest build on my fork right?
(replying to @connorjclark (discord: connorclark) "scaling all the ui elements n‚Ä¶"): this

=== @ mitchfork 11/26/2022 18:13

That's what I'm using, yes

=== @arceusplayer11 (discord: Deedee) 11/26/2022 18:18

yeah

=== @connorjclark (discord: connorclark) 11/26/2022 23:39

(replying to @ mitchfork "I don't think this is it, the‚Ä¶"): the game bitmap and the ui bitmaps are different sizes, hence they scale at different breakpoints
They should all scale at only integer values if that option is enabled
For ZC.
For ZQ, it is simpler; everything is still on the same bitmap and scales together.

=== @ mitchfork 11/26/2022 23:41

(replying to @connorjclark (discord: connorclark) "the game bitmap and the ui bi‚Ä¶"): I was observing that dragging to resize wasn't properly setting the UI scale to 2x
But launching at 2x or using the video mode settings was

=== @connorjclark (discord: connorclark) 11/26/2022 23:47

I'm not seeing anything like that

=== @ mitchfork 11/26/2022 23:48

I can retest later but I'm almost certain that was happening for me
Win64

=== @connorjclark (discord: connorclark) 11/26/2022 23:50

is your actual monitor res at least 1280x960
the dragging code and the video mode thing don't directly set the scaling, something else entirely does, so I don't see how they can behave differently
I may need a video to see what ya mean

=== @connorjclark (discord: connorclark) 11/26/2022 23:51

what gfx driver do you have selected in launcher?

=== @ mitchfork 11/26/2022 23:53

It would be whatever the default is, not at the computer but can record if I reproduce it

=== @ mitchfork 11/26/2022 23:54

(replying to @connorjclark (discord: connorclark) "is your actual monitor res at‚Ä¶"): Also yes 1080, I can cleanly go to 2x in ZC

=== @connorjclark (discord: connorclark) 11/27/2022 01:28

Is anyone else able to reproduce what mitchfork is talking about here?
(replying to @ mitchfork "Okay, it seems like I can *co‚Ä¶"): or here? (i cannot)

=== @ mitchfork 11/27/2022 02:10

ah
okay

=== @ mitchfork 11/27/2022 02:13

There is something going on but it's way more minor than what I thought and reported
![image](https://cdn.discordapp.com/attachments/1041621976596348948/1046247437800579152/daughters_133.mp4?ex=65ed175b&is=65daa25b&hm=3a36b2087201a4714b040240bd88a22494ef76b0dc822614488f9c76a15e374f&)

=== @ mitchfork 11/27/2022 02:14

It's just that the UI needs it to be greater than or equal to 1280x960 (true 2x) but the game display will cut the black bars at to display 2x at resolutions slightly under that
this results in a small range of window sizes where the game display is 2x but the UI is 1x.  Honestly no big deal, just reporting it if that indicates something else unwanted is going on

=== @ mitchfork 11/27/2022 02:17

that's why manual resizing was causing it.  I was just hitting that range when I was messing with it

=== @ mitchfork 11/27/2022 02:21

those mouse issues are still pretty consistent though

=== @connorjclark (discord: connorclark) 11/27/2022 06:31

So it's just the mouse thing (which I still can reproduce)? And just Zc? Does it at least come back for you
I'll probably merge this tonight because I anticipate it being much more stable

=== @ mitchfork 11/27/2022 06:37

The mouse reappears if I unpause/pause again (as long as I didn't do one of the listed things above to make it disappear again)
So it's not permanent, no
ZQ has had mouse disappear issues but that's not new to this refactor, those have happened across multiple alphas. Didn't notice anything worse about this build but also didn't use ZQ extensively in it of course
In ZQ, it's usually less of a hassle because right-clicking tends to force it to reappear. Not in ZC though

=== @connorjclark (discord: connorclark) 11/27/2022 06:40

Can you vet zq please
Mouse issues should be much improved since this is hardware cursors now
I'm surprised you are having issues

=== @ mitchfork 11/27/2022 06:42

I can take a look tomorrow and try some things that tend to cause it
Are you able to test on Windows now?

=== @connorjclark (discord: connorclark) 11/27/2022 06:43

Yes

=== @ mitchfork 11/27/2022 06:43

Hmm, weird
Well, I'll see if I find anything anyway

=== @connorjclark (discord: connorclark) 11/27/2022 06:52

@arceusplayer11 (discord: Deedee) you have any mouse problems?

=== @arceusplayer11 (discord: Deedee) 11/27/2022 07:30

when I first tried it the mouse didn't show up at all
but afterwards, no, mouse seems fine

=== @ mitchfork 11/27/2022 15:31

poked around ZQ a bit and didn't get any cursor issues, trying some of the same types of things that got it in ZC
So pretty confident that's not any worse

=== @ mitchfork 11/27/2022 15:33

I also enabled the secret `hw_cursor = 1` option in zc.cfg and saw no difference in the disappearing behavior

=== @connorjclark (discord: connorclark) 11/27/2022 19:44

was thinking of removing that

=== @ mitchfork 11/27/2022 20:38

No opinion on it, I don't use it personally and don't know anyone who does

=== @ tim 11/27/2022 20:40

probably not something really needed in something that doesnt use much load
it works for games like WoW which utilize your CPU a lot
and mainly for older versions where multi threading didnt exist and you overloaded the first core

=== @connorjclark (discord: connorclark) 11/27/2022 21:17

i had only added it as a stopgap for other cursor issues
and it was not really hw cursor, it was....dont mess with the OS cursor at all (always use the pointer thingy)
as opposed to now, it is always hw cursor apis
i'll just kill it

=== @ tim 11/27/2022 21:19

aha

=== @connorjclark (discord: connorclark) 11/29/2022 06:05

getting ready to merge this to master

=== @connorjclark (discord: connorclark) 11/29/2022 09:04

any minute now

=== @connorjclark (discord: connorclark) 11/29/2022 09:12

Merged. Any related bugs please report in the bug channel.

=== @connorjclark (discord: connorclark) 11/29/2022 09:40

thanks for all the testing y'all

=== @EmilyV99 (discord: Emily) 11/29/2022 10:27

@connorjclark (discord: connorclark) If I show FPS, tab out, and tab back in, the FPS vanishes, and can't be fixed except by relaunching
oh wait
it isn't tab out/tab in
it's pause
just pausing and triggering the tint once wipes out the fps display permanently
before:
![image](https://cdn.discordapp.com/attachments/1041621976596348948/1047096806464569354/image.png?ex=65e6f3e4&is=65d47ee4&hm=000b443e1cc1c2f453ac6ed9d11a5bb5a433169a22f41f2abfa77fd2441471db&)
after:
![image](https://cdn.discordapp.com/attachments/1041621976596348948/1047096894716903434/image.png?ex=65e6f3f9&is=65d47ef9&hm=5c1a40c1bee28673a4c51836c6e81479a5ec0434c0c46261603962e54632079b&)
The background transparent black behind the text doesn't vanish
that continues to update to the correct width of the text, too
just the text itself stops displaying
(on the other hand, in that room I got under half that FPS previously!)

=== @connorjclark (discord: connorclark) 11/29/2022 10:31

I've seen this before, but only for toggling Fullscreen (which I handle) and switching windows scaling (which I did not handle because whatever...)

randomly allegro font just....disappears lol
Since it's happening more regularly for you somehow I'll prioritize looking into it more

=== @EmilyV99 (discord: Emily) 11/29/2022 10:32

I just went to check FPS to see how much better this build was, and blam, it just vanished, repeatedly and reproducably

=== @connorjclark (discord: connorclark) 11/29/2022 10:32

No one in allegro discord had any idea but told me fonts are haunted

=== @EmilyV99 (discord: Emily) 11/29/2022 10:32

fun
oof

=== @connorjclark (discord: connorclark) 11/29/2022 10:33

Doesn't happen on Mac either

=== @EmilyV99 (discord: Emily) 11/29/2022 10:33

Windows is haunted
so

=== @EmilyV99 (discord: Emily) 11/29/2022 10:37

also, the FPS font size is like, a bit big?

=== @EmilyV99 (discord: Emily) 11/29/2022 10:55

ah
also

![image](https://cdn.discordapp.com/attachments/1041621976596348948/1047103528189055016/image.png?ex=65e6fa27&is=65d48527&hm=917fe23830eee5e8ac7e30431951cb2460be5bf6e0548ce3acdd1430ab806d20&)
I clicked the window X in the top right, while the game was not paused
there is no mouse cursor anymore

=== @ mitchfork 11/29/2022 13:51

Yup
That's what I was getting

=== @connorjclark (discord: connorclark) 11/30/2022 03:09

https://github.com/liballeg/allegro5/issues/1388

=== @EmilyV99 (discord: Emily) 11/30/2022 03:10

nice catch

=== @ mitchfork 11/30/2022 03:21

nice

=== @connorjclark (discord: connorclark) 11/30/2022 03:22

Fixed in next nightly. Disregard the very minor weirdness on the border when entering. eventually allegro people fix for real, hopefully.

=== @ NightmareJames 12/01/2022 07:45

Frames not displaying in replays V7 and up (11-30-2022 Nightly and above)
