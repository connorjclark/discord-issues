## ‚ùåLayered Lock Blocks Don't Work by Default (#2505)
@connorjclark (discord: connorclark) opened this issue on 07/08/2023
Status: unknown
Tags: 
Source: #dev-discussion https://discord.com/channels/876899628556091432/1127118998304198737


=== @connorjclark (discord: connorclark) 07/08/2023 06:39

So I've been looking into GetOggPos(), SetOggPos(), and SetOggSpeed(). Previously these were broken and only were only supposed to work with OGG. Allegro 5 seems to have a bunch of functions that accomplish the same thing with relatively little effort but specifically for MP3. Docs also indicate they should work with OGG, but it appears we're missing some kind of codec file for it. Any idea what's up with that and how one would go about obtaining these updated codecs?
https://liballeg.org/a5docs/trunk/acodec.html
We use an older allegro4-made lib for ogg. We should switch to the allegro 5 integration.  We already install the acodec plugin, and by default Vorbis (OGG) is included in the build if the library is present on the system (https://github.com/liballeg/allegro5/blob/master/addons/acodec/CMakeLists.txt#L7 )
MP3 is already using the allegro5 stream system.
There is `al_seek_audio_stream_secs` which support seeking to a timestamp.
So, this amounts to installing Vorbis; dropping old Ogg library and switching to streams; then adding a interface to zcmusic for seeking.
(and loops)
`al_set_audio_stream_loop_secs`

=== @ Moosh 07/08/2023 06:40

Seems I jk'd too soon.
I had seeking working but when I tried adding the other existing functions I forgot a / 10000 and created a broken mess

=== @ Moosh 07/08/2023 06:43

(meta) thread name was changed: So I ve been looking into GetOggPos

=== @ Moosh 07/08/2023 06:46

Seems `al_set_audio_stream_speed` only works for values <=1. Unfortunate but better to have some functionality than none
Deedee's method when it was briefly working was able to speed up playback as well as slow down

=== @connorjclark (discord: connorclark) 07/08/2023 06:48

Do you have local changes using that?

=== @ Moosh 07/08/2023 06:49

yeah
haven't pushed anything yet

=== @connorjclark (discord: connorclark) 07/08/2023 06:49

If you look at `al_set_audio_stream_speed` nothing there is capping it to 1...

=== @ Moosh 07/08/2023 06:49

odd
maybe I did a math oopsie somewhere

=== @connorjclark (discord: connorclark) 07/08/2023 06:50

just set a constant value to see for now

=== @connorjclark (discord: connorclark) 07/08/2023 06:51

I apparently happen to already have libvorbis on my machine.
Did you too?
(like, using allegro5 ogg just worked?)

=== @ Moosh 07/08/2023 06:52

(replying to @ Moosh "maybe I did a math oopsie som‚Ä¶"): oh yup already I'm seeing the issue here
there was a vbound I missed

=== @arceusplayer11 (discord: Deedee) 07/08/2023 06:53

```So I've been looking into GetOggPos(), SetOggPos(), and SetOggSpeed(). Previously these were broken and only were only supposed to work with OGG``` to shed some context on this; originally I envisioned it as "SetEnhancedMusicEx" because this was way back when A: I didn't know shit about C++ (this was like a year before my first "real" contribution (Bridge combos)), and B: Zoria was in charge

=== @ Moosh 07/08/2023 06:54

Yeah I think we're just gonna deprecate PlayOgg because these other functions can work without it. Assuming updating regular ogg playback to allegro 5 works

=== @arceusplayer11 (discord: Deedee) 07/08/2023 06:55

so the idea was to just have it call a different way of... loading music? can't remember the exact details; anyways a different way of playing music that *was* compatible with stuff like getting and setting pos because of paranoia that just switching to that different way would break stuff
I couldn't figure out mp3's cause I was dumb and new so Zoria just said "name it PlayOgg instead"

=== @connorjclark (discord: connorclark) 07/08/2023 06:56

They should just expose the variousmethods in zcmusic.h - one set of ops for "music" not anything specific to a format

=== @ Moosh 07/08/2023 06:56

I mean given how things ended up with alogg, I don't think that paranoia was unfounded üòõ

=== @arceusplayer11 (discord: Deedee) 07/08/2023 06:57

lmao imagine using old-ass headers that can't even keep their documentation online

=== @connorjclark (discord: connorclark) 07/08/2023 06:57

Ideally MIDI should be included in this too.
(which gets awk cuz that does not live in zcmusic but w.e)

=== @arceusplayer11 (discord: Deedee) 07/08/2023 06:58

getting and setting midi position would be cool, although I don't know how that'd work cause IIRC midi uses a different way of handling position?

=== @connorjclark (discord: connorclark) 07/08/2023 06:58

Yes it uses discrete positions whereas others use time values
but you can convert a time value to a position
so the methods for "seek to this music time" should work for midi too

=== @ Moosh 07/08/2023 06:59

Should probably use a different set of functions if anything. MIDI/Enhanced music are already segregated everywhere else

=== @connorjclark (discord: connorclark) 07/08/2023 06:59

we still need to keep the one that does "seek to this midi posistion"

=== @ Moosh 07/08/2023 06:59

Unless...hmm...I suppose that could work

=== @arceusplayer11 (discord: Deedee) 07/08/2023 06:59

the really big thing I'd love to see from better music handling is being able to have multiple music "tracks" playing simultaneously, so that stuff like layered music could be accomplished by lowering the volume of one track and increasing the volume of another
and if it's a feasible goal I'd love to help towards it

=== @connorjclark (discord: connorclark) 07/08/2023 07:00

Deedee - that'd Mixer stuff in allegro 5 audio docs

=== @arceusplayer11 (discord: Deedee) 07/08/2023 07:00

but I have no clue if that's relevant right now; getting/setting position is the bigger priority I think
ooh?

=== @connorjclark (discord: connorclark) 07/08/2023 07:02

We should keep that in mind, and design these music apis with a "channel" paramater (and maybe make "-1" apply to all channels)

=== @connorjclark (discord: connorclark) 07/08/2023 07:06

Moosh, want to start with just dropping the a4 alogg and using a5? If you get it into a branch I can test on mac and linux
no rush tho
lets do a115 this weekend first

=== @ Moosh 07/08/2023 07:07

Make sense
Should I hold off on pushing the updated functions that work with MP3? Or no harm?
They don't change anything with music playback, just call those allegro functions

=== @connorjclark (discord: connorclark) 07/08/2023 07:08

so.... 

`Game->SeekMusic(int channel, int pos)`

or 

```
Game->SetCurrentMusicChannel(int channel);
Game->SeekMusic(int pos);
```

?
(replying to @ Moosh "Should I hold off on pushing‚Ä¶"): which ones?
oh for the zasm commands?

=== @connorjclark (discord: connorclark) 07/08/2023 07:10

like zcmusic_set_curpos and speed

=== @ Moosh 07/08/2023 07:10

```
int GetOggPos();
 * Returns the current seek position of an OGG started with PlayOgg, in ms.

void SetOggPos(int new_pos);
 * Sets the play position for an OGG started with PlayOgg(), in ms.
 
void SetOggSpeed(int newspeed);
 * Sets the playback speed of an OGG started with PlayOgg();
 ```
these three functions. (No objections to changing "Ogg" to "Music" here?)

=== @connorjclark (discord: connorclark) 07/08/2023 07:11

Yeah lets just rename those
luckily the zasm command name does not have Ogg in it

=== @connorjclark (discord: connorclark) 07/08/2023 07:13

but best to split it up i think, can you start with getting rid of old alogg then move on to the other stuff next?

=== @connorjclark (discord: connorclark) 07/08/2023 07:25

A super lazy thing we could do is a single ZASM command: `ALLEGRO_MUSIC`

and a bunch of functions in stdlib like

```
namespace Music {

int CreateMixer(freq, depth, channel_conf) {
  return Game->AllegroMusic(AL_CREATE_MIXER, freq, depth, channel_conf);
}

...
```
benefits are - we as non-audio experts do not need to design a good API (which will never happen on a first attempt)
and we have building blocks for literally anything
and this is dead simple to implement

=== @connorjclark (discord: connorclark) 07/08/2023 07:27

(the `ALEGRO_MUSIC` zasm command is then just a big switch that defers to `al_*` stuff ...)

not super sure how good of an idea this is yet, maybe it's too late and I'm having awful ideas

=== @ Moosh 07/08/2023 07:28

Unfortunately I'm not knowledgeable enough to say "noooo, that's a terrible idea"

=== @ Moosh 07/08/2023 07:36

ruh-roh. How do I debug a crash that goes away when I attach a debugger to the process? D:

=== @connorjclark (discord: connorclark) 07/08/2023 07:36

So you only see it in Release mode?
Can try RelWithDebInfo
or Asan, if it is a memory issue.
(crashes typically are)

=== @ Moosh 07/08/2023 07:37

never mind, I just run it again and have it actually crash this time

=== @ Moosh 07/08/2023 07:39

hmm...this seems to be maybe not something I did
crashes at the al_seek when I scroll onto a screen that plays a new MP3
![image](https://cdn.discordapp.com/attachments/1127118998304198737/1127141970444292166/image.png?ex=65ec1243&is=65d99d43&hm=86f639cb36ce7cdb30c7e538a577594b004a8ce50ccb5c034d492d69e2c2aad8&)

=== @connorjclark (discord: connorclark) 07/08/2023 07:41

use asan
really,. its magic
and saves time
it should basically be your default build type in development

=== @ Moosh 07/08/2023 07:43

alrighty, giving it a go

=== @arceusplayer11 (discord: Deedee) 07/08/2023 07:45

(replying to @connorjclark (discord: connorclark) "(the `ALEGRO_MUSIC` zasm comm‚Ä¶"): I'm clueless when it comes to ZASM! üòÑ
that's my super helpful take

=== @arceusplayer11 (discord: Deedee) 07/08/2023 07:46

(replying to @connorjclark (discord: connorclark) "(the `ALEGRO_MUSIC` zasm comm‚Ä¶"): so like... the arguments passed to it affect the switch state/what it actually does?

=== @ Moosh 07/08/2023 07:46

well that's unfortunate
![image](https://cdn.discordapp.com/attachments/1127118998304198737/1127143769989468242/image.png?ex=65ec13f0&is=65d99ef0&hm=478da30f45b2ae4ad4d7834a40f24366ca63a18ac2c1b6508571197dc84a01f9&)

=== @arceusplayer11 (discord: Deedee) 07/08/2023 07:47

pros being less backend work for us having to add a bunch of ZASM, cons being being unintuitive for actual ZASM users?

=== @connorjclark (discord: connorclark) 07/08/2023 07:47

it is just a quick interface to the al_ apis
can build anything out of that

=== @arceusplayer11 (discord: Deedee) 07/08/2023 07:47

I see

=== @connorjclark (discord: connorclark) 07/08/2023 07:48

not sure how it should interface with zcmusic - like if zcmusic_stop is called does that apply to mixers/streams started from zasm? probably - but i could see opting out?
idk
lets just worry about set position for now üôÇ
mixers are cool but too much

=== @ Moosh 07/08/2023 07:50

So where do I get these DLLs

=== @connorjclark (discord: connorclark) 07/08/2023 07:51

oh sorry, I missed.
You need to be running _in Visual Studio_
Either right click, Debug the target
Or just hit the Debug button up top to run the currently selected Startup target
You can right click the target and in properties set command line args, if needed.

=== @EmilyV99 (discord: Emily) 07/08/2023 07:53

any new audio commands should be on `Audio->` for the record

=== @ Moosh 07/08/2023 07:55


![image](https://cdn.discordapp.com/attachments/1127118998304198737/1127146000126054450/image.png?ex=65ec1603&is=65d9a103&hm=9310cac7ee7386ca57f88e1a0bdf63ea2b30601d11e4604cbe3a515d710624a9&)

=== @ Moosh 07/08/2023 07:58

So where's it save the results? Not finding `.tmp/fuzz_debugging`

=== @connorjclark (discord: connorclark) 07/08/2023 08:09

this is unrelated to fuzzing
Hit Retry
It's telling you the file and line number of an assertion that is failing
Retry will bounce you back into VS debugger

=== @ Moosh 07/08/2023 08:10

Oh I see

=== @ Moosh 07/08/2023 08:11

I think this is he same place the debugger was pointing me before

=== @connorjclark (discord: connorclark) 07/08/2023 08:12

yea b/c this isnt a memory issue
must be an api mistake
what is the assertion

=== @ Moosh 07/08/2023 08:13

```Unhandled exception at 0x00007FFC405D4DC5 (allegro_audio-5.2.dll) in zelda.exe: 0xC0000005: Access violation reading location 0x0000000000000018.```
unable to see the actual file what done it
```// Run an NSF, or a MIDI if the NSF is missing somehow.
bool try_zcmusic(char *filename, int32_t track, int32_t midi)
{
    ZCMUSIC *newzcmusic = zcmusic_load_for_quest(filename, qstpath);
    
    // Found it
    if(newzcmusic!=NULL)```
But the line before it goes into the DLLs is zc_music_load_for_quest
which actually makes no sense. I should be able to read that. Why's it saying "Symbol file not loaded"?
oh duh, zcsound is a dll. welp

=== @connorjclark (discord: connorclark) 07/08/2023 08:18

shot in the dark but
`add_library(zcsound SHARED ${ZCSOUNDSOURCES})` change that to STATIC
maybe better debugging?
(do not commit tho)

=== @ Moosh 07/08/2023 08:21

It did not like that

=== @connorjclark (discord: connorclark) 07/08/2023 08:21

lol sry
Thats weird
can you push to a branch so I can look?

=== @ Moosh 07/08/2023 08:21

no worries. let me check something first though...

=== @ Moosh 07/08/2023 08:32

Remind me how do I push to a new branch? `git push -u origin branch_name`?

=== @ Moosh 07/08/2023 08:34

Every single time I've used git I've managed to screw something up so far, an astounding track record really. So just wanna make sure I don't accidentally push to main or smack the button that arms the nukes

=== @arceusplayer11 (discord: Deedee) 07/08/2023 08:43

I need to learn command line git at some point
I'm more of a GUI user

=== @ Moosh 07/08/2023 08:51

```error: src refspec enhmusicseeking does not match any```
yeah I just keep getting this. Clearly do not understand what I'm doing here
last time Emily walked me through how to do this stuff but it went in one ear out the other

=== @ Moosh 07/08/2023 08:55

https://github.com/ArmageddonGames/ZQuestClassic/tree/enhmusicseeking
...but it does say 1 new commit 15 minutes ago. So damn confused

=== @ Moosh 07/08/2023 08:57

Test quest that produced the crash
https://cdn.discordapp.com/attachments/1127118998304198737/1127161561270730773/CanCan.mp3?ex=65ec2481&is=65d9af81&hm=52ff03a3145ae39eba894356572d5661569ca9557273cd03a7ee1a8eecb67737&
https://cdn.discordapp.com/attachments/1127118998304198737/1127161561581113394/CanCan.qst?ex=65ec2481&is=65d9af81&hm=b55ce2c8d6ac63fc6e5613500c3164316d11ecfb164afe8e6fd4ba626555b49c&
Happens on screen 0x10
And the test script, though all it's doing is playing the music
https://cdn.discordapp.com/attachments/1127118998304198737/1127161869958918174/CanCan.zs?ex=65ec24cb&is=65d9afcb&hm=101972766dc6d6192aa0257ea7216cd66cd61b549f7854c43c6ef06d2e06199c&

=== @connorjclark (discord: connorclark) 07/08/2023 09:16

i'll pick this up tmrw fyi

=== @connorjclark (discord: connorclark) 07/09/2023 07:51

Looking at this now

=== @connorjclark (discord: connorclark) 07/09/2023 07:55

music works for me @ Moosh
beautiful movement

=== @ Moosh 07/09/2023 07:56

And the crash?

=== @connorjclark (discord: connorclark) 07/09/2023 07:56

I just loaded dmap screen 0 0
I'm in vc btw
What was the crash ?
Ah, I moved down and saw it üôÇ

=== @ Majora 07/09/2023 08:30

oh god

=== @ Moosh 07/09/2023 14:40

So enhanced music stuff's going well. Got two more features on my todo. 
-Add loop points to the DMap editor (how touchy will this be?)
-Fix up the atrocious volume changing opcodes so they don't override user volume changes (behavior will be changed from something that was technically "working" so I imagine this needs a QR?)

=== @EmilyV99 (discord: Emily) 07/09/2023 14:45

- pretty sure the dmap editor is still an old dialog, so oof
- yeah needs a qr
Also you need to give scripts the ability to manage these

=== @ Moosh 07/09/2023 14:46

More meant expanding the size of DMap data. Is there a buffer already that'd fit two longs?

=== @EmilyV99 (discord: Emily) 07/09/2023 14:47

Dmapdata isn't bad to expand

=== @ Moosh 07/09/2023 14:47

Scripts can set loops already. For setting dmapdata loop points I figure they can have a similar function and don't need a getter

=== @EmilyV99 (discord: Emily) 07/09/2023 14:48

Should have a getter

=== @ Moosh 07/09/2023 14:48

Think so? Fair enough

=== @EmilyV99 (discord: Emily) 07/09/2023 14:48

Also can probably be variables rather than functions?

=== @ Moosh 07/09/2023 14:49

Actually...does the allegro implementation have a getter?
...lmao it doesn't

=== @EmilyV99 (discord: Emily) 07/09/2023 14:49

Lovely, fun

=== @ Moosh 07/09/2023 14:50

I mean that doesn't affect the dmap editor any but that's funny that they came to the same conclusion as me

=== @EmilyV99 (discord: Emily) 07/09/2023 14:50

So you'd need to track it yourself to getter the current
... Probably fine without
Though, for scripts btw
#2479

=== @ Moosh 07/09/2023 14:51

Ooh this sounds fancy and cool. It also sounds like something I wouldn't know where to begin with
Funny enough this whole project has been really minor edits on my part. Allegro (and Connor) have done all the heavy lifting

=== @EmilyV99 (discord: Emily) 07/09/2023 14:53

Mayhaps we can work on that together when I'm home

=== @ Moosh 07/09/2023 14:54

I'd be open. Another stretch goal would be a way of doing crossfades between two songs

=== @ Moosh 07/09/2023 14:56

My concern there is that sounds like even more refactoring and potentially screwing up music playback (shoutouts to MP3 playback crashing under certain circumstances and nobody noticing until I started this)
I feel like loop points are a high demand feature and I wanna get it into people's hands sooner rather than later

=== @EmilyV99 (discord: Emily) 07/09/2023 14:57

Yet also can be better to wait and get a clean new set of music features all together cleanly

=== @ Moosh 07/09/2023 14:59

wanna get some full quest tests in either way. Maybe Bananas and Stellar Seas

=== @ Moosh 07/09/2023 15:00

super paranoid about releasing and another major crash turning up. Though I've barely touched anything so I doubt that's a concern now

=== @ Moosh 07/09/2023 15:05

actually that has me remembering, there's one other thing I should be fixing. There's a place where I passed an OGG as an MP3FILE struct on accident I think. And this somehow worked because they happened to have a stream pointer in the same spot ü§¶
definitely don't want to forget that one. but also I'm done devving for today

=== @connorjclark (discord: connorclark) 07/10/2023 20:57

Have you noticed any differences in sound quality or performance or anything using ogg via allegro 5?
I'm looking at alogg (what we currently use, in allegro add-ons folder) and I see it uses vorbis too.... Not sure how if we never had this thing installed locally üëÄ

=== @connorjclark (discord: connorclark) 07/10/2023 20:59

oh thats how
![image](https://cdn.discordapp.com/attachments/1127118998304198737/1128067965087129610/image.png?ex=65e63629&is=65d3c129&hm=4b9ec2e3af63f469e4228941657e6e85d376bd7398d13682d3a76a327207cee1&)
we were building the decoder bit of libvorbis ourselves

=== @ Moosh 07/10/2023 21:01

ah.

=== @connorjclark (discord: connorclark) 07/10/2023 21:01

alogg doesn't support loop points so we are still in the right direction w/ using a5 instead

=== @ Moosh 07/10/2023 21:01

Haven't noticed any differences in quality, though I have terrible ears

=== @ Moosh 07/10/2023 21:04

I wouldn't be surprised if alogg was worse though, being abandoned and all

=== @ Moosh 07/10/2023 21:05

original site hosting it is gone, no idea what became of the docs, Deedee apparently figured out how to use it by looking through a random github repo. So yeah, the change was good üòõ

=== @connorjclark (discord: connorclark) 07/11/2023 01:02

so `tmusic_loop_start` is in seconds
but allegro stream loop api takes a double of seconds
so we're losing a lot of possible precision here

=== @connorjclark (discord: connorclark) 07/11/2023 01:07

We can't write a double, as much as we wish we could. Binary format of fp numbers are not standardized. https://stackoverflow.com/questions/15301076/c-portable-floating-point-bit-representation
(there is a `p_igetf` used in ancient history, but not anymore)

=== @EmilyV99 (discord: Emily) 07/11/2023 01:07

Zfix would be the best zscript could handle anyway

=== @connorjclark (discord: connorclark) 07/11/2023 01:08

so...lets save in microseconds? or nano? or w.e. makes sense

=== @EmilyV99 (discord: Emily) 07/11/2023 01:08

Zfix would give 1/10000 seconds precision

=== @connorjclark (discord: connorclark) 07/11/2023 01:09

which i doubt audio formats have that much, but we aren't strapped for space so thats fine
max 32 bit signed int / 10000 = 3579 minutes

=== @connorjclark (discord: connorclark) 07/11/2023 01:10

(also: this field should be unsigned 32bit)

=== @EmilyV99 (discord: Emily) 07/11/2023 01:11

Zscript has no way to handle unsigned

=== @connorjclark (discord: connorclark) 07/11/2023 01:13

what zscript is capable of shouldnt inform how we save the field in qst format or hold it in memory

this value is meaningless if negative, so it shouldn't use a signed type

just means zscript wont be able to handle the extreme edge case of someone with more than 3579 minutes of audio in a song
but... can still set that in ZQuest ü§∑‚Äç‚ôÇÔ∏è

=== @ Moosh 07/11/2023 01:20

So that's a little under 60 hours. A music file that long is quite frankly overkill. Even if you're using extended music the longest you find on Youtube usually go up to an hour. So there's no reasonable way to get a music file that long with good intentions

=== @ Moosh 07/11/2023 01:22

the reason I used fixed was that I didn't want any floating point precision errors happening in the UI. I dunno when double starts to run into those. Probably not too big a concern but better safe than sorry

=== @ Moosh 07/11/2023 01:26

Audacity also tracks loop selections down to milliseconds and that felt like more than enough from my testing

=== @EmilyV99 (discord: Emily) 07/11/2023 01:27

Zfix feels sane enough

=== @connorjclark (discord: connorclark) 07/11/2023 01:30

I totally overlooked you were dividing by 10000
Assumed you had just second precision here

=== @ Moosh 07/11/2023 01:30

ohhh
yeah that would be frustrating

=== @arceusplayer11 (discord: Deedee) 07/11/2023 01:49

decimals being used for microseconds/milliseconds, while the nondecimal is used for seconds feels a bit more intuitive, even if that last decimal ultimately ends up pointless cause milliseconds are 3 digits and decimals are 4 digits

=== @connorjclark (discord: connorclark) 07/11/2023 05:22

I've reworked our local vorbis/ogg builds to be provided as inputs to allegro's audio build
so no need to use vcpkg
I took some of your changes moosh (the refactoring to `ALSTREAMFILE`, good stuff)
once I verify in all the OSes i'll merge

=== @connorjclark (discord: connorclark) 07/11/2023 05:31

kinda weird hearing this guy in zquest. https://upload.wikimedia.org/wikipedia/commons/c/c8/Example.ogg

=== @connorjclark (discord: connorclark) 07/11/2023 06:26

(replying to @connorjclark (discord: connorclark) "I've reworked our local vorbi‚Ä¶"): ...well i almost did. actually this won't be feasible. so nvm, package managers it is

=== @connorjclark (discord: connorclark) 07/11/2023 06:31

good news is that OGG is totally optional, don't need it to build locally

=== @ Majora 07/11/2023 06:33

I thought people wanted ogg cuz it's smaller than mp3

=== @connorjclark (discord: connorclark) 07/11/2023 06:39

what are you responding to
example.ogg guy kinda sounds like you

=== @ Majora 07/11/2023 06:40

That building with ogg is optional, which I take to mean only mp3 would be usable?

=== @connorjclark (discord: connorclark) 07/11/2023 06:41

note I qualified it with: "locally"
as in our local developer builds

=== @ Majora 07/11/2023 06:41

(replying to @connorjclark (discord: connorclark) "example.ogg guy kinda sounds‚Ä¶"): Shut up <:sadge:811695648063357028>  (he kinda does <:vap_sad:833989934620213279> )
Oh

=== @connorjclark (discord: connorclark) 07/11/2023 06:41

dont _need_ libogg/libvorbis installed to build...ogg would just fail to play
of course, on github CI it would build w/ libogg

=== @ Majora 07/11/2023 06:43

Ohhhhh, I get it now

=== @connorjclark (discord: connorclark) 07/11/2023 08:47

Everything's working in CI now for using a5 streams for OGG, I'll merge this tomorrow.

=== @connorjclark (discord: connorclark) 07/12/2023 00:42

OGG now using a5 streams on main.

=== @connorjclark (discord: connorclark) 07/17/2023 08:37

lmk when you're done adding stuff to your branch, and I'll fix the web build on it.

=== @ Moosh 07/17/2023 08:41

Will do. Currently I'm looking at fixing the ZScript volume modification functions, which...ew. Ick even.

=== @ Moosh 07/18/2023 06:31

Fixed up AdjustMusicVolume() and AdjustSFXVolume(). I'm noticing there's also a `void AdjustSound(int, int, bool)` in ZScript_Additions.txt with no documentation of what it does.

=== @ Moosh 07/18/2023 06:33

```                // int32_t sound = ri->d[rEXP1]/10000;
                // int32_t pan = ri->d[rINDEX2];
                // control_state[6]=((value/10000)!=0)?true:false;
                // bool loop = ((ri->d[rINDEX]/10000)!=0)?true:false;
                //SFXBackend.adjust_sfx(sound,pan,loop);
                
                //! adjust_sfx was not ported to the new back end!!! -Z```
Seems it was going to set pan, loop and...whatever the heck control_state[6] does

=== @ Moosh 07/18/2023 06:34

wait that's a controller input! what

=== @ Moosh 07/18/2023 06:38

Anyways, I don't think it'd be hard to restore this, but I wonder if it shouldn't just be something like `Audio->PlaySound(int soundid, int volume, int pan=0, bool loop=false)` and then it sets all those and starts playing the sound. Regular PlaySound would reset them back to defaults

=== @connorjclark (discord: connorclark) 07/18/2023 06:58

> //! adjust_sfx was not ported to the new back end!!! -Z

So was it ever used before?
git blame keeps crashing on me here

=== @EmilyV99 (discord: Emily) 07/18/2023 06:59

probably used in the old 2.60 stuff (abandoned fork)

=== @ Moosh 07/18/2023 06:59

ahh

=== @connorjclark (discord: connorclark) 07/18/2023 07:00

then do whatever you like with the command

=== @EmilyV99 (discord: Emily) 07/18/2023 07:00

(replying to @ Moosh "Anyways, I don't think it'd b‚Ä¶"): this sounds pretty sane

=== @connorjclark (discord: connorclark) 07/18/2023 07:00

..just don't set control state üôÇ

=== @EmilyV99 (discord: Emily) 07/18/2023 07:00

yeah that was probably just zoria copy+pasting from another command and then commenting it out instead of changing it
he does that a lot

=== @ Moosh 07/18/2023 07:04

Imagine it's safe to just reuse the old opcode for something else. It was technically in the docs but still undocumented and did nothing

=== @EmilyV99 (discord: Emily) 07/18/2023 07:09

The question is did anything compile to that opcode that people could have tried to use
if so, then you could break those quests (until they recompile)

=== @ Moosh 07/18/2023 11:42

this is such a basic feature but can accomplish some cool effects. Will also save me some Audacity trips in the future
![image](https://cdn.discordapp.com/attachments/1127118998304198737/1130827034239713310/2023-07-18_07-29-52.mp4?ex=65e7053e&is=65d4903e&hm=d37142e4cf1ba09cc902755d5d2315d599b92e5f500833fc746474b8737a4c7d&)

=== @ Moosh 07/18/2023 11:46

Should probably also have a way to detect if a sound is currently playing for things like the whistle. Is there a way to tell how far through a sound it is though? Like get the sound's sample length? That could be even more useful

=== @EmilyV99 (discord: Emily) 07/18/2023 13:30

`sfx_allocated()` checks if it is playing
not sure about duration

=== @connorjclark (discord: connorclark) 07/18/2023 15:34

Unless usage of sfx allocated is especially useful, please avoid. It is not deterministic.
As it checks the state of some other thread

=== @EmilyV99 (discord: Emily) 07/18/2023 15:35

^ aye fair....
I mean, is `sfx_no_repeat` and half the shit the engine does a problem then?

=== @connorjclark (discord: connorclark) 07/18/2023 15:36

No because mostly game logic does not change based on it, except where it does you will see awful hacks for replays to work
Like the whistle
And picking up triforce

=== @connorjclark (discord: connorclark) 07/18/2023 15:38

(replying to @EmilyV99 (discord: Emily) "I mean, is `sfx_no_repeat` an‚Ä¶"): I think this only emits a replay comment when issued. Just doesn't care about if it is actually playing

=== @EmilyV99 (discord: Emily) 07/18/2023 15:42

(replying to @connorjclark (discord: connorclark) "I think this only emits a rep‚Ä¶"): 
![image](https://cdn.discordapp.com/attachments/1127118998304198737/1130887289606766743/image.png?ex=65e73d5c&is=65d4c85c&hm=5bb1f35c84f3db7c7d95ae398d8936d496c839e629eb6cff183a10f16a278dbd&)
definitely looks to do nothing if it isn't allocated

=== @EmilyV99 (discord: Emily) 07/18/2023 15:44

(this has recently been used more with new combo stuff)

=== @connorjclark (discord: connorclark) 07/18/2023 15:56

sfx_no_repeat call does ever not call replay comment because of `repeat == false`

=== @connorjclark (discord: connorclark) 07/18/2023 15:59

And I believe `sfx_allocated()` will returnr true instantly when started. it's just that when it stops is not deterministic since every frame `sfx_cleanup()` will check if it is playing or not, then clear it when done.

=== @EmilyV99 (discord: Emily) 07/18/2023 16:05

ah

=== @ Moosh 07/18/2023 16:08

So what we'd want to make getting currently playing sfx deterministic I imagine would be some sort of backup system like what the whistle is doing but for every sound? Predict how many frames the sound should play for and then count that down when in replay mode? Or is this a stupid idea.

=== @connorjclark (discord: connorclark) 07/18/2023 16:10

No that's reasonable. I'll take a look later

=== @ Moosh 07/18/2023 16:16

Shit, on thinking some, I imagine the getter for enhanced music position also has this issue

=== @ Moosh 07/18/2023 16:18

Could probably do something similar there but it would cause very strange sound behavior in replays because music runs long enough to noticeably desync every time

=== @connorjclark (discord: connorclark) 07/18/2023 16:20

Alternatively we can store the state of the sfx when the command is executed
Similar to how RNG/mouse position works

=== @ Moosh 07/18/2023 16:21

oh
Yeah that might be way smarter than what I was thinking

=== @connorjclark (discord: connorclark) 07/18/2023 16:26

Is there a sfx/voice length method?

=== @ Moosh 07/18/2023 16:28

I didn't find one. Enhanced music has one, but SFX are running on legacy code

=== @connorjclark (discord: connorclark) 07/18/2023 16:30

Does not seem to be an a4 API for it but they must have it internally
We can modify allegro-legacy

=== @connorjclark (discord: connorclark) 07/18/2023 16:37

https://www.allegro.cc/manual/4/api/structures-and-types-defined-by-allegro/sample

=== @ Moosh 07/19/2023 01:36

I turned myself into a piano, Morty! I'm Piano Moosh!
![image](https://cdn.discordapp.com/attachments/1127118998304198737/1131036783199670313/2023-07-18_21-34-57.mp4?ex=65e7c896&is=65d55396&hm=1bdc31cb74daa9ed1e43cfb066bcc13ce291363537ac48fe54c5a7bdd41c1a6f&)

=== @EmilyV99 (discord: Emily) 07/19/2023 01:37

XDDDDDD

=== @ Moosh 07/19/2023 01:38

adding frequency onto PlaySound because I noticed it it among the other functions

=== @ Moosh 07/19/2023 01:39

Had no idea allegro could do this kind of thing and it's wicked cool. Absolutely something I'd use

=== @connorjclark (discord: connorclark) 07/19/2023 01:50

sounds like banjo kazooie

=== @EmilyV99 (discord: Emily) 07/19/2023 01:52

(replying to @ Moosh "I turned myself into a piano,‚Ä¶"): you need to post this in some other places lol

=== @ Moosh 07/19/2023 01:53

Wanna make sure it's not completely fucked first
I'm getting some crashes when I'm trying to get the base frequency of the sound. Probably just overlooked something

=== @EmilyV99 (discord: Emily) 07/19/2023 01:54

(don't push anything to main until connor posts a nightly soon, he wants to make sure he has a clean/working version for the flatpak build)

=== @connorjclark (discord: connorclark) 07/19/2023 01:55

@ Moosh Allegro supports accessing the microphone too... https://github.com/liballeg/allegro5/blob/c2bf1e11bed0b63539267115baf190741e0a437a/examples/ex_record.c#L160

=== @ Moosh 07/19/2023 01:55

oh hell

=== @connorjclark (discord: connorclark) 07/19/2023 01:56

Which you can, of course, treat like any other audio stream.

=== @EmilyV99 (discord: Emily) 07/19/2023 01:56

hahhahahahahaha

=== @ Moosh 07/19/2023 01:56

On one hand that would be cool in some circumstances, on the other it'd present new accessibility issues to quests potentially

=== @EmilyV99 (discord: Emily) 07/19/2023 01:56

"blow into the mic to blow out the torches"

=== @connorjclark (discord: connorclark) 07/19/2023 01:56

We need this to enable recreating w/e Zelda game where you blow into something to do that^
I'm sure there is one.

=== @EmilyV99 (discord: Emily) 07/19/2023 01:57

(Phantom Hourglass / Spirit Tracks)

=== @ Moosh 07/19/2023 01:57

Phantom Hourglass

=== @EmilyV99 (discord: Emily) 07/19/2023 01:57

DS gimmick

=== @ Moosh 07/19/2023 01:57

Make a quest with that and fully mouse controls for the ultimate in accessibility nightmares

=== @connorjclark (discord: connorclark) 07/19/2023 01:57

Turn on the webcam to get the sword

=== @EmilyV99 (discord: Emily) 07/19/2023 01:57

XD

=== @connorjclark (discord: connorclark) 07/19/2023 01:57

"Sorry mr link, but we must verify your identity"
"can't just be handing out these pointy bois"

=== @ Moosh 07/19/2023 01:57

You turn on the quest it's like "I wanna see your faaaaaaace"
plays the webcam back to you in glorious 16 colors

=== @EmilyV99 (discord: Emily) 07/19/2023 01:58

my brain just went immediately to "show dem titties if you want the triforce"
XD
god there would be so many cursed quests

=== @ Moosh 07/19/2023 02:29

(replying to @ Moosh "I'm getting some crashes when‚Ä¶"): ```        if(sfxdat)
        {
            if(index<Z35)
            {
                sfx_voice[index]=allocate_voice((SAMPLE*)sfxdata[index].dat);
            }
            else
            {
                sfx_voice[index]=allocate_voice((SAMPLE*)sfxdata[Z35].dat);
            }
        }
        else
        {
            sfx_voice[index]=allocate_voice(&customsfxdata[index]);
        }```
So what's going on in that first else. If there's a sfx.dat and it's a custom sound, it always allocates slot 61. If there is no sfx.dat, it loads the sfx from the specificed index as I'd expect

=== @connorjclark (discord: connorclark) 07/19/2023 19:32

There's also the timing issue of sfx not being tied to framerate. Play uncapped, and the sfx plays as usual, so if a script uses "sfx still allocated?" as a way to do _anything other than just retart a sfx_ (in which case, just do a repeating sfx?), it will desync with a visual animation. This may be noticeable even without playing uncapped, just b/c of inherent FPS variance. In other words, "if sfx is no longer allocated, that means I should do something that effects gameplay this frame" is just not gonna work perfectly. We can't sync sfx with gameplay frames.

What are some example features/script that would be possible w/ `sfx_allocated`? btw, gettiing the current posistion of a sfx/music has the same problem.

=== @connorjclark (discord: connorclark) 07/19/2023 19:38

This has all the problems mentioned above, but poses no issues for replayability:

```c
Game->PlaySound("whatever");
int sfx_duration_frames = Audio->GetEstimateSFXDuration("whatever") // We return how many frames it _should_ take (roughly), given 60FPS
// Script should save the above variable somewhere, do its own accounting of frames, the call something when it should be "Done" 
// or...... Game-RunLater(someMethod, sfx_duration_frames); ????
// 
```

=== @connorjclark (discord: connorclark) 07/19/2023 19:40

But if the only purpose is to "replay another sound when this is done".... then we should just 1) support playing a loop SFX and 2) have a very specific `Audio->PlayIfSFXNotAlreadyActive("...")` (basically we call `sfx_no_repeat`) or whatever..

=== @ Moosh 07/19/2023 19:57

Okay so going in order from least to most useful:
-Detecting if a SFX is allocated: can do timings irrrspective of f1, like the whistle. Useful for chaining different sounds together or preventing sfx cutoff in some situations. Not super essential to a scripter. I guess could also be used for a scripted element that responds to sound effects playing, such as the Ear Patra from Bananas

=== @ Moosh 07/19/2023 20:00

-Detecting sfx completion: Unsure if actually possible, but would make AdjustSFX() more useful and able to more accurately time effects. Still not that important, but if I can't get this working may just ditch AdjustSFX(). Can also cover detecting sfx playing with the same opcode (returns -1 if the sound isn't playing, returns completion percentage otherwise)

=== @ Moosh 07/19/2023 20:02

-Detecting music position: I see this one being super useful. Any scripted effect involving music will depend on this, for example: a rhythm game type mechanic such as the beat blocks in Go Gollab. I also would really like to have boss fights that sync up with their soundtrack to do cool things at key moments

=== @connorjclark (discord: connorclark) 07/19/2023 20:07

Ok, sounds pretty useful.

=== @connorjclark (discord: connorclark) 07/19/2023 20:08

I guess we can record all these things specifically in a replay (well, just the command results, as I mentioned before). It's not ideal but it's the simplest approach that doesn't enforce a certain API (like my callback idea after a fixed number of frames)

=== @connorjclark (discord: connorclark) 07/19/2023 20:10

Wait so your Ear Patra thing..literally the enemy does not hurt you if you disable sounds in Settings, is that the idea?

=== @ Moosh 07/19/2023 20:10

Recording it in the replay will only cause performance loss when those functions are being used right? Like it doesn't have to record them every frame, just ones where they're needed?

=== @connorjclark (discord: connorclark) 07/19/2023 20:10

Right
Basically we serialize the results on a needed basis
Not every frame just in case
I ... Think that's what I did for mouse position?

=== @ Moosh 07/19/2023 20:11

(replying to @connorjclark (discord: connorclark) "Wait so your Ear Patra thing.‚Ä¶"): Ah, it activates when a sound plays. In Bananas this is handled with a custom PlaySound() function and some other checks for things that would play a sound

=== @ Moosh 07/19/2023 20:13

Not activated if sound is disabled wasn't what I had in mind, in the case of Bananas it'd be a funny easter egg. But might be something I should mention in the docs so people don't tie sound to essential gameplay

=== @connorjclark (discord: connorclark) 07/19/2023 20:14

Yeah, in that case I think this specific use case is better served with an event system? When engine plays a sfx, we emit a event
Not sure we could do that performantly
Or, a more custom thing where one script emits a custom event that another script listens for

=== @ Moosh 07/19/2023 20:15

it's such a niche example I don't think it's worth the effort

=== @ Moosh 07/20/2023 06:40

So what does this all mean? I assume I can expect an angry letter from Captain Hook for one thing.
![image](https://cdn.discordapp.com/attachments/1127118998304198737/1131475734121152592/image.png?ex=65e96164&is=65d6ec64&hm=6114e1870bc0c56bd7a2f0f262494a87fc9e1d624b0fad4e660c82965f44b06c&)
but nothing in this error screams "A-ha! I know what that means"

=== @EmilyV99 (discord: Emily) 07/20/2023 06:41

err, you need to update your branch?
connor just added headless stuff
I would assume this is due to not having pulled those changes to your branch

=== @ Moosh 07/20/2023 06:41

Ah, gotcha
Hoping that's all and I didn't donk up anything further
oddly only freaked out at replay 1

=== @connorjclark (discord: connorclark) 07/20/2023 06:48

uh that shouldnt happen...workflows are pinned to the `main` branch.. https://github.com/ArmageddonGames/ZQuestClassic/blob/main/.github/workflows/ci.yml#L46
weird.
yeah, rebase and try again i guess
...oh right the _workflow_ is pinned to main, but it is using your branches copy of the python script
duh
(not duh - it's v. confusing)

=== @ Moosh 07/20/2023 06:49

ahh

=== @ Moosh 07/20/2023 06:51

When it comes to the replay stuff for GetSoundCompletion() and GetMusicPos() would you prefer to handle that or should I try and tackle it?

=== @connorjclark (discord: connorclark) 07/20/2023 06:52

I'd like to, but likely next week.
You can land without it.

=== @ Moosh 07/20/2023 06:52

Sounds good.

=== @ Moosh 07/20/2023 08:16

So here I have a looping sfx panning from the left ear to the right ear and sliding its frequency up/down as it goes. Loving the kind of things I'm able to do with this feature
![image](https://cdn.discordapp.com/attachments/1127118998304198737/1131499888006398013/2023-07-20_04-13-08.mp4?ex=65e977e3&is=65d702e3&hm=c2916a571973db83d0292f8fb63fe9b4770de5bee9ce527c28602cf7508be80f&)

=== @arceusplayer11 (discord: Deedee) 07/20/2023 08:20

AAAAAAAAAA
honestly, some way to tie certain sfx/music to the framerate would be good

=== @ Moosh 07/20/2023 08:20

Tie in how so?

=== @arceusplayer11 (discord: Deedee) 07/20/2023 08:21

say for rhythm based games
the gameplay wouldn't really make much sense if you uncap through it while the music remains the same

=== @ Moosh 07/20/2023 08:22

I don't think ZC is good for a true rhythm game, but you can get the current position for the playing enhanced music
Was thinking earlier how  much better that'd make the Gollab beat block rooms

=== @arceusplayer11 (discord: Deedee) 07/20/2023 08:23

I mean yeah but also those rooms are kinda bad because they involve so much waiting

=== @ Moosh 07/20/2023 08:23

(replying to @ Moosh "So here I have a looping sfx‚Ä¶"): Also this effect here is fully independent of framerate because I'm using the SFX's completion percentage instead of a timer in the script

=== @arceusplayer11 (discord: Deedee) 07/20/2023 08:23

oh I'm not responding to the video (other than the AAAAAAAAAAA)

=== @ Moosh 07/20/2023 08:24

I know, just brought it up because it's relevant
I am resisting (and occasionally failing) the urge so hard to just ramble to everybody I know about these features ü§£

=== @EmilyV99 (discord: Emily) 07/20/2023 08:30

(replying to @ Moosh "I am resisting (and occasiona‚Ä¶"): Now you know why I ramble about new shit so much LMAO

=== @ Moosh 07/20/2023 08:31

Oh yeah, I have definitely felt that feeling
it's a good feeling...ish

=== @EmilyV99 (discord: Emily) 07/20/2023 08:33

Pits, crystal switches, everything triggers tab, sideview ladders...
So much I've done at this point lol

=== @ Moosh 07/20/2023 08:34

It's wild how much cool new shit you've added

=== @EmilyV99 (discord: Emily) 07/20/2023 08:34

yeah, and a ton of work- which you have a taste of now lol

=== @ Moosh 07/20/2023 08:35

The other day I was using a generic script with events to make a custom enemy defense and just thinking once again "Damn it's cool that this exists"

=== @EmilyV99 (discord: Emily) 07/20/2023 08:35

hahaha yeah ‚ù§Ô∏è

=== @ Moosh 07/20/2023 08:36

And how it's crazy that there was a period where I thought 2.50 was "finished" and ZC didn't need any more features

=== @EmilyV99 (discord: Emily) 07/20/2023 08:36

hahahahaha
hilarious

=== @ Moosh 07/20/2023 08:50

So...what would cause git blame to return different results for something on my branch and on main? Am I misunderstanding something here?
That midi_paused=false on my branch is attributed to Saffith 7 years ago
![image](https://cdn.discordapp.com/attachments/1127118998304198737/1131508727112024114/image.png?ex=65e9801e&is=65d70b1e&hm=d3ed551a4fc7692bf820d6b19995014f78280adad653f7f7095f022f6f876e9f&)
But on main there's no recent changes in that area, yet it isn't there
![image](https://cdn.discordapp.com/attachments/1127118998304198737/1131508885367300156/image.png?ex=65e98044&is=65d70b44&hm=2c5a8cf0bcc2606e072b78281b27f7a8c745f1b741519fc89f036a6608834944&)

=== @ Moosh 07/20/2023 08:53

wait duh, it's because blame can't actually catch removals isn't it

=== @arceusplayer11 (discord: Deedee) 07/20/2023 08:54

yeah, it can't
where would it show them?

=== @ Moosh 07/20/2023 08:55

I mean it could have a big red block showing where the chunk was bisected, or a click for details or something. I can see how all of these would be ass to handle logic for though
especially since command line

=== @connorjclark (discord: connorclark) 07/20/2023 15:06

Blame is just the wrong tool, it'd be too noisy to include removals.

If you want to compare two branches, you do 'git diff'

If you want a change by change view, it's git log -p
https://stackoverflow.com/a/74699360/2788187

=== @connorjclark (discord: connorclark) 07/20/2023 16:23

(replying to @ Moosh "So what does this all mean? I‚Ä¶"): I just realized who Captain Hook is

=== @ Moosh 07/27/2023 14:11

fun thing I'm realizing about doing stuff with sound that I somehow dodged around earlier. Shit can get _loud_

like oh christ that blasted my ears out

=== @EmilyV99 (discord: Emily) 07/27/2023 14:13

hahahahhahaha

=== @ Moosh 07/27/2023 14:14

somehow in my head the volume cap ZC sets was a hard one and not something we set outselves for the sake of sanity

=== @EmilyV99 (discord: Emily) 07/27/2023 14:16

*oh no*

=== @ Moosh 07/27/2023 16:15


![image](https://cdn.discordapp.com/attachments/1127118998304198737/1134157075677724752/2023-07-27_12-13-44.mp4?ex=65e9e816&is=65d77316&hm=55e8a4caf19af73e4e745713d69f67859ec82561d879d648cb1d4cff53e09ca4&)

=== @ Moosh 07/27/2023 16:38

https://discord.com/channels/876899628556091432/1123579142596735037
(meta, MessageType.pins_add) 

=== @connorjclark (discord: connorclark) 07/27/2023 17:49

Moosh what does some of the zscript look like here for crossfade?

=== @ Moosh 07/27/2023 17:50

```Audio->CrossfadeEnhancedMusic("Stardust.ogg", 0, 300, 68.279);```
Filename, track, fade time (in frames), position in track (in seconds)

=== @ Moosh 07/27/2023 17:52

Think I might wanna split fade time into fadeInTime and fadeOutTime.

=== @ Moosh 07/29/2023 02:24

So DMap crossfades...How best to handle fading from a screen where music was played via script to a new DMap?

=== @ Moosh 07/29/2023 02:26

I guess just make a new opcode that plays enhanced music but also records a fadeout value. But that just seems wasteful to me...

=== @arceusplayer11 (discord: Deedee) 07/29/2023 02:30

SetFadeout maybe?

=== @EmilyV99 (discord: Emily) 07/29/2023 02:31

yeah, just use the dmap's fadeout unless the user SetFadeout's a new one

=== @ Moosh 07/29/2023 02:32

Seems like it shouldn't be a separate function. This is something you want to be associated with the playing music

=== @EmilyV99 (discord: Emily) 07/29/2023 02:32

I mean, then you just need a new play music function anyway
there's no way to do it without a new opcode
either you setfadeout, or you make it part of a new play enhanced music function
. . . Personally, I would love to see enhanced music changed to work more like MIDIs
with a list of howevermany, and then you just set the ID
but to do that and handle compat sounds like a huge nightmare
...not IMPOSSIBLE, just a huge nightmare

=== @ Moosh 07/29/2023 02:34

In the dmap editor? Sounds spooky, Iain'ttouchningthat
Just rerouting various functions to use the tracklist if a rule is set doesn't sound bad though

=== @ Moosh 07/29/2023 02:35

I can kinda see the value of a tracklist, but when working with ZQ or scripts I mostly think I'd find it a hassle

=== @ Moosh 07/29/2023 02:36

Most cases where you set music, it's single use. Set it for one or two dmaps and then you're done with the song forever. So that's where saving it as a string comes in handy
Now the tracklist could be used to validate the quest's enhanced music folder on load, which is something a script could do as well but would be a hassle

=== @ Moosh 07/31/2023 12:37

TODO: fix bug with volume sliders not updating OGG/MP3 volume. Putting this here so I don't forget.
(meta, MessageType.pins_add) 

=== @ Moosh 08/01/2023 09:28

Notice my builds are failing on Mac OS and Ubuntu now. 
```10 warnings generated.
[817/828] Building CXX object _deps/asmjit-build/CMakeFiles/asmjit.dir/Release/src/asmjit/x86/x86compiler.cpp.o
[818/828] Building CXX object _deps/asmjit-build/CMakeFiles/asmjit.dir/Release/src/asmjit/x86/x86formatter.cpp.o
[819/828] Building CXX object _deps/asmjit-build/CMakeFiles/asmjit.dir/Release/src/asmjit/x86/x86emithelper.cpp.o
[820/828] Building CXX object _deps/asmjit-build/CMakeFiles/asmjit.dir/Release/src/asmjit/x86/x86func.cpp.o
[821/828] Building CXX object _deps/asmjit-build/CMakeFiles/asmjit.dir/Release/src/asmjit/x86/x86assembler.cpp.o
[822/828] Building CXX object _deps/asmjit-build/CMakeFiles/asmjit.dir/Release/src/asmjit/x86/x86operand.cpp.o
[823/828] Building CXX object _deps/asmjit-build/CMakeFiles/asmjit.dir/Release/src/asmjit/x86/x86instapi.cpp.o
[824/828] Building CXX object _deps/asmjit-build/CMakeFiles/asmjit.dir/Release/src/asmjit/x86/x86instdb.cpp.o
[825/828] Building CXX object _deps/asmjit-build/CMakeFiles/asmjit.dir/Release/src/asmjit/x86/x86rapass.cpp.o
[826/828] Linking CXX shared library Release/libasmjit.so
ninja: build stopped: cannot make progress due to previous errors.
Error: Process completed with exit code 1.```
Something to do with asmjit?

=== @EmilyV99 (discord: Emily) 08/01/2023 15:05

err, none of those seem like errors
in the searchbox type `error:`

=== @EmilyV99 (discord: Emily) 08/01/2023 15:07

@ Moosh which shows this:
![image](https://cdn.discordapp.com/attachments/1127118998304198737/1135952044809797642/image.png?ex=65e73548&is=65d4c048&hm=c7a52eeb5684f261db0dd2b82e118e4476b65c5ffc81d0f126fb19e51cc23ff8&)
so, `sprintf` on `zquest.cpp L16409` is using the wrong specifier

=== @ Moosh 08/01/2023 15:12

oh. It did not highlight it in red like an error and when I did a ctrl+f for error, only the last line came up for some reason. ew

=== @EmilyV99 (discord: Emily) 08/01/2023 15:19

yeah, you need to search `error:` not `error`

=== @connorjclark (discord: connorclark) 08/01/2023 15:57

(replying to @EmilyV99 (discord: Emily) "yeah, you need to search `err‚Ä¶"): I'm sad this is also the only way I've found to navigate compiler output for errors

=== @ Moosh 08/03/2023 01:43

@connorjclark (discord: connorclark) Dumbass question, but I should increment this number when rebasing because z3 stuff will presumably be newer than mine once merged, right? It says reserved, but you can't really reserve a quest version like that because it increments on every addition, right?
![image](https://cdn.discordapp.com/attachments/1127118998304198737/1136474308810653716/image.png?ex=65e91bad&is=65d6a6ad&hm=18afb2d735f3e1b3e833e2bbd07cce39f8174210d6c0432522294d295753eab9&)

=== @connorjclark (discord: connorclark) 08/03/2023 02:07

You're right! You should ignore it.
Note how I made it be 18 next
That's when I realized it was moot
And why I added a -z3 flag for my branch
Which is just a hack to manually fix this problem

=== @connorjclark (discord: connorclark) 08/03/2023 02:11

(replying to @connorjclark (discord: connorclark) "Note how I made it be 18 next"): (maybe that was only in my branch)
Regardless, 17 is essentially wasted and you must skip it

=== @ Moosh 08/03/2023 02:12

Okay, so mine should be 18, 17's not used for anything but set by recent builds?

=== @connorjclark (discord: connorclark) 08/03/2023 02:12

Yea

=== @ Moosh 08/03/2023 02:13

god I've put off thise rebase for too long and some of the zdefs restructuring is gonna be painful looks like...

=== @ Moosh 08/03/2023 02:18

Actually nvm, only two commits touched that one and they were both simple changes

=== @ Moosh 08/03/2023 11:31

Okay sooo...I completely fucked something up with git rebase being a dumbass and after spending three hours with Emily trying to fix it, just had to move to a new branch. Sorry for the inconvenience, won't happen again. ü§¶ 

https://github.com/ArmageddonGames/ZQuestClassic/tree/musicreworknew

=== @EmilyV99 (discord: Emily) 08/03/2023 11:36

would LOVE to know any idea WTF happened here if you have any insight, connor- the old branch is entirely fucked- thankfully I had some emergency "don't lose all the new changes" tricks up my sleeve to create this new branch, but the commit history is fucked.

=== @connorjclark (discord: connorclark) 08/03/2023 17:01

reflog undoes anything

=== @connorjclark (discord: connorclark) 08/03/2023 17:08

There you can find a git reference to anything from recent history
Then you do git reset --hard someref
To point your local branch back to that

=== @connorjclark (discord: connorclark) 08/03/2023 17:11

https://stackoverflow.com/a/55937549/2788187
Once you figure out which commit was your last good one via reflog, and force the branch to point at that, we can do a rebase together and I can point out when you've made a potential mistake

=== @connorjclark (discord: connorclark) 08/03/2023 17:13

Btw at any time before finishing a rebase (or any merge) you can cancel with git merge --abort

=== @connorjclark (discord: connorclark) 08/03/2023 17:15

Lastly, in the future you could write down the commit just before you start the rebase, and short circuit hunting for it in reflog if after the fact you don't like the rebase result
Not necessary, saves only a few seconds, reflog has it all

=== @connorjclark (discord: connorclark) 08/03/2023 17:24

Was this your last commit before rebasing? Found in GitHub discord channel

https://discord.com/channels/643145830580092938/643145924566319125/1135856335427219476

=== @EmilyV99 (discord: Emily) 08/03/2023 17:25

aye pretty sure that was
though he also had local changes ( ü§¶‚Äç‚ôÄÔ∏è )

=== @connorjclark (discord: connorclark) 08/03/2023 17:28

Then reflog will have the rest. Can look for that commit sha that last was pushed to GitHub on this branch, and then the last good one will be just after that
This is a better SO post

https://stackoverflow.com/a/135614/2788187

=== @connorjclark (discord: connorclark) 08/03/2023 17:32

so the one you want maybe looks like branchname@{1} or some other number
(replying to @EmilyV99 (discord: Emily) "though he also had local chan‚Ä¶"): Do you mean after the branch was broken?

=== @EmilyV99 (discord: Emily) 08/03/2023 17:41

I believe he had a local commit before doing the rebase

=== @ Moosh 08/03/2023 23:31

It was already broken at that point though. Because I'd tried and screwed up the rebase before I came to Emily for help

=== @connorjclark (discord: connorclark) 08/03/2023 23:36

Do you need help understanding reflog?
It really should all be there

=== @EmilyV99 (discord: Emily) 08/03/2023 23:36

I think you drastically overestimate how much any of us understand git
(your answer is going to be yes, because neither of us understands a DAMN thing about what happened or any idea of how to fix it)

=== @connorjclark (discord: connorclark) 08/03/2023 23:38

We can get on VC sometime later. Should be a quick fix. But only you have all the stuff locally so I can't do more than put the branch back from the last time it was pushed to GH

=== @connorjclark (discord: connorclark) 08/03/2023 23:42

reflog is simply a ledger of every change to a git pointer. branches, HEAD, tags, etc. So you can always return things to a previous state

=== @EmilyV99 (discord: Emily) 08/03/2023 23:43

I'm curious what the hell `git rebase` was trying to do
The shit that was doing I have never seen before
And it was cursed as fuck

=== @connorjclark (discord: connorclark) 08/04/2023 00:00

> I can't do more than put the branch back from the last time it was pushed to GH

here
https://github.com/ArmageddonGames/ZQuestClassic/compare/music-backup

=== @connorjclark (discord: connorclark) 08/06/2023 17:25

@ Moosh let's get into VC sometime soon and fix this rebase
As for the replay aspect, we can land to main first and I'll get to it later.

=== @ Moosh 08/06/2023 17:27

Sounds good. I've kinda been putting it off past couple days but should be free tonight whenever works best for you

=== @ Moosh 08/07/2023 04:13

So for fixing the rebase I imagine what I can do is: 
- Pull from main to music_backup to get it up to date
- Pull from main to musicreworknew to do the same
- Copy src from musicreworknew to music_backup so it catches the differences
- Make a new commit

There's probably a fancier way but I assume that should work right? New one would be just one commit ahead of the backup had I not donked it all up

=== @EmilyV99 (discord: Emily) 08/07/2023 04:17

sounds probably sane

=== @connorjclark (discord: connorclark) 08/07/2023 04:20

No, don't do that. Let me help with reflog
Let's not lose the history you had

=== @ Moosh 08/07/2023 04:22

I mean that's the idea right? If I work on the backup I can keep the history. But if you wanna walk me through the saner and less tedious way that's cool

=== @connorjclark (discord: connorclark) 08/07/2023 04:23

Oh you just want to redo your one commit not in backup

=== @ Moosh 08/07/2023 04:23

yeah

=== @connorjclark (discord: connorclark) 08/07/2023 04:24

get in vc?

=== @ Moosh 08/07/2023 04:24

will do, one sec

=== @ Moosh 08/07/2023 17:16

One thing I'd kinda forgotten amidst the git panic, I've still got some errors building on ubuntu that I'm not able to figure out the meaning of. 
```2023-08-07T05:48:58.1075398Z [677/839] Linking CXX executable RelWithDebInfo/zlauncher
2023-08-07T05:48:58.1256714Z /usr/bin/ld: /usr/bin/ld: DWARF error: invalid or unhandled FORM value: 0x23
2023-08-07T05:48:58.1257764Z RelWithDebInfo/libzcbase.a(zsys.cpp.o): in function `temp_name(char*)':
2023-08-07T05:48:58.1258734Z zsys.cpp:(.text+0x581): warning: the use of `tmpnam' is dangerous, better use `mkstemp'```

https://cdn.discordapp.com/attachments/1127118998304198737/1138158965834911814/message.txt?ex=65e60223&is=65d38d23&hm=ef7241a4f2c993049f9c8b5b83d2056a3c973ec6c1b23ad240a4974318e508ec&
```2023-08-07T05:49:03.3188465Z [837/839] Linking CXX executable RelWithDebInfo/zscript
2023-08-07T05:49:03.3189832Z /usr/bin/ld: /usr/bin/ld: DWARF error: invalid or unhandled FORM value: 0x23
2023-08-07T05:49:03.3191303Z CMakeFiles/zscript.dir/RelWithDebInfo/src/parser/parser.cpp.o: in function `compile(std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> >)':
2023-08-07T05:49:03.3193779Z parser.cpp:(.text+0x55d1): warning: the use of `tmpnam' is dangerous, better use `mkstemp'
2023-08-07T05:49:03.3194922Z ninja: build stopped: cannot make progress due to previous errors.
2023-08-07T05:49:03.3232283Z ##[error]Process completed with exit code 1.```

=== @ Moosh 08/07/2023 17:22

The two DWARF errors don't seem like something I did. No idea what temp_name is. clang one mentions zcsound which throws some red flags but good lord I don't know what I'm looking at here.

=== @connorjclark (discord: connorclark) 08/07/2023 18:45

Not sure yet.
https://github.com/ArmageddonGames/ZQuestClassic/compare/main...music-backup#diff-93d22426674c1a799f90a3bdefad985a45ec70d65a178e8f0ada55a37aa2b177R336  doesn't ADJUSTSFX take args?

=== @connorjclark (discord: connorclark) 08/07/2023 18:51

> /usr/bin/ld: RelWithDebInfo/libzcbase.a(util.cpp.o): warning: relocation against `_ZNSt17_Function_handlerIFbcENSt8__detail12_CharMatcherINSt7__cxx1112regex_traitsIcEELb0ELb1EEEE9_M_invokeERKSt9_Any_dataOc' in read-only section `.text._ZNSt8__detail9_CompilerINSt7__cxx1112regex_traitsIcEEE22_M_insert_char_matcherILb0ELb1EEEvv[_ZNSt8__detail9_CompilerINSt7__cxx1112regex_traitsIcEEE22_M_insert_char_matcherILb0ELb1EEEvv]'
> /usr/bin/ld: RelWithDebInfo/libfmt.a(format.cc.o): relocation R_X86_64_PC32 against symbol `_ZTIN3fmt3v1012format_errorE' can not be used when making a shared object; recompile with -fPIC
> /usr/bin/ld: final link failed: bad value
No idea. I'll try building on my virtual ubuntu later.

=== @connorjclark (discord: connorclark) 08/08/2023 03:48

Bisect to this commit: https://github.com/connorjclark/ZeldaClassic/commit/d03c55c0dc6ce22087352026a3fecadef78a16af

=== @ Moosh 08/08/2023 03:59

okay that's further back than I remember, and good to know

=== @connorjclark (discord: connorclark) 08/08/2023 04:05

I narrowed it down to usage of `vbound`.

=== @ Moosh 08/08/2023 04:07

Is it the casting from uint64_t to int32_t perhaps?

=== @connorjclark (discord: connorclark) 08/08/2023 04:08

no, just `vbound(1,1,1)` fails the build

=== @ Moosh 08/08/2023 04:08

There was a bit where I needed to do some calculations with large numbers and didn't want the intermediary values overflowing
oh

=== @connorjclark (discord: connorclark) 08/08/2023 04:08

can you use `std::clamp` instead (same arg order)
just include `<algorithm>`

=== @ Moosh 08/08/2023 04:09

Is this a DLL thing?
ZC uses vbound all over
But this might be the first time it was used in zcmusic

=== @connorjclark (discord: connorclark) 08/08/2023 04:14

it's not something i understand yet
https://github.com/fmtlib/fmt/issues/548
it's the same error here
using vbound for first time here, has made the linker on linux now try to do something different with `libfmt` (I think because vbound is from the util.o object, and that uses various thing from fmt, it "activated" something unrelated to your direct usage of vbound)
I don't want to muss with the -fPIC thing it suggests
if the alternative is to simply use std::clamp

=== @ Moosh 08/13/2023 08:34

@connorjclark (discord: connorclark) Assume it's cool if I merge this now?

=== @connorjclark (discord: connorclark) 08/13/2023 08:39

sure

=== @connorjclark (discord: connorclark) 08/13/2023 09:27

Are you aware that the way you merged it to main squashed everything and lost all your history?
Would you like me to fix that?

=== @ Moosh 08/13/2023 09:28

Yes please
I tried to do not that and it wouldn't let me and I'm not sure why but figured there was a good reason

=== @connorjclark (discord: connorclark) 08/13/2023 09:30

In the PR interface, the merge button also gave a option on the side to select the merge type - Squash happens to be the default, but you wanted "rebase and merge"
I'll fix and force push

=== @ Moosh 08/13/2023 09:30

Yeah that's what I tried at first
It gave me "github merge attempt failed this branch can't be rebased"
Do I need to do another pr to remerge main with my branch before doing that? It said there were no merge conflicts so I assumed it would do that automatically
And I also assumed the squash would at least combine my commit history. Looked up what squash does and it _sounded_ like it would. But it sure didn't

=== @connorjclark (discord: connorclark) 08/13/2023 09:37

Squash explicitly does not maintain history. Only a merge commit or a rebase would
Github PR could not resolve the rebase for you because there were conflicts needing manual intervention

=== @ Moosh 08/13/2023 09:38

ah

=== @connorjclark (discord: connorclark) 08/13/2023 09:38

I took your branch, merged main into it (the existing merge commit in the branch from earlier today made a rebase too time consuming so I just did a second merge commit), then force pushed to main

=== @ Moosh 08/13/2023 09:38

but it...didn't prompt me to intervene?

=== @connorjclark (discord: connorclark) 08/13/2023 09:39

if you have already pulled main locally, you should run `git fetch ; git reset --hard origin/main` on main branch

=== @connorjclark (discord: connorclark) 08/13/2023 09:40

(replying to @ Moosh "but it...didn't prompt me to‚Ä¶"): You said the "rebase and merge" option failed. It failed because it had conflicts. GH UI does not let you fix that, it's a git only operation. If I'm just repeating myself it's cuz I'm lost why you're lost üòõ

=== @connorjclark (discord: connorclark) 08/13/2023 09:41

"rebase and merge" will only work if it's a clean change, no conflicts. long running branches usually aren't unless you rebase often

=== @ Moosh 08/13/2023 09:41

I'm lost because I just did this yesterday and it did tell me I had merge conflicts and it did prompt me to fix them in git

=== @connorjclark (discord: connorclark) 08/13/2023 09:41

When you merged main into your branch?

=== @ Moosh 08/13/2023 09:41

yeah
Is there something different about doing it the other way around?

=== @connorjclark (discord: connorclark) 08/13/2023 09:42

Yeah- you did a merge commit. With a single merge conflcit, which I guess the website can let you handle. It's not gonna do a rebase workflow though.
I think this is the confusion -

=== @connorjclark (discord: connorclark) 08/13/2023 09:43

the main branch has been configured to not allow "Merge" option - only "Rebase and Merge" or "Squash"

When you made a PR for main _onto_ your branch, you saw the third option - "Merge" - and used that. When you had a PR for putting to main, "Rebase and Merge" is what you maybe tried and it failed b/c rebase conflicts.

=== @ Moosh 08/13/2023 09:44

...that'd do it

=== @connorjclark (discord: connorclark) 08/13/2023 09:44

The first PR you did - did you think that was a quicker way to do a rebase?

=== @ Moosh 08/13/2023 09:44

Well I'll learn from my mistakes, eventually, hopefully

=== @connorjclark (discord: connorclark) 08/13/2023 09:45

it's all good

=== @ Moosh 08/13/2023 09:46

I did it because Emily said that's how she does it and given how the last few times I've tried rebase went I was feeling ready to try her way üòõ
Turns out pull requests have some stuff that can confuse me too

=== @connorjclark (discord: connorclark) 08/13/2023 09:47

As you know I think rebase is superior and helps with a better git history. But if you are wanting to do merge commits - that's fine. But you 100% don't need a PR to do that.

You git fetch.

Then you run `git merge origin/main` in your branch.

=== @connorjclark (discord: connorclark) 08/13/2023 09:49

I'm sure you'd rather fix conflicts in your editor than in GitHub UI lol

=== @ Moosh 08/13/2023 09:50

Very much so yeah.

=== @connorjclark (discord: connorclark) 08/13/2023 09:53

Thinking about the changelog - I was thinking of adding a way to (in the changelog script) group certain commits together and give them a larger paragraph explainer, followed by an eumeration of specific one-line changes. so basically all the commits just merged from your branch:

> # Music stuff galore!
> .... as long of an explanation as you want about the new feature ... script examples .... etc
>  ...
>  ....
>  ......
>  
> Commits:
> 93ec63eea docs(zscript): webdocs for new Audio features
> e96efb263 fix(zscript): rename expanded Audio->PlaySound() function to PlaySoundEx()
> 2fb00213c fix: fademiddleframes in CrossfadeEnhancedMusic()
> 679b79c50 feat(zscript): Split MusicRefresh into MusicRefresh and MusicRefreshFlags[]
> 57c6aa58b fix(zscript): CrossfadeEnhancedMusic() now keeps playing old music on failure and returns a proper result
> 9274b2990 fix: changed how crossfades interact with F1/F4
> 589df961c docs(zscript): docs for Crossfades and MusicRefresh

=== @connorjclark (discord: connorclark) 08/13/2023 09:54

b/c currently, these things will get spread out amongst the changelog, and it will be far less clear that all this work is related
idk if worth the trouble to automate it
could you (between now and next alpha...) right something for all this stuffs for the changelog? no rush

=== @ Moosh 08/13/2023 09:56

Sure thing

=== @ Moosh 08/13/2023 10:45

Ah the joy of just casually finding stupid bugs while writing up example code ü§¶

=== @ Moosh 08/13/2023 10:50

Okay here's what I've got so far:

# Music and sound stuff galore!
- Enhanced music using MP3 and OGG can now be given loop points and crossfade timings in the DMap editor. The music will then loop at those points and fade in and out with those timings.
- Scripts have new ways to interact with enhanced music: GetMusicPos(), SetMusicPos(), SetMusicSpeed(), GetMusicLength(), and SetMusicLoop()
- Scripts can also play music with crossfades using CrossfadeEnhancedMusic().
- Scripts can play sounds with different, volume, pan, frequency, and looping with PlaySoundEx().
```// Here's a script that turns a SFX into an instrument by playing it back at different frequencies
ffc script Piano
{
    void run()
    {
        // Frequency values and keys for different notes
        int hz[] =   {16350L, 17320L, 18350L, 19450L, 20600L, 21830L, 23120L, 24500L, 25960L, 27500L, 29140L, 30870L, 32700L};
        int keys[] = {KEY_Z,  KEY_S,  KEY_X,  KEY_D,  KEY_C,  KEY_V,  KEY_G,  KEY_B,  KEY_H,  KEY_N,  KEY_J,  KEY_M,  KEY_COMMA};
        int sz = SizeOfArray(hz);
        int sfx = Rand(60); // Pick a random SFX
        while(true)
        {
            for(int i=0; i<sz; ++i)
            {
                if(Input->KeyPress[keys[i]])
                {
                    int j = (hz[i]/hz[0]) * 22050L; // Multiply by the sample rate of most default SFX
                    Audio->PlaySoundEx(sfx, 100, 0, j);
                }
            }
            
            Waitframe();
        }
    }
}```
- Scripts can also adjust sounds mid playback with AdjustSound() and track their completion with GetSoundCompletion().
```ffc script AdjustSound
{
    void run()
    {
        // Play the sound panned to the left at half volume
        Audio->PlaySoundEx(SFX_SECRET, 50, -128, -1, false);
        // Run until the sound has stopped playing
        while(Audio->GetSoundCompletion(SFX_SECRET)!=-1)
        {
            int pct = Audio->GetSoundCompletion(SFX_SECRET) / 100;
            // Pan the sound to the right while increasing in volume
            Audio->AdjustSound(SFX_SECRET, Lerp(50, 100, pct), Lerp(-128, 127, pct), -1, false);
            Waitframe();
        }
    }
}```
- Scripts can set MusicRefresh to prevent music from resetting when changing screens
```Audio->PlayEnhancedMusic("ExampleSong.ogg", 0);
Audio->MusicRefresh = MR_DMAP; // Music will refresh on changing DMap
Audio->MusicRefreshFlags[MRF_REVERT] = true; // Music refresh with revert to default behavior afterwards```
- AdjustMusicVolume() and AdjustSFXVolume() have been reworked to be a multiplier capped at the user's volume settings, rather than overwriting those settings.

=== @EmilyV99 (discord: Emily) 08/13/2023 11:46

(replying to @connorjclark (discord: connorclark) "Thinking about the changelog‚Ä¶"): > I was thinking of adding a way to (in the changelog script) group certain commits together and give them a larger paragraph explainer, followed by an eumeration of specific one-line changes.
YES PLEASE, maybe we can create a simple syntax for automation?
Like maybe instead of `fix(zc)` we do `fix[subscreen]`, and the square brackets tell it "This is a custom label to group under"?

=== @connorjclark (discord: connorclark) 08/13/2023 20:32

@ Moosh added - feel free to modify `scripts/changelog_overrides/2023_08_13_music.md` further.

=== @ Moosh 08/13/2023 21:35

(replying to @connorjclark (discord: connorclark) "@ Moosh added -‚Ä¶"): The new build seems to only have the first half of my changelog (was too big for Discord to fit in one message)

=== @connorjclark (discord: connorclark) 08/13/2023 21:39

Oh, I didn't include the rest.
I copied the first message.
And assumed that was all.

=== @ Moosh 08/13/2023 21:41

yeah sorry. should've warned about that

=== @connorjclark (discord: connorclark) 08/13/2023 21:42

fixing now

=== @connorjclark (discord: connorclark) 08/13/2023 21:52

good?

=== @ Moosh 08/13/2023 21:56

Seems good

=== @connorjclark (discord: connorclark) 08/13/2023 23:36

Can you provide a test file so I could have something to test the web implementation with

=== @ Moosh 08/14/2023 08:11

Working on that now. Also found another really stupid bug, should be a one line fix but I'm bummed that it slipped past me. When DMap music does a crossfade, it doesn't set its loop point ü§¶

=== @ Moosh 08/14/2023 10:02

sorry for the delay. Here's a test file and the included music. Scroll down to progress through the various test scripts. `Loop/XFade` and `MusicRefresh` both require scrolling left/right. The former should crossfade music on each transition and the latter only on the fourth screen. Also the volume one responds to the mouse, which I'm realizing IDK if actually works in the web version. Lemme update that so it respond's to Link's position as well
https://cdn.discordapp.com/attachments/1127118998304198737/1140586233739874324/MusicSoundTest.zip?ex=65e59c35&is=65d32735&hm=763cdea6f468eeb8620e1179f785ab762977fb6fe7a485e6194ac018fe8cd4f4&

=== @ Moosh 08/14/2023 10:07


https://cdn.discordapp.com/attachments/1127118998304198737/1140587457629405224/MusicSoundTest.zip?ex=65e59d58&is=65d32858&hm=04e352727e9a2655fbdfbf09bc0ffa12bc67ec1f9672ec6379133b36b4cb7f56&

=== @connorjclark (discord: connorclark) 08/19/2023 03:38

i love this test quest
should put a video of this up on YT for the next alpha release notes

=== @connorjclark (discord: connorclark) 08/19/2023 04:33

```cpp
void FFScript::do_get_music_position()
{
    int32_t pos = replay_get_state(ReplayStateType::MusicPosition, [](){
        return zcmusic_get_curpos(zcmusic);
    });
    set_register(sarg1, pos);
}
```

finished the replay part of this. usage looks like this.
only needed to do it for music and sfx position i believe
```cpp
int replay_get_state(ReplayStateType state_type, int fn())
{
    int value = 0;
    if (replay_is_replaying())
    {
        value = 0;
        while (replay_log_current_state_index < replay_log.size() && replay_log[replay_log_current_state_index]->frame == frame_count)
        {
            size_t i = replay_log_current_state_index;
            replay_log_current_state_index += 1;

            if (replay_log[i]->type == TypeState)
            {
                auto state_replay_step = static_cast<StateReplayStep *>(replay_log[i].get());
                if (state_replay_step->state_type == state_type)
                    value = state_replay_step->value;
                else
                    fail_replay(fmt::format("state desync: {}", (int)state_type));
                break;
            }
        }
    }
    else
    {
        value = fn();
    }

    if (replay_is_recording())
    {
        record_log.push_back(std::make_shared<StateReplayStep>(frame_count, state_type, value));
    }

    return value;
}
```
It will record every single "state" call and play it back exactly.

=== @ Moosh 08/19/2023 05:01

Nice! Cool seeing how this works
And yeah, those should be the only cases where it's needed
