## ❌Layered Lock Blocks Don't Work by Default (#1111)
@EmilyV99 (discord: Emily) opened this issue on 10/13/2021
Status: fixed
Tags: 
Source: #old-bug-reports https://discord.com/channels/876899628556091432/897976431634677841


=== @EmilyV99 (discord: Emily) 10/13/2021 22:37

Moosh found this....
so
```cpp
#include "std.zh"
combodata script TorchGoOut
{
    void run()
    {
        //printf("RAN TORCHGOOUT\n");
        int counter = this->Attributes[0];
        int offset = this->Attributes[1];
        printf("0 - %d, %d\n", counter, offset);
        while(true)
        {
            printf("1\n");
            Screen->DrawInteger(6, this->X, this->Y, FONT_Z3SMALL, 0x01, 0x0F, -1, -1, counter, 0, 128);
            unless(Screen->State[ST_SECRET])
            {
                if(counter)
                    --counter;
                else
                {
                    printf("2\n");
                    //counter = this->Attributes[0];
                    Screen->ComboF[this->Pos()] = 95;
                    Screen->ComboD[this->Pos()] += offset;
                }
            }
            Waitframe();
        }
    }
}```

https://cdn.discordapp.com/attachments/897976431634677841/897976546902569030/torch.qst?ex=65e8f054&is=65d67b54&hm=441143312c497e05c782dd672e267108309c94b9f2d4869b51bd2712ed7a886a&
The first time the script runs, the first trace traces `0 - 30, 1`
then `1` quite a number of times
then `2`
and the combo changes
that combo cycles back into the original combo
and then the script, starting over, traces `0 - 0, 0`.
then `1` and `2` on the same frame

![image](https://cdn.discordapp.com/attachments/897976431634677841/897977006090772520/unknown.png?ex=65e8f0c1&is=65d67bc1&hm=1a107549a0adbb59daf0310eb2de25223972742d8e9bd5b1001b3a4f8dce68cc&)
and then `1` followed by stack errors
@ DeletedUser @arceusplayer11 (discord: Deedee) something is VERY broken with combodata scripts, here.

=== @ mitchfork 10/13/2021 22:48

This smells similar to some bugs I had found with combodata scripts months ago where InitD values would reset (permanently) when you left the screen and required a hard close/open
dunno if that information would help find what's going on

=== @ZoriaRPG (discord: Timelord) 10/13/2021 23:57

Der
if you are cycling cobos

=== @ZoriaRPG (discord: Timelord) 10/13/2021 23:59

as soon as you change the combo the scrpt is NULL an may be undeined
alpha status or a reason

=== @ZoriaRPG (discord: Timelord) 10/14/2021 00:00

so I wold exect that exact error

=== @ZoriaRPG (discord: Timelord) 10/14/2021 00:02

what needs to happen s to exec a new combo script on cycle
they were not designed to carry script data across to a cycle to or a next

=== @ZoriaRPG (discord: Timelord) 10/14/2021 00:05

need t clear cobo script
data (all)

=== @ZoriaRPG (discord: Timelord) 10/14/2021 00:10

and then load ay script o THAT ob b first clearin ha data **and/or  ** (aps or llinjcvpp )he prior onel

=== @EmilyV99 (discord: Emily) 10/14/2021 00:10

so, cycling isn't clearing anything?

=== @ZoriaRPG (discord: Timelord) 10/14/2021 00:10

Npe

=== @EmilyV99 (discord: Emily) 10/14/2021 00:10

(The combo it's set to has no script data set up whatsoever, so a non-scripted combo cycling TO a scripted combo)

=== @ZoriaRPG (discord: Timelord) 10/14/2021 00:14

cobdata scri[voidr(){ts arev ipleentedin theirstasicfort an rvr intene fr thd
ee reettinerithr

=== @EmilyV99 (discord: Emily) 10/14/2021 00:15

. . .
english?

=== @arceusplayer11 (discord: Deedee) 10/14/2021 00:25

worlds first martian, we've had contact with alien life for the first time!
Do you come in pieces? 🙃

=== @ Moosh 10/14/2021 01:34

So since this is apparently a hot mess, should I assume it's unsafe to use combo scripts on combos that can cycle at all? I have one in my quest currently and while it seems to be working fine, who knows what could be subject to change

=== @ Moosh 10/22/2021 02:50

A week later coming back to my question here: is it safe to use combodata scripts at all? Happening upon another situation where it would be convenient for me to use one and while it doesn't require changing back to a combo with a script, I'm worried about whatever it's doing here.

=== @EmilyV99 (discord: Emily) 10/22/2021 02:52

Feel free to try it and see if it has issues
if it doesn't, good; if it does, more to report

=== @ Moosh 10/22/2021 02:54

Alright will do. My concern is more whether this whole situation is feasible to fix. Or is it a case of poor foresight that could potentially get deprecated

=== @EmilyV99 (discord: Emily) 10/22/2021 02:55

Oh, it'll be fixed

=== @ Moosh 10/22/2021 02:56

Alright cool

=== @EmilyV99 (discord: Emily) 10/22/2021 02:56

just a matter of taking the time to dig into fuckery

=== @ Moosh 10/22/2021 02:56

Yeah perfectly understandable

=== @EmilyV99 (discord: Emily) 10/22/2021 02:56

things like new dialog design are much easier on the stress/mental energy
so, end up doing a lot more of that than other stuff

=== @ Moosh 10/22/2021 02:58

I can certainly relate to that
I've been avoiding enemy design like the plague lately
And doing every other system I possibly can first 🤣

=== @EmilyV99 (discord: Emily) 10/22/2021 02:59

I just finished `rowSpan`/`colSpan` for the new dialog system for grids
which is kinda vital for a lot of things, like for instance,
![image](https://cdn.discordapp.com/attachments/897976431634677841/900941523024248913/unknown.png?ex=65ea7f2d&is=65d80a2d&hm=e9a453d60b60bdf55039e83494f42a98d461e111e2dee0d66ebd731302edb270&)
To convert this (old dialog screenshot), I am gonna want the checkbox to `colSpan = 2`, since there's only one thing in that row, but 2 in every other row
(Text on the checkbox is actually *part* of the checkbox; the text on textfields/dropdowns is a separate widget)

=== @ Moosh 10/22/2021 03:16

```combodata script Barrel{
    void run(){
        mapdata thislayer = Game->LoadTempScreen(this->Layer());
        while(thislayer->ComboF[this->Pos]==0){
            Screen->FastTile(6, this->PosX(), this->PosY(), Link->Tile, 6, 128);
            Waitframe();
        }
        int pos = this->Pos;
        if(pos%16>0&&pos%16<15&&pos>15&&pos<160){
            thislayer->ComboD[this->Pos] = 0;
            Quit();
        }
    }
}```
Noticing another issue here which may just be the same one, when the combo sets its own ComboD to 0, the script thinks it's position is 0,0 for one frame afterwards. Tried sticking in a Quit() to fix this, but it occurs to me combodata scripts might not be able to do that by nature of how they work

=== @EmilyV99 (discord: Emily) 10/22/2021 03:21

They should quit when they quit, unless writing the `ComboD` auto-quits, which frankly it should

=== @ Orithan 10/22/2021 07:33

An instance of combo scripts being ???
https://discord.com/channels/876899628556091432/878114935396257852/901002641235140639
Might be related to this

=== @ Moosh 10/22/2021 08:28

Going off your description that sounds like intended behavior. Switching ComboD resets combo scripts and this is intentional. What isn't intentional is the weird corruption that happens when it tries to run a new one

=== @ Orithan 10/22/2021 09:01

The combo at the original position continues running that script if I push the combo back into place
Like its not that the script gets killed at that position, it gets suspended

=== @ Orithan 10/23/2021 05:18

A workaround to the whole "cannot cycle combo" thing can be done here:
```
Screen->FastCombo(this->Layer(), this->X, this->Y, this->ID+1, Screen->ComboC[this->Pos], OP_OPAQUE); //Draw the graphic of the next combo in the list to signify its been used, since combo cycling is not safe to do here.
```
This only works to display the next combo's graphic, so no extra functions

=== @ Orithan 10/23/2021 05:32

--==ZC CRASH==--
ZC will crash if you push a combo with another script over a combo where the first script was. The game will stop playing sound and hang for a little bit before it crashes.
Allegro\.log traced the following leading up to the crash:
```
Combodata script 2 (Dummy): Invalid ZASM command 6213 reached
Combodata script 2 (Dummy): Division by 0 Err: InvPower() exponent divisor cannot be 0!!
```

=== @ Orithan 10/23/2021 05:33

This I presume is the result of the game not clearing the first combo's script and then attempting to run a second script afterwards.
The more I think about it the more cursed combo scripts are...

=== @EmilyV99 (discord: Emily) 10/23/2021 05:37

uhg why were they implemented this poorly?

=== @ Orithan 10/23/2021 05:38

Does ZC really not have a way of telling when a scripted combo does not exist on x location anymore and then clearing the script before the new combo is registered by the engine?
Because this is consistent with how moving a combo with a script appears to suspend said script until the script combo returns to the position. Hooray for janky workarounds.

=== @EmilyV99 (discord: Emily) 10/23/2021 06:00

from the looks of this, @ DeletedUser just completely failed to add most of the checks necessary for combo scripts to function properly

=== @ZoriaRPG (discord: Timelord) 10/23/2021 06:25

I didn't think about push flags. I testes the most common stuff with non-changing combos and tested writing to the grid by script. I fully anticipated there to be issues that would need beta phase resolution.

=== @ZoriaRPG (discord: Timelord) 10/23/2021 06:26

Until recently combo scripts weren't being used by anyone and thus nested logic for these interactions wasn't being tested.

=== @ZoriaRPG (discord: Timelord) 10/23/2021 06:28

Note that push flags are something I would always have missed as I design them using negative layers and they would always replace blank space.

=== @ZoriaRPG (discord: Timelord) 10/23/2021 06:29

E.g., a pressure plate would be on layer -2 and the block on layer 0.
Thus, both scripts would be running.
One would never replace the other.

=== @ZoriaRPG (discord: Timelord) 10/23/2021 06:32

IDK how I'd uncouple the script on a combo when you legitimately replace it with a push flags, or how you'd safely continue running a combo script on anything in motion.
Every script is linked to grid position and layer.
This includes its stack and its refinfo.

=== @ Moosh 10/23/2021 06:33

The script that started this whole thread was a simple "count down and then write to the grid" type, so I'm not sure what caused it to go fucky if grid writes should be cleaning everything up properly

=== @ZoriaRPG (discord: Timelord) 10/23/2021 06:34

Writing ComboD should stop scripts running at that pos.
If not, then either I  forgot to commit a change, I missed something, or it is a timing problem.

=== @ZoriaRPG (discord: Timelord) 10/23/2021 06:36

IIRC I intended to make descriptions a byte array and not a flagset, to allow uncoupling states.

=== @ZoriaRPG (discord: Timelord) 10/23/2021 06:37

*doscript

=== @EmilyV99 (discord: Emily) 10/23/2021 07:26

I think it's clearing the `doscript`, but not the `refInfo`
as it "suspended, but started back up when the combo changed back to the original combo"
that indicates to me that `pc` wasn't cleared, even though `doscript` was

=== @EmilyV99 (discord: Emily) 10/23/2021 07:28

Having a moving block run a combo script seems like it would be a separate feature to implement

=== @EmilyV99 (discord: Emily) 10/23/2021 07:29

and, I'd expect pushing a block onto a new position to end the script being run by whatever was on the position, replacing it with any script from the block

=== @ Orithan 10/23/2021 08:32

Do combos tied to FFCs inherit any of the new combo properties?

=== @EmilyV99 (discord: Emily) 10/23/2021 08:46

Combo properties are tied to the combo type
so if the combo type functions on FFCs, it will have it's properties

=== @ Orithan 10/23/2021 08:48

Does it keep its script and attributes?

=== @EmilyV99 (discord: Emily) 10/23/2021 09:11

combo scripts don't run on ffcs
...because, you have ffc scripts

=== @ZoriaRPG (discord: Timelord) 10/23/2021 09:15

(replying to @EmilyV99 (discord: Emily) "Having a moving block run a c…"): ja
(replying to @EmilyV99 (discord: Emily) "and, I'd expect pushing a blo…"): and absolutely

=== @ZoriaRPG (discord: Timelord) 10/23/2021 09:17

The closest to this that I tested was a  ombo script that acted as a trigger when a block on another layer was in its pos.
I never intended for moving block sprites to run their combo scripts
And I never tested what happens if a moving block overwrites a combo running a script as none of my setups ever did that.
Heck , I never do thqt
I had that in 1.9x, but not in anything after layers existed
Moving blocks need to suspend and exit any script over which they are pushed and that is its own thing that needs to occur.
The script for a block should end when you push it as its. Grid pos changes
What is happening here is that the script and its refinfo are being corrupted with lithosphere of its destination.
...
I THINK I need to disable autocorrect
*with the refinfo and stack of its destination

=== @ZoriaRPG (discord: Timelord) 10/23/2021 09:23

Technically if you put a script on a block it would start anew with every positional change of the block.

=== @ZoriaRPG (discord: Timelord) 10/23/2021 09:25

The engine reads the Cambodia for script ID and if that pos had doscript&1 then it will start e exuding that script with the refinfo of any script that was already running in that pos, on that layer.

=== @ZoriaRPG (discord: Timelord) 10/23/2021 09:26

I had never even considered giving a movingblock a script, as having designed this, I know that it would not work as the combo script engine works based on grid I'd and layer.

=== @ZoriaRPG (discord: Timelord) 10/23/2021 09:28

I don't know a good way around simply aborting scripts with regard  to moving blocks and changing combos. You could certainly change the 0/1 to. Quad system where 2 is for a slow suspension like item scripts and 3 is for restart status.
It would take some rewrites.

=== @ZoriaRPG (discord: Timelord) 10/23/2021 09:29

Right not the doscript is bit shifted as one byte where the shift is the layer

=== @ZoriaRPG (discord: Timelord) 10/23/2021 09:30

Changing it to do anything else will require a 2d byte (or 4b bitfield) array instead.

=== @EmilyV99 (discord: Emily) 10/23/2021 10:51

So, I'm attempting to do several things at once here
1. I'm adding combo reset cleanup code to `modify_combo_postroutine`, so anywhere that's called will automatically handle cleaning up combo scripts
2. I'm adding specific script resetting code to `movingblock`
....and the big one, 3. Trying to add layer 1+2 pushblocks

=== @ZoriaRPG (discord: Timelord) 10/23/2021 11:10

Errr...enjoy?
I would do those one at a time, but to do as you will shall be the whole of the law.

=== @EmilyV99 (discord: Emily) 10/23/2021 11:12


![image](https://cdn.discordapp.com/attachments/897976431634677841/901427736705380392/LayerPushBlock.mp4?ex=65ec4400&is=65d9cf00&hm=a1a599d01aeb112037c70c539b674d79bb9c686f207bd60767001a4e92abb3f2&)
bwahahahaha
That was way too easy

=== @ZoriaRPG (discord: Timelord) 10/23/2021 11:12

Myself, I am going to enjoy my Shabbat.
And my wine, and my far, far reduced stress levels; and play some Famicom and Atari games ere I pass out in a stinking mess.

=== @EmilyV99 (discord: Emily) 10/23/2021 11:14

So, to explain what I've done here
`Quest->Options->Combos->"Pushblocks Work on Layer 1 and 2"`
when you push a pushblock on a layer, it places the undercombo specified on that layerscreen in the position on that layer (thus how these two blocks have different undercombos)

=== @ZoriaRPG (discord: Timelord) 10/23/2021 11:15

Clearly one component  was easy to correct.
Oh
That wasn't related to the bug or to cdata scripts?

=== @EmilyV99 (discord: Emily) 10/23/2021 11:16

If multiple blocks are in the *same position* but on *different layers*, the highest layer block will be pushed first (as if pushing it off of the stack of blocks)
I had to work with blocks anyway, and wanted to do this while I was thinking about it
Hopefully the script issues will also be fixed

=== @ZoriaRPG (discord: Timelord) 10/23/2021 11:16

Blocks on layers is trivial. I didn't add that as I was working through 400 bug reports.

=== @EmilyV99 (discord: Emily) 10/23/2021 11:18

@ Moosh @ Orithan See if the combo script stuff is better in this. Also enjoy the pushblocks on layers 1+2.
https://cdn.discordapp.com/attachments/897976431634677841/901429320034164846/buildpack.zip?ex=65ec4579&is=65d9d079&hm=ca602056be239da9a74eef2b486435f9f420923957c41c2c43e27c3aa3de9881&

=== @ZoriaRPG (discord: Timelord) 10/23/2021 11:20

I put a moratorium  on new feats including shyte I would use as I wanted to solve issues ere I add any more crud to this thing. Anyway, have fun. This isn't magical and it solves nothing,but it compounds the existing  issue as this can now occur across three layers instead of only one. I strongly advise fixing the crashes and related issues ere compounding them.

=== @EmilyV99 (discord: Emily) 10/23/2021 11:20

Well, hopefully I fixed the issues as well
blocks now call `FFCore.reset_combo_script(blockLayer, combopos);` when altering a combo

=== @ZoriaRPG (discord: Timelord) 10/23/2021 11:21

I hope likewise, but I suspect  that combodata scripts need more than two run conditions.

=== @EmilyV99 (discord: Emily) 10/23/2021 11:21

....I didn't handle cycling, unless that calls `combo_modify_postroutine`. Gotta check that next.

=== @ZoriaRPG (discord: Timelord) 10/23/2021 11:21

Same as item data they need a cool down reset frame
I NEVER fekked with cycling. I never use it.

=== @EmilyV99 (discord: Emily) 10/23/2021 11:22

oh, those call the postroutine
so they should be handled
```cpp
for(int32_t i=0; i<176; i++)
{
    if(newdata[i]==-1)
        continue;
        
    screen_combo_modify_preroutine(tmpscr,i);
    tmpscr->data[i]=newdata[i];
    if(newcset[i]>-1)
        tmpscr->cset[i]=newcset[i];
    screen_combo_modify_postroutine(tmpscr,i);
    
    newdata[i]=-1;
    newcset[i]=-1;
}
```

=== @ZoriaRPG (discord: Timelord) 10/23/2021 11:23

I don't create 'modern' quests. Either I am making something absurd and experimental, or I am making  a Z1 style quest, or some sort of tiny social commentary.

=== @ZoriaRPG (discord: Timelord) 10/23/2021 11:24

I frankly don't recall how combo cycling works or where it lives. I have never needed to touch it and I don't personally use ite.

=== @ZoriaRPG (discord: Timelord) 10/23/2021 11:25

If you recall, I don't even use animated combos for water.

=== @ZoriaRPG (discord: Timelord) 10/23/2021 11:27

I never intended this feature to be used for such a comple me hanic and I'd why I added it other than DD saying we should have it.

=== @ZoriaRPG (discord: Timelord) 10/23/2021 11:28

I regret adding it at all.
It was on the DD todo list.

=== @EmilyV99 (discord: Emily) 10/23/2021 11:35

hmm, so it *mostly* seems fixed
only one problem, Moosh's test quest ends up running the script an extra time in the frame without the variables initialized still.... but it's no longer throwing a bunch of random errors.
and, that was because it was modifying *itself*; so when it reset its' own `do_script`, it just kept running
so now, when it's combo value is changed, it exits the script
which seems to make the test quest work perfectly
...don't have a test quest for @ Orithan 's issues

https://cdn.discordapp.com/attachments/897976431634677841/901434325982142484/buildpack.zip?ex=65ec4a23&is=65d9d523&hm=490b3db8ae01adb3c7d7df14379c43f85d42a82ab0325800daf0981a0ee3e777&

=== @arceusplayer11 (discord: Deedee) 10/23/2021 17:50

(replying to @EmilyV99 (discord: Emily) ""): holy shit layer 1/2 pushblocks

=== @arceusplayer11 (discord: Deedee) 10/23/2021 17:55

(replying to @EmilyV99 (discord: Emily) "2. I'm adding specific script…"): I want to attempt to have a script continue running the comboscript when the block is pushed (which would probably be carrying over the script into a pushblock slot or something, need to figure out how combo scripts work currently) and then let the script continue running as is at the new position (with flags of course to enable or disable this behavior)

=== @arceusplayer11 (discord: Deedee) 10/23/2021 17:56

Whether it's actually feasible or not is another matter, but I feel like this feature is what people would *expect* out of a combo script. It's highly unfortunate how buggy and unusable combo scripts were, and even now they're still a bit jank v.v

=== @EmilyV99 (discord: Emily) 10/23/2021 21:20

Keep in mind the returns for `PosX()`, `PosY()`, `Pos()`, `Layer()`

=== @EmilyV99 (discord: Emily) 10/24/2021 00:43

(I'd expect returns of the block's X/Y/Layer, and `Pos() == -1` to indicate pushblock)

=== @arceusplayer11 (discord: Deedee) 10/24/2021 09:09

(replying to @EmilyV99 (discord: Emily) "(I'd expect returns of the bl…"): makes sense, ye

=== @ZoriaRPG (discord: Timelord) 10/24/2021 12:31

You'd need to clone all the scriptdata to the sprite, then copy it to the new combo. This seems extremely unsafe to me.
To start you'll need to ensure that movingblock sprites have all of the attributes that combos have...

=== @ZoriaRPG (discord: Timelord) 10/24/2021 12:33

They will need to copy the attributes  of the combo they originally occupied and that is just one of many copies  they will need. Not will be the script stack, and the refinfo.
I have no idea how feasible that would be.
Sprite class objects and combos have  very little in common. Be sure to add this to the subcla@ of sprite::movingblock
I suppose if this works, it can be copied to lifted combos in the future.
Again, I see this as initially unsafe.

=== @EmilyV99 (discord: Emily) 10/24/2021 12:36

Nothing needs to be added to movingblock

=== @ZoriaRPG (discord: Timelord) 10/24/2021 12:36

Also, -10000 as I recall is the return for invalid

=== @EmilyV99 (discord: Emily) 10/24/2021 12:37

All the combo stacks, refinfos, etc for combos are global
Expanding those arrays by 1 would suffice

=== @ZoriaRPG (discord: Timelord) 10/24/2021 12:37

You would want -n where n is a special value for a movingblock

=== @EmilyV99 (discord: Emily) 10/24/2021 12:37

Aye, if -1 is the error, then -2 or some other value should be used

=== @ZoriaRPG (discord: Timelord) 10/24/2021 12:38

Those need to be copied to the sprite, so that the sprite can run them instead during its frames of movement.
And PosX and PosY would return  MovingBlock x/y
Pos() would return a special value
Otherwise a number of facets would conceptually  break.

=== @ZoriaRPG (discord: Timelord) 10/24/2021 12:42

And iirc you can have more than one movingblock at a time. If I am mistaken, someone in the future may want to add that, and then you'd be back to this.

=== @ZoriaRPG (discord: Timelord) 10/24/2021 12:44

Copying the data to the sprite, and then copying it to the final rest pos at the end of the block slide, is probably  the only safe and future proof way for this and will ensure that the script runs during the movingblock animation.

=== @EmilyV99 (discord: Emily) 10/24/2021 12:45

(replying to @ZoriaRPG (discord: Timelord) "Those need to be copied to th…"): I see no reason to copy it to the sprite, when the sprite is effectively a singleton (one instance only)
expanding the global arrays `combo_stack[]`, `combo_refinfo[]` etc by 1 index would accomplish the same

=== @ZoriaRPG (discord: Timelord) 10/24/2021 12:47

🤷
Except that would always use memory

=== @EmilyV99 (discord: Emily) 10/24/2021 12:48

the movingblock is also always in memory
`movingblock mblock2;` is a global singleton

=== @ZoriaRPG (discord: Timelord) 10/24/2021 12:49

And if it is part of the movingblock subclass it only does when those exist, and it is tied to sprite instances...wait...why?

=== @EmilyV99 (discord: Emily) 10/24/2021 12:49

always in memory, regardless of if a block is moving or not

=== @ZoriaRPG (discord: Timelord) 10/24/2021 12:49

Gob

=== @EmilyV99 (discord: Emily) 10/24/2021 12:49

It quite literally just has one block in memory, and updates it's values as needed
Not very sensical, but, uh, yeah

=== @ZoriaRPG (discord: Timelord) 10/24/2021 12:50

I suppose it is leftover from v0.x
I feel as if script timing might break though if the script isn't transferred.
How should I know. I never conceptualised  needing this so I never planned it out.

=== @ZoriaRPG (discord: Timelord) 10/24/2021 12:53

I never thought of a good reason why a movingblock engine sprite would need to run a script.
I could see the block triggers needing them, but not the block itself.
In fact, I tested *that*
But not on layer 0
As I knew in advance that the block would overwrite but I expected I to overwrite with script==0
Thus, it should simply kill the script. This is a case that I never even considered.
IDK if this affects armos/chest crud.
It could, I suppose if a chest appears or certain combo changes due to secrets appear or armos are triggered

=== @ZoriaRPG (discord: Timelord) 10/24/2021 12:59

I likewise, until now, didn't in any way anticipate these special purpose combo types/flags to already be running scripts.
This is a lack of foresight due to instinctively knowing how the engine works and never considering these invalid uses.
I have no doubts that other oversights like this exist

=== @ Moosh 10/25/2021 14:26

Tried writing a similar script as before. Everything seems to work better now, though InitD[0] appears to still bug out and reset to 0
```combodata script LessDumbCycle{
    void run(int delay, int offset){
        int sfx = this->Attribytes[0];
        Waitframes(delay);
        if(sfx>0)
            Game->PlaySound(sfx);
        mapdata lyr = Game->LoadTempScreen(this->Layer);
        lyr->ComboD[this->Pos] += offset;
    }
}```
Example script where it bugs out
```combodata script LessDumbCycle{
    void run(){
        int sfx = this->Attribytes[0];
        int delay = this->Attrishorts[0];
        int offset = this->Attributes[0];
        Trace(delay);
        Trace(offset);
        Waitframes(delay);
        if(sfx>0)
            Game->PlaySound(sfx);
        mapdata lyr = Game->LoadTempScreen(this->Layer);
        lyr->ComboD[this->Pos] += offset;
    }
}```
And then my fixed one where I didn't use InitD

=== @ Moosh 10/25/2021 14:28

Unsure if it's just InitD[0] or if there's further issues. InitD[1] seemed to be working fine when I traced it. Alternating between -1 and 1 in this case
Also small ui thing I just noticed
![image](https://cdn.discordapp.com/attachments/897976431634677841/902202218881634344/unknown.png?ex=65e5dacb&is=65d365cb&hm=637c1d272b5a14c0cf3a2b62d7136472bd9a4645bf8b543846aab90ea2d12276&)

=== @EmilyV99 (discord: Emily) 10/25/2021 14:30

@arceusplayer11 (discord: Deedee) on the UI

=== @ZoriaRPG (discord: Timelord) 10/25/2021 15:42

@ Moosh base initD or sriting/reading this->InitD?

=== @ Moosh 10/25/2021 15:43

base

=== @arceusplayer11 (discord: Deedee) 10/25/2021 19:44

fuck
easy fix
(the ui I mean)

=== @ZoriaRPG (discord: Timelord) 10/27/2021 11:13

Wrong structure data access
@ Moosh  example script pls.

=== @ Moosh 10/27/2021 15:42

(replying to @ZoriaRPG (discord: Timelord) "@ Moosh  exampl…"): https://discord.com/channels/876899628556091432/897976431634677841/902201633583288350

=== @arceusplayer11 (discord: Deedee) 02/07/2022 02:43

@EmilyV99 (discord: Emily)

=== @arceusplayer11 (discord: Deedee) 02/07/2022 02:48

I know the UI is fixed, but did you ever do anything about InitD[0] resetting to 0?

=== @EmilyV99 (discord: Emily) 02/07/2022 03:02

uhh
no clue
test?

=== @arceusplayer11 (discord: Deedee) 02/07/2022 08:05

Tested it, no it is not fixed
bloody hell,  let's see what's wrong

=== @arceusplayer11 (discord: Deedee) 02/07/2022 08:23

@EmilyV99 (discord: Emily) you awake?

=== @EmilyV99 (discord: Emily) 02/07/2022 08:25

Not enough

=== @arceusplayer11 (discord: Deedee) 02/07/2022 08:25

fuck

=== @arceusplayer11 (discord: Deedee) 02/07/2022 08:43

okay, so
it's getting initialized correctly
the problem is that it's getting overwritten
```default:
        {
            if(arg >= D(0) && arg <= D(7))            ri->d[arg - D(0)] = value;
            else if(arg >= A(0) && arg <= A(1))        ri->a[arg - A(0)] = value;
            else if(arg >= GD(0) && arg <= GD(MAX_SCRIPT_REGISTERS))    game->global_d[arg-GD(0)] = value;
            
            break;
        }``` this appears to be what is clearing it

=== @arceusplayer11 (discord: Deedee) 02/07/2022 08:55

https://pastebin.com/9Sf0qfjp I'll be honest, I'm not the best at ASM

=== @EmilyV99 (discord: Emily) 02/07/2022 09:00

Compare an ffc script with 2 params with a combo script with 2 params, where both scripts just `Trace();` each param

=== @EmilyV99 (discord: Emily) 02/07/2022 09:01

```cpp
type script foo
{
    void run(int a, int b)
    {
        Trace(a);
        Trace(b);
    }
}```
Replace `type` with each type

=== @arceusplayer11 (discord: Deedee) 02/07/2022 09:07

It only happens if it's not the original placed combo
```FFC script 1 (LessDumbCycle2): ffc script:FFC script 1 (LessDumbCycle2): 14.0000
FFC script 1 (LessDumbCycle2): 17.0000
FFC script 1 (LessDumbCycle2): 14.0000
FFC script 1 (LessDumbCycle2): 17.0000
combodata script 1 (LessDumbCycle): initial combo script:combodata script 1 (LessDumbCycle): 15.0000
combodata script 1 (LessDumbCycle): -1.0000
combodata script 1 (LessDumbCycle): 15.0000
combodata script 1 (LessDumbCycle): -1.0000
combodata script 2 (LessDumbCycle3): combo script:combodata script 2 (LessDumbCycle3): 0.0000
combodata script 2 (LessDumbCycle3): 1.0000
combodata script 2 (LessDumbCycle3): 15.0000
combodata script 2 (LessDumbCycle3): 1.0000
Combo script 2 (LessDumbCycle3): Stack over or underflow, stack pointer = 0```
```#include "std.zh"

combodata script LessDumbCycle{
    void run(int delay, int offset){
    TraceS("initial combo script:");
    Trace(delay);
    Trace(offset);
    Trace(this->InitD[0]);
    Trace(this->InitD[1]);
        int sfx = this->Attribytes[0];
        Waitframes(delay);
        if(sfx>0)
            Game->PlaySound(sfx);
        mapdata lyr = Game->LoadTempScreen(this->Layer);
        lyr->ComboD[this->Pos] += offset;
    }
}

combodata script LessDumbCycle3{
    void run(int delay, int offset){
    TraceS("combo script:");
    Trace(delay);
    Trace(offset);
    Trace(this->InitD[0]);
    Trace(this->InitD[1]);
    }
}

ffc script LessDumbCycle2{
    void run(int delay, int offset){
    TraceS("ffc script:");
    Trace(delay);
    Trace(offset);
    Trace(this->InitD[0]);
    Trace(this->InitD[1]);
    }
}```

=== @EmilyV99 (discord: Emily) 02/07/2022 09:10

Doesn't seem like a zasm issue then
Probably in run_script?

=== @arceusplayer11 (discord: Deedee) 02/07/2022 09:12

uh
where exactly is combodata's run_script?
I see one for every other class but combodata

=== @EmilyV99 (discord: Emily) 02/07/2022 09:12

...no, not that

=== @arceusplayer11 (discord: Deedee) 02/07/2022 09:12

oh, nevermind

=== @EmilyV99 (discord: Emily) 02/07/2022 09:12

ffscript.cpp

=== @arceusplayer11 (discord: Deedee) 02/07/2022 09:13

```case SCRIPT_COMBO:
        {
            ri = &(comboScriptData[i]);

            curscript = comboscripts[script];
            stack = &(combo_stack[i]);
            int32_t pos = ((i%176));
            int32_t lyr = i/176;
            int32_t id = comboscript_combo_ids[i]; 
            this_combo_id = FFCore.tempScreens[lyr]->data[pos];
            if(!(combo_initialised[pos] & (1<<lyr)))
            {
                memset(ri->d, 0, 8 * sizeof(int32_t));
                for ( int32_t q = 0; q < 2; q++ )
                    ri->d[q] = combobuf[id].initd[q];
                combo_initialised[pos] |= 1<<lyr;
            }

            ri->combosref = id; //'this' pointer
            ri->comboposref = i; //used for X(), Y(), Layer(), and so forth.
            break;
        }```
Right, this
yeah, I traced this
the ri->d is being set properly I think
or at the very least, d[0] is being set and d[1] is beign set to what they are supposed to be

=== @EmilyV99 (discord: Emily) 02/07/2022 09:14

Both times?
What happens when a combo is "changed"
How is it changing

=== @arceusplayer11 (discord: Deedee) 02/07/2022 09:14

it's being changed by a comboscript changing itself

=== @EmilyV99 (discord: Emily) 02/07/2022 09:15

ComboD[] assign?
So, check that

=== @arceusplayer11 (discord: Deedee) 02/07/2022 09:15

```mapdata lyr = Game->LoadTempScreen(this->Layer);
        lyr->ComboD[this->Pos] += offset;``` yeah, but through mapdata

=== @EmilyV99 (discord: Emily) 02/07/2022 09:15

Ah

=== @arceusplayer11 (discord: Deedee) 02/07/2022 09:15

I'm guessing that's it's own thing?

=== @EmilyV99 (discord: Emily) 02/07/2022 09:15

Those are separate
MAPDATACOMBODD or something?

=== @arceusplayer11 (discord: Deedee) 02/07/2022 09:17

yup
https://pastebin.com/pn6ggvTK

=== @EmilyV99 (discord: Emily) 02/07/2022 09:18

Appears to be properly clearing the initialized state...

=== @EmilyV99 (discord: Emily) 02/07/2022 09:20

I have an idea, I'll check when I get upstairs

=== @EmilyV99 (discord: Emily) 02/07/2022 09:23


![image](https://cdn.discordapp.com/attachments/897976431634677841/940175956839116850/unknown.png?ex=65e59317&is=65d31e17&hm=8b6930eef806f00951e722a1fbd60cfeb2d2154b8258eee186954d13e0c611da&)
Add `ri->pc = 0;` to this block

=== @EmilyV99 (discord: Emily) 02/07/2022 09:25

...or move this block above the `ri->pc++`
either would actuallywork I think?
the latter would probably be 'neater'
so, this
![image](https://cdn.discordapp.com/attachments/897976431634677841/940176868252987392/unknown.png?ex=65e593f1&is=65d31ef1&hm=ede06794ae2299cdcfc78ea065f4b091dc44976142122630deb8c4ed6a956e1e&)

=== @arceusplayer11 (discord: Deedee) 02/07/2022 09:27

the first thing fixed the problem, so at least that appears to be the issue

=== @EmilyV99 (discord: Emily) 02/07/2022 09:27

makes perfect sense
what's happening is
it changes the combo
clears all the data
that clears `ri->pc` to 0, as well

=== @arceusplayer11 (discord: Deedee) 02/07/2022 09:28

and then adds one

=== @EmilyV99 (discord: Emily) 02/07/2022 09:28

....but then it was adding 1

=== @arceusplayer11 (discord: Deedee) 02/07/2022 09:28

so it's offset
and thus reading the wrong thing off the stack

=== @EmilyV99 (discord: Emily) 02/07/2022 09:28

so it was skipping the first ZASM command

=== @arceusplayer11 (discord: Deedee) 02/07/2022 09:28

big oooof

=== @EmilyV99 (discord: Emily) 02/07/2022 09:28

which, is always a push
missing a push offsets the stack
and, it's the first initd
as soon as I realized it was clearing everything properly on changing the combo
I realized "wait, but this doesn't have the same auto-script-kill thing that things like `npc->Remove()` have, does it?"
it actually clearly did, but not quite in the right place.
extremely fucking stoned for the record

=== @arceusplayer11 (discord: Deedee) 02/07/2022 09:31

Did you just wake up and started smoking, or are you smoking before bed

=== @EmilyV99 (discord: Emily) 02/07/2022 09:31

I'm smoking trying to all-nighter to fix my sleep cycle

=== @arceusplayer11 (discord: Deedee) 02/07/2022 09:32

ooooof

=== @EmilyV99 (discord: Emily) 02/07/2022 09:32

been up 12 hours only

=== @arceusplayer11 (discord: Deedee) 02/07/2022 09:32

anyways @ Moosh  4 months late but this should be fixed in the next build

=== @EmilyV99 (discord: Emily) 02/07/2022 09:33

(meta) thread name was changed: ✅🔒Combo scripts broken

=== @EmilyV99 (discord: Emily) 02/07/2022 09:37

oh wait, just realized a problem
this, uhh, would cause issues if you changed the combo to the same ID it already is?
because that check will fail

=== @arceusplayer11 (discord: Deedee) 02/07/2022 09:40

oof

=== @ Moosh 02/07/2022 09:41

4 months late isn't too bad when I'd completely forgotten this wasn't working 🤣
I don't use combo scripts a lot, turns out

=== @EmilyV99 (discord: Emily) 02/07/2022 09:43

I have a more robust fix
now when it clears the combo data, it sets a global var to the combo position modified (including layer info)
(`pos+176*lyr`)
then, the check compares that against the `i` value of run_script (which should be the same value for the correct combo script)
so, if that position is modified at all, it clears and exits.
@arceusplayer11 (discord: Deedee) I'll push, will need you to test

=== @arceusplayer11 (discord: Deedee) 02/07/2022 09:45

alright

=== @EmilyV99 (discord: Emily) 02/07/2022 09:45

I'll check that it compiles first at least

=== @EmilyV99 (discord: Emily) 02/07/2022 09:53

@arceusplayer11 (discord: Deedee) pushed

=== @arceusplayer11 (discord: Deedee) 02/07/2022 10:05

alright; might not test till tomorrow

=== @EmilyV99 (discord: Emily) 02/07/2022 10:07


https://cdn.discordapp.com/attachments/897976431634677841/940186947077427200/buildpack.zip?ex=65e59d54&is=65d32854&hm=7d9e5bff4cbedf84ccd2f25f492f85b1130e54180e5b02becc0ce9d0bb114ff2&

=== @arceusplayer11 (discord: Deedee) 02/08/2022 04:30

Okay what the fuck this is some cursed shit
it's not even working at all, and I'm tracing it back to "variable = another variable" not fucking working and that's scaring me

=== @arceusplayer11 (discord: Deedee) 02/08/2022 05:47

nevermind, I was being a stupid
and by I I mean Emily
@EmilyV99 (discord: Emily) you big stupid.

=== @arceusplayer11 (discord: Deedee) 02/08/2022 05:50

(you also smart cause you fixed it but also I need someone to throw under the bus)

=== @arceusplayer11 (discord: Deedee) 02/08/2022 05:58

updated buildpack (also has the bitmap stuff)

https://cdn.discordapp.com/attachments/897976431634677841/940486793621557258/buildpack.zip?ex=65e6b494&is=65d43f94&hm=abdd898f01095b5a1682a9d0686d9f9d79c6ea13b649e1c151a8e69febb31a73&

=== @arceusplayer11 (discord: Deedee) 02/08/2022 06:32

(meta) thread name was changed: 💊🔓Combo scripts broken

=== @EmilyV99 (discord: Emily) 02/13/2022 05:12

#deleted-channel

=== @ Moosh 02/15/2022 10:16

Tried using combo scripts again in the latest, this still seems to be bugged.
In this case I had a bush combo with InitD of 0, I slash it to turn it into a bush combo with InitD of 1. Both are using the same bush. Second one is behaving as if InitD is still 0. Which is the same bug that was happening before IIRC

=== @EmilyV99 (discord: Emily) 02/15/2022 10:18

Are you getting stack over/underflow errors still?

=== @ Moosh 02/15/2022 10:19

Seems not at least. Lemme try tracing the values

=== @ Moosh 02/15/2022 10:22

looks like the script isn't quitting when the combo changes

=== @ Moosh 02/15/2022 10:25

```combodata script RupeeBush{
    #option BINARY_32BIT on
    void run(int spawnItem){
        int anim;
        int d = Floor(this->Pos/32);
        int dbit = 1<<(this->Pos%32);
        if(Screen->D[d]&dbit){
            Quit();
        }
        
        printf("Combo %d Item %d\n", this->Pos, spawnItem);
        
        if(spawnItem){
            item itm = CreateItemAt(spawnItem, this->X, this->Y);
            while(itm->isValid()){
                Waitframe();
            }
            Screen->D[d] |= dbit;
        }
        else{
            int anim;
            while(true){
                anim = (anim+1)%360;
                if(anim%24==(this->Pos+7)%24){
                    ParticleAnim(this->X+Rand(-8, 8), this->Y+Rand(-8, 8), 968, 8, 8, 5);
                }
                Waitframe();
            }
        }
    }
}

lweapon ParticleAnim(int x, int y, int tile, int cset, int frames, int aspeed){
    lweapon l = CreateLWeaponAt(LW_SPARKLE, x, y);
    l->OriginalTile = tile;
    l->Tile = l->OriginalTile;
    l->CSet = cset;
    l->NumFrames = frames;
    l->ASpeed = aspeed;
    l->CollDetection = false;
    return l;
}
```
Here's the script. I'm converting it back to an FFC and giving up. Combo scripts were a mistake

=== @EmilyV99 (discord: Emily) 02/15/2022 10:26

What's changing the combo, exactly?

=== @ Moosh 02/15/2022 10:26

Engine

=== @EmilyV99 (discord: Emily) 02/15/2022 10:27

what engine

=== @ Moosh 02/15/2022 10:27

Bush->Next (131)

=== @EmilyV99 (discord: Emily) 02/15/2022 10:27

ok....
oh
give me like 10 minutes

=== @ Moosh 02/15/2022 10:33

I assume combo scripts are set up in such a way that the code for restarting them when the combo changes is copied across several different combo types?

=== @EmilyV99 (discord: Emily) 02/15/2022 10:33

It has to call a function when it changes a combo
and the slashable set of combos (`check_slash_block2()`) is missing the calls

=== @ Moosh 02/15/2022 10:34

welp

=== @EmilyV99 (discord: Emily) 02/15/2022 10:34

oh, so are pounds
fun

=== @ Moosh 02/15/2022 10:34

How about step->next?
Or some obscure stuff like block holes?
Possibly generic because that can also have ->next behavior

=== @EmilyV99 (discord: Emily) 02/15/2022 10:36

gonna be fun times
or, gonna want some way to generify it so this doesn't need to be shit
ghhh

=== @EmilyV99 (discord: Emily) 02/15/2022 10:41

So, every frame when combo scripts run
cache the combo id
if none was cached already
compare it to the previous cached value, and if it changed, clear the combo script data for that position, and update the cached value

=== @EmilyV99 (discord: Emily) 02/15/2022 10:58

building first test

=== @EmilyV99 (discord: Emily) 02/15/2022 11:04


https://cdn.discordapp.com/attachments/897976431634677841/943100529574289428/zquest.exe?ex=65e6fc50&is=65d48750&hm=7eaf6d9d9c1294fb22caeda3faa3cea5fafa9d2a2a3d3e26f9906f1ab5f36078&
https://cdn.discordapp.com/attachments/897976431634677841/943100530367025213/zscript.exe?ex=65e6fc50&is=65d48750&hm=fe1ad9d8f8ee11dffe2a4c05abd685c97aaa1de90f0001ba7a96f11547e3456e&
https://cdn.discordapp.com/attachments/897976431634677841/943100531038117918/zelda.exe?ex=65e6fc50&is=65d48750&hm=9eb133e4107ddc214f210c1df24c01467de6fc7c3c761f04635b1d866388d324&

=== @ Moosh 02/15/2022 11:06

Do I need to recompile to test?

=== @EmilyV99 (discord: Emily) 02/15/2022 11:14

shouldn't?

=== @ Moosh 02/15/2022 11:17

oh fuck right on off Discord, not you too
![image](https://cdn.discordapp.com/attachments/897976431634677841/943103693589471232/unknown.png?ex=65e6ff42&is=65d48a42&hm=6f7f367e18e641c144da68f16e4403e66289f669928c5627a6a219f7fb5c2d2b&)

=== @ Moosh 02/15/2022 11:22

@EmilyV99 (discord: Emily) Now it's restarting the script every frame 🤔

=== @ Moosh 02/15/2022 11:23

On both the slashed and unslashed bush to be clear

=== @ Moosh 02/15/2022 11:25

My guess would be that the function you stuck it in is also running every frame, but then why do it after I slash the bush as well

=== @EmilyV99 (discord: Emily) 02/15/2022 11:30

the fuck
oh
....ffs
I forgot one line

https://cdn.discordapp.com/attachments/897976431634677841/943107382928625704/zelda.exe?ex=65e702b2&is=65d48db2&hm=adecc5a35034daa1d222b710572fb7ef6030ba5be35dcd4ee5c7238d058c8c1f&

=== @EmilyV99 (discord: Emily) 02/15/2022 11:35

there's a debug print in that as well

=== @ Moosh 02/15/2022 11:49

Alright, it's working

=== @EmilyV99 (discord: Emily) 02/15/2022 12:09

woo!
For the record, what I forgot was really stupid

![image](https://cdn.discordapp.com/attachments/897976431634677841/943116881362043010/unknown.png?ex=65e70b8a&is=65d4968a&hm=bc3675b8f641ae78c897512a6db2032856ef064be53394ca1087b1fecbb5bf1f&)
I uh, totally forgot `cache_initialized = true;`

=== @EmilyV99 (discord: Emily) 02/15/2022 12:17

(meta) thread name was changed: ✅🔒Combo scripts broken
