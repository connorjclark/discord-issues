## âŒLayered Lock Blocks Don't Work by Default (#3032)
@connorjclark (discord: connorclark) opened this issue on 02/02/2024
Status: unknown
Tags: Closed,Added
Source: #feature-requests https://discord.com/channels/876899628556091432/1202908144632860712


=== @connorjclark (discord: connorclark) 02/02/2024 09:27

I plan to use this C++ library: https://github.com/zaphoyd/websocketpp . I've already used it for the experimental protocol work and it's nice.

A websocket interface just needs these things really:

- Connect to ws endpoint
- Read message
- Send message
- Close

Messages are just byte arrays, but string data types are commonly used as they are interchangable. We can use int[] here as our "string" message.

I haven't learned about how zscript handles arrays/strings/allocation of them yet, so in the pseudocode you'll see some open questions I have:

```c
generic script {
    void run() {
        websocket ws = CreateWebSocket("ws://blah");
        ws->Own();

        while (true) {
            if (ws->GetState() == 'connecting')
            {
                Waitframe();
                continue;
            }
            else if (ws->GetState() == 'connection_failed')
            {
                Trace("Failed to connect.");
                Trace(ws->GetError());
                break;
            }

            if (ws->GetState() != 'connected')
            {
                Trace("Failed to connect.");
                Trace(ws->GetState());
                break;
            }

            while (ws->HasMessage())
            {
                // 1a. Can a function return a newly allocated string?
                int[] message = ws->GetNextMessage();
                Trace(message);
                // Would you have to dealloc?
                FreeArray(message);

                // 1b. Or should ws just own the data?
                int[] message = ws->GetNextMessage(message);
                Trace(message);
                // No need to dealloc, but if we want to keep it must copy else
                // will be free'd by next call to GetNextMessage

                // 2. Or must we provide it ourself?
                int[] message;
                ResizeArray(message, ws->GetNextMessageSize());
                ws->GetNextMessage(message);
                Trace(message);
                FreeArray(message);
            }

            Waitframe();
        }
    }
}
```

=== @connorjclark (discord: connorclark) 02/02/2024 09:30

Worth mentioning sending/reading the messages will be more cumbersome than it would be in other languages, as users will need to work out how to encode/decode whatever data they have. Typically JSON makes that a breeze. But without something like json/dictionaries, you instead gotta pack your information as unstructured numbers/strings and make a custom parser

=== @EmilyV99 (discord: Emily) 02/02/2024 09:31

Generally a buffer would be passed in, re: `2.`

=== @connorjclark (discord: connorclark) 02/02/2024 09:33

But do you see how that's the most cumbersome variant ðŸ« 

=== @EmilyV99 (discord: Emily) 02/02/2024 09:33

`1a.` is not doable
`1b.` might
class/object stuff owns arrays in a similar way

=== @connorjclark (discord: connorclark) 02/02/2024 09:34

(replying to @EmilyV99 (discord: Emily) "`1a.` is not doable"): can you explain why so I can learn?

=== @EmilyV99 (discord: Emily) 02/02/2024 09:34

well, I mean, technically it is doable now I suppose
but the user would be forced to use `DestroyArray` manually
because the standard "falling out of scope" ZASM won't have been generated for that array
which, would probably be fairly confusing to users

=== @connorjclark (discord: connorclark) 02/02/2024 09:36

Not following at all. The while loop is a new scope on every iteration. And are you saying arrays otherwise get cleaned up when the scope ends? I figured a destroy call was always needed.
Are there examples scripts to look at, I couldn't find much.
I guess I'm asking for a heap allocated array but we only do stack allocated ones?
(for option 1)

=== @connorjclark (discord: connorclark) 02/02/2024 09:46

(replying to @EmilyV99 (discord: Emily) "because the standard "fallingâ€¦"): Nevermind, I get what you're saying.

=== @EmilyV99 (discord: Emily) 02/02/2024 09:50

yeah, there's usually a DEALLOCATEMEMR zasm command generated for every array
which just won't be generated by a function call

=== @connorjclark (discord: connorclark) 02/02/2024 09:50

So 1a, for a function to return an allocated array, the caller must be the one to free it. And we don't have anything like garbage collection so gotta free it manually.

1b is nice since it defers memory management to internal, user doesn't need to do anything but read the array. Unless they wanna copy and hold onto it for some reason.

Don't like 2 as an interface, too much setup

=== @EmilyV99 (discord: Emily) 02/02/2024 09:51

s/

=== @connorjclark (discord: connorclark) 02/02/2024 09:52

Mhmm I guess 2 is silly example, the GetNextMessage could just resize the array for you

=== @connorjclark (discord: connorclark) 02/02/2024 10:02

Wonder if possible to avoid any copy from ws message data to the zscript array manager

=== @connorjclark (discord: connorclark) 02/02/2024 10:03

Eh not worth it, messages shouldn't get thaaaat large to matter

=== @EmilyV99 (discord: Emily) 02/02/2024 10:21

(replying to @connorjclark (discord: connorclark) "Mhmm I guess 2 is silly exampâ€¦"): aye, `sprintf` already resizes your buffer to be large enough
there's a syntax for handling that

=== @connorjclark (discord: connorclark) 02/03/2024 08:41


![image](https://cdn.discordapp.com/attachments/1202908144632860712/1203259047156121600/image.png?ex=65ec20d0&is=65d9abd0&hm=60b0caccf1a71ecf53a2a12b36738d48077839b94391cf64e44540d8ba45bd25&)

=== @connorjclark (discord: connorclark) 02/03/2024 08:43

Will need a parameter (either on connection or on receive...) to control if the zscript array is stored as a int array (no x10000...) or a string (yes x10000)
or maybe `ws->SetBinary(true)`

=== @EmilyV99 (discord: Emily) 02/03/2024 08:44

woo

=== @connorjclark (discord: connorclark) 02/03/2024 09:45

websocket messages can be text or binary. you can send or receive either on the same connection.

sending is easy:

```c
ws->Send(message, type = WEBSOCKET_MESSAGE_TYPE_TEXT);
```

receiving can be done simply too

```c
while (ws->HasMessage)
{
  int type = ws->NextMessageType; // 1 is text, 2 is binary
  int message[] = ws->Receive();
  // ...
}
```

more cumbersome (implementation wise, but actually nicer user wise...) would be having `Receive` return a new type `websocketmessage` that has two fields - type and arrayptr.

=== @EmilyV99 (discord: Emily) 02/03/2024 09:54


![image](https://cdn.discordapp.com/attachments/1202908144632860712/1203277258375168060/Screenshot_20240203_045400_GitHub.jpg?ex=65ec31c6&is=65d9bcc6&hm=29b064ba2fb910c2c86300f64b4c7af8cf196d1c43ef41cfe3d1e6c9dab75550&)
^ no. You can have the prior opcode set `ri->d[rEXP1]` to the value directly, saving the opcode.

=== @connorjclark (discord: connorclark) 02/03/2024 10:37

`if (ws->State == websocket_state::connecting)` do enums not work with namespace prefixes?
gotta leave off websocket_state:: for it to compile
> Error S009: Variable websocket_state::connecting has not been declared../zscript

=== @EmilyV99 (discord: Emily) 02/03/2024 10:39

err, huh?
what's the enum look like?

=== @EmilyV99 (discord: Emily) 02/03/2024 10:41

ah

![image](https://cdn.discordapp.com/attachments/1202908144632860712/1203289137331830824/image.png?ex=65ec3cd6&is=65d9c7d6&hm=a3a97f05820d03871562d9b5646a7acf5b2abede0834c3d3772d580d4a961019&)
that's not a namespace, it's a typename
you would need to put it in `namespace websocket_state` to get a prefix
```cpp
namespace websocket_state
{
    enum websocket_state
    {
        connecting,
        open,
        closing,
        closed
    };
}
//c++: using websocket_state = websocket_state::websocket_state;
//zscript: typedef websocket_state websocket_state::websocket_state```
think it'd be something like this (the using to alias the type so that you don't need to scope to use the type)
but, enum names themselves are not a scoped name to use
err wait brain

=== @EmilyV99 (discord: Emily) 02/03/2024 10:44

not sure if you're in zs or c++ lol (which.... I literally found the code myself, it's zscript... I'm too tired to brain at this hour lol), pretty sure the answer is the same either way (if it isn't for c++, that's news to me); the last line is the only one different between the two though

=== @connorjclark (discord: connorclark) 02/03/2024 18:19

Yeah CPP enums are scoped
You can leave it off only if the type can otherwise be deferred

=== @EmilyV99 (discord: Emily) 02/03/2024 18:20

I could swear I tried that before and it didn't work

=== @connorjclark (discord: connorclark) 02/03/2024 18:20

Or if it is anonymous

=== @EmilyV99 (discord: Emily) 02/03/2024 18:20

Was it always that way, or was that changed in some cpp version?

=== @connorjclark (discord: connorclark) 02/03/2024 18:21

Might just be enum class
Which isn't really a class
But is a better enum

=== @EmilyV99 (discord: Emily) 02/03/2024 18:21

Ah yeah, that's a different keyword
Makes sense

=== @connorjclark (discord: connorclark) 02/04/2024 03:03

Does this not work?

```
enum {
    WEBSOCKET_MESSAGE_TYPE_TEXT = 1L,
    WEBSOCKET_MESSAGE_TYPE_BINARY = 2L
};
```
Seems to be evaluated as 10,000 and 20,000

=== @EmilyV99 (discord: Emily) 02/04/2024 03:06

...what?
that SHOULD work
`1L` is just a literal with value `0.0001` and type `long`

=== @EmilyV99 (discord: Emily) 02/04/2024 03:09


![image](https://cdn.discordapp.com/attachments/1202908144632860712/1203537908028547113/image.png?ex=65ed2485&is=65daaf85&hm=c4d47c3321220da865f9e6cc219c45804bc5f375131742818f438a0bc92828f1&)

=== @EmilyV99 (discord: Emily) 02/04/2024 03:11

How are you checking the value?
IIRC `Trace(long)` is overriden to print the raw value?

=== @connorjclark (discord: connorclark) 02/04/2024 03:13

maybe I'm missing something, I'l check more closely after watching a movie

=== @EmilyV99 (discord: Emily) 02/04/2024 03:14

aye, `Trace(long)` is overriden; so if you stored the value in a `long` type variable and used `Trace()` to print it, it would print the raw value, so a print of `1` would mean `1`, not `10000`
if that's not how you tested the value, ðŸ¤·â€â™€ï¸ no idea
lmk if you find anything

=== @connorjclark (discord: connorclark) 02/04/2024 03:14

I found it - old code, forgot to stop *10000
nothing broken

=== @EmilyV99 (discord: Emily) 02/04/2024 03:14

ah, nice

=== @connorjclark (discord: connorclark) 02/04/2024 23:12

> [Error] ..\..\tests\scripts\websocket.zs Line 37 @ Columns 17-73 - Error T021: Function ws->Send(WebSocket, char32[], const int) has not been declared.
>     { "Send",                       0,         ZTID_VOID,    -1,                   FL_INL,  { ZTID_WEBSOCKET, ZTID_CHAR, ZTID_FLOAT },{1}, {} },
> ws->Send("domo arigato!", WEBSOCKET_MESSAGE_TYPE_BINARY);
WEBSOCKET_MESSAGE_TYPE_BINARY is 2L
the error says the third, optional param is an int
but i dont see a ZTID for that?

=== @connorjclark (discord: connorclark) 02/04/2024 23:14

jk its ZTID_LONG

=== @EmilyV99 (discord: Emily) 02/04/2024 23:19

for the record, the error will still say int
because the constant is an int
as enums are `const int` unless they are a new custom type
....I should add enum typing syntax to choose an existing type, tbh
```cpp
enum = long
{
    A = 1L, B
};```
can also have it specialize long to increment by 1L instead of 1
(until I add such, there's no way to enumerate a `long` type of constants)

=== @connorjclark (discord: connorclark) 02/04/2024 23:29

umm
![image](https://cdn.discordapp.com/attachments/1202908144632860712/1203844821371060284/image.png?ex=65e507db&is=65d292db&hm=7ca6c456b66c2ef86ef758fa79d1cbc1cd943ce5d7a2f856cc446eb6407aa76c&)
(optimize disabled)

=== @EmilyV99 (discord: Emily) 02/04/2024 23:32

wtf
what happens if you change `i++` to `++i`?

=== @connorjclark (discord: connorclark) 02/04/2024 23:35

same thing

=== @EmilyV99 (discord: Emily) 02/04/2024 23:35

k...

=== @connorjclark (discord: connorclark) 02/04/2024 23:36

```
170: LOADD           D2              50000        [Block 16 -> 17]
  171: ARRAYSIZE       D2                           
  172: STORED          D2              30000        
  173: ALLOCATEMEMV    D2              340000       
  174: STORED          D2              20000        
  175: WRITEPODSTRING  D2              got binary message of length: %d

  176: LOADD           D2              20000        
  177: PUSHR           D2                           
  178: LOADD           D2              30000        
  179: PUSHVARGR       D2                           
  180: PRINTFVARG                                   
  181: POP             D5                           
  182: LOADD           D3              20000        
  183: DEALLOCATEMEMR  D3                           
  184: STOREDV         0               10000        
  185: LOADD           D2              10000        [Block 17 -> 18, 12]
  186: PUSHR           D2                           
  187: LOADD           D2              30000        
  188: POP             D3                           
  189: COMPARER        D3              D2           
  190: SETCMP          D2              I<           
  191: COMPAREV        D2              0            
  192: GOTOCMP         135             ==           
  193: ALLOCATEMEMV    D2              80000        [Block 18 -> 17]
  194: STORED          D2              0            
  195: WRITEPODSTRING  D2              %d: %d
      
  196: LOADD           D2              0            
  197: PUSHR           D2                           
  198: LOADD           D2              10000        
  199: PUSHVARGR       D2                           
  200: LOADD           D2              50000        
  201: PUSHR           D2                           
  202: LOADD           D2              10000        
  203: POP             D0                           
  204: READPODARRAYR   D2              D2           
  205: PUSHVARGR       D2                           
  206: PRINTFVARG                                   
  207: POP             D5                           
  208: LOADD           D3              0            
  209: DEALLOCATEMEMR  D3                           
  210: LOADD           D2              10000        
  211: ADDV            D2              10000        
  212: STORED          D2              10000        
  213: GOTO            185                          
  214: GOTO            135                          [Block 19 -> 12]
```

=== @EmilyV99 (discord: Emily) 02/04/2024 23:38

hmm

=== @EmilyV99 (discord: Emily) 02/04/2024 23:40

zasm looks correct?

=== @EmilyV99 (discord: Emily) 02/04/2024 23:41

210: 'load `i`'
211: 'add `1` to loaded value'
212: 'store `i`'
not sure.

=== @connorjclark (discord: connorclark) 02/04/2024 23:43

switching to `printf("%d\n", i);` and it works

=== @EmilyV99 (discord: Emily) 02/04/2024 23:43

w...what the fuck?
Is `jit` enabled?
what happens with jit off, if so?

=== @connorjclark (discord: connorclark) 02/04/2024 23:44

its off

=== @EmilyV99 (discord: Emily) 02/04/2024 23:44

what the fuck???

=== @connorjclark (discord: connorclark) 02/04/2024 23:45

this is w/ just `printf("%d\n", i)`

```
  170: LOADD           D2              50000        [Block 16 -> 17]
  171: ARRAYSIZE       D2                           
  172: STORED          D2              30000        
  173: ALLOCATEMEMV    D2              340000       
  174: STORED          D2              20000        
  175: WRITEPODSTRING  D2              got binary message of length: %d

  176: LOADD           D2              20000        
  177: PUSHR           D2                           
  178: LOADD           D2              30000        
  179: PUSHVARGR       D2                           
  180: PRINTFVARG                                   
  181: POP             D5                           
  182: LOADD           D3              20000        
  183: DEALLOCATEMEMR  D3                           
  184: STOREDV         0               10000        
  185: LOADD           D2              10000        [Block 17 -> 18, 12]
  186: PUSHR           D2                           
  187: LOADD           D2              30000        
  188: POP             D3                           
  189: COMPARER        D3              D2           
  190: SETCMP          D2              I<           
  191: COMPAREV        D2              0            
  192: GOTOCMP         135             ==           
  193: ALLOCATEMEMV    D2              40000        [Block 18 -> 17]
  194: STORED          D2              0            
  195: WRITEPODSTRING  D2              %d
          
  196: LOADD           D2              0            
  197: PUSHR           D2                           
  198: LOADD           D2              10000        
  199: PUSHVARGR       D2                           
  200: PRINTFVARG                                   
  201: POP             D5                           
  202: LOADD           D3              0            
  203: DEALLOCATEMEMR  D3                           
  204: LOADD           D2              10000        
  205: ADDV            D2              10000        
  206: STORED          D2              10000        
  207: GOTO            185                          
  208: GOTO            135                          [Block 19 -> 12]
```

=== @EmilyV99 (discord: Emily) 02/04/2024 23:45

my brain is a bit fried and I've gotta go for dinner anyway
....I don't... see anything wrong with the zasm

=== @EmilyV99 (discord: Emily) 02/04/2024 23:48

(replying to @EmilyV99 (discord: Emily) "```cpp
enum = long
{
    A =â€¦"): as for this.... it works (not including the incrementing by `1L` for long types, that'll be more work) - purely a Bison change, not even any AST changed lol
![image](https://cdn.discordapp.com/attachments/1202908144632860712/1203849678198669393/image.png?ex=65e50c61&is=65d29761&hm=eef8ae2383dd8b4372c5bf89d9099278e642ee10ef5310e3c8c37a61a1fce850&)
if you can narrow down your issue at all I'll dig into it more after dinner

=== @connorjclark (discord: connorclark) 02/04/2024 23:56

(replying to @connorjclark (discord: connorclark) "```
170: LOADD           D2â€¦"): When I hit `184: STOREDV 0` (i), I set a breakpoint on that position of the stack.

It was written to prematurely, at: `201: PUSHR`
just that part for easier viewing:

```
  184: STOREDV         0               10000        
  185: LOADD           D2              10000        [Block 17 -> 18, 12]
  186: PUSHR           D2                           
  187: LOADD           D2              30000        
  188: POP             D3                           
  189: COMPARER        D3              D2           
  190: SETCMP          D2              I<           
  191: COMPAREV        D2              0            
  192: GOTOCMP         135             ==           
  193: ALLOCATEMEMV    D2              80000        [Block 18 -> 17]
  194: STORED          D2              0            
  195: WRITEPODSTRING  D2              %d: %d
      
  196: LOADD           D2              0            
  197: PUSHR           D2                           
  198: LOADD           D2              10000        
  199: PUSHVARGR       D2                           
  200: LOADD           D2              50000        
  201: PUSHR           D2                           
```

=== @EmilyV99 (discord: Emily) 02/04/2024 23:58

Can you reproduce in current `main`? (To rule out your websocket stuff)?

=== @connorjclark (discord: connorclark) 02/05/2024 00:16

It was bad code given to Receive function builder ðŸ« 
I've wanted to generalize the `giveCode` stuff for a while, but now I _really_ want to since I made a copy paste error

=== @EmilyV99 (discord: Emily) 02/05/2024 00:17

Lol

=== @connorjclark (discord: connorclark) 02/05/2024 00:22

is it possible to print a long value as hex?

=== @connorjclark (discord: connorclark) 02/05/2024 00:23

I think I'm done with this now.

![image](https://cdn.discordapp.com/attachments/1202908144632860712/1203858494332346421/image.png?ex=65e51497&is=65d29f97&hm=1b86c8d7a32740ea10563d6f7903555865286b881f994bcf89b52aab07c22910&)
```c
#include "std.zh"

ffc script WebSocketScript
{
    void run()
    {
        printf("Connecting to websocket.\n");
        websocket ws = Game->OpenWebSocket("ws://ws.ifelse.io");
        ws->Own();
        bool hasSentMessage = false;

        while (true)
        {
            if (ws->State == WEBSOCKET_STATE_CONNECTING)
            {
                Waitframe();
                continue;
            }
            else if (ws->State == WEBSOCKET_STATE_CLOSED)
            {
                printf("Failed to connect.\n");
                int error[0];
                ws->GetError(error);
                printf("Failed to connect: %s\n", error);
                break;
            }

            if (ws->State != WEBSOCKET_STATE_OPEN)
            {
                printf("Failed to connect: %d\n", ws->State);
                break;
            }

            if (!hasSentMessage)
            {
                printf("Connected!\n");
                ws->Send("hello world!");
                ws->Send("domo arigato!", WEBSOCKET_MESSAGE_TYPE_BINARY);
                hasSentMessage = true;
            }

            while (ws->HasMessage)
            {
                int message[] = ws->Receive();
                int type = ws->MessageType;
                if (type == WEBSOCKET_MESSAGE_TYPE_TEXT)
                    printf("got text message: %s\n", message);
                else if (type == WEBSOCKET_MESSAGE_TYPE_BINARY)
                {
                    int len = SizeOfArray(message);
                    printf("got binary message of length: %d\n", len);
                    for (int i = 0; i < len; ++i)
                        printf("%d: %l\n", i, message[i]);
                }
                else
                    printf("got message, but with unknown type: %d\n", type);
            }

            Waitframe();
        }
    }
}
```

=== @EmilyV99 (discord: Emily) 02/05/2024 00:25

(replying to @connorjclark (discord: connorclark) "is it possible to print a lonâ€¦"): ... Don't think so, will need a new format specifier for that
Not sure what to use

=== @connorjclark (discord: connorclark) 02/05/2024 00:26

It's alright, nbd from my end.

=== @EmilyV99 (discord: Emily) 02/05/2024 00:35

woo
![image](https://cdn.discordapp.com/attachments/1202908144632860712/1203861507113492530/image.png?ex=65e51765&is=65d2a265&hm=38d432d4d5df4cab41d2add82fafe7edf1ab36648cfd110857bf5efd2603ac45&)
so, with this, you should be able to have that enum be properly typed
(Technically this will work for *any* type, allowing `enum = untyped` or `enum = npc`, despite some types being nonsensical)
(will increment by long only if the type is `long`, obviously)
(replying to @EmilyV99 (discord: Emily) "woo"): (note that this is displaying the numbers as long, so these are not *10000)

=== @EmilyV99 (discord: Emily) 02/05/2024 00:41

```
By default, enums are constants of type `int`, which auto-increment by `1`.
You can change the type of the enum to a pre-existing type by using the following syntax:
    [example--
    enum = untyped
    {
        A, B, C
    };
    --end example]
If the type of an enum is set to `long`, it will auto-increment by `1L` instead of `1`.
    [example--
    enum = long
    {
        A, //0L
        B, //1L
        C  //2L
    };
    --end example]```

=== @EmilyV99 (discord: Emily) 02/05/2024 00:45

I love that this is all it took to make it *work* for different types (excluding the new increment behavior)
![image](https://cdn.discordapp.com/attachments/1202908144632860712/1203863957274755102/image.png?ex=65e519ae&is=65d2a4ae&hm=618d24d484ea818a715281f13c42260a7c199ec4ae9e82f7ba1f0c4769af7cf0&)

=== @EmilyV99 (discord: Emily) 02/05/2024 00:51

(replying to @connorjclark (discord: connorclark) "```c
#include "std.zh"

ffc sâ€¦"): `char32` is the appropriate type for strings, such as the `int error[0]`/`ws->GetError()` you have there, for the record. (No *functional* difference, only matters for overloading/error messages)

=== @EmilyV99 (discord: Emily) 02/05/2024 00:52

also...
`int message[] = ws->Receive();`
...this works?? I would expect this to be an error, as you don't have a proper array initializer (`{0, 1, 2}`) on the rhs....
I would expect you to need to do just `int message =` without the `[]`...

=== @connorjclark (discord: connorclark) 02/05/2024 00:56

>  proper array initializer ({0, 1, 2}) on the rhs....

Is that something in the WebSocketTable symbol?

=== @EmilyV99 (discord: Emily) 02/05/2024 00:58

no, the zscript
`int message[] = ws->Receive();`
like, that shouldn't, afaik, compile
....and it compiling makes me hate how zscript array typing works even more
Either that is behaving IDENTICALLY to `int message = ws->Receive()`, or it's doing something improper in the ZASM. Not sure which.

=== @EmilyV99 (discord: Emily) 02/05/2024 01:03

I would *expect* declaring a var with `[]` to require `{0,1,2}` style initializer on the rhs

=== @connorjclark (discord: connorclark) 02/05/2024 01:08

yeah looks broken

>   137: SETR            REFWEBSOCKET    D2           
>   138: WEBSOCKET_RECEIVE D2                         
>   139: LOADD           D2              70000
it somehow still works

=== @connorjclark (discord: connorclark) 02/05/2024 01:12

i think it just happens to use `"Failed to connect.\n"` arrayptr

=== @connorjclark (discord: connorclark) 02/05/2024 01:17

I changed to `int message = ws->Recieve()` (which I'd like to avoid...) but now I get errors about not changing the array ptr
and looking at the zasm, it now at least stores it...

>   137: SETR            REFWEBSOCKET    D2           
>   138: WEBSOCKET_RECEIVE D2                         
>   139: STORED          D2              50000        
>   140: LOADD           D2              70000

=== @EmilyV99 (discord: Emily) 02/05/2024 01:17

something to do with what you're doing to deallocate it

=== @connorjclark (discord: connorclark) 02/05/2024 01:17

...but that is the location of one of the string constants..

=== @EmilyV99 (discord: Emily) 02/05/2024 01:18

huh? weird
it shouldn't be
unless it's a string that is no longer used by the point that is declared
(it re-uses the same stack space for multiple variables sometimes)

=== @connorjclark (discord: connorclark) 02/05/2024 01:18

Yeah, it is.
I mean it could in the next iteration.

=== @connorjclark (discord: connorclark) 02/05/2024 01:20

(but thats fine)

=== @connorjclark (discord: connorclark) 02/05/2024 01:27

of course, I need to x10000 the array ptr in `WEBSOCKET_RECEIVE`
because we totally need to represent that as fixed point number
Can you help make `int message[] = ws->Receive();` possible?
Or do you prefer `int message_ptr = ws->Receive();`?

=== @EmilyV99 (discord: Emily) 02/05/2024 01:30

(replying to @connorjclark (discord: connorclark) "Or do you prefer `int messageâ€¦"): ^
everything to do with `[]` / array typing is fucking AWFUL
and I want to rewrite it but can't without breaking things
(or doing some sort of toggle, but like, bleh)
what needs happening is a full rewrite of the array system
which is FAR too much to happen anytime soon

=== @connorjclark (discord: connorclark) 02/05/2024 02:28

@EmilyV99 (discord: Emily) is this correct code?

```c
printf("Failed to connect.\n");
char32 error;
ws->GetError(error);
printf("Failed to connect: %s\n", error);
break;
```

=== @connorjclark (discord: connorclark) 02/05/2024 02:30

(replying to @EmilyV99 (discord: Emily) "`char32` is the appropriate tâ€¦"): I think I misinterpreted this
It should be `char32 error[]`?

=== @ Moosh 02/05/2024 02:30

should be `char32 error[]` shouldn't it?

=== @connorjclark (discord: connorclark) 02/05/2024 02:31

oh, right, `char32 error[0]`
ðŸ« 

=== @ Moosh 02/05/2024 02:32

err right. Array needs a size. Doy. I was thinking strings cuz char32.

=== @EmilyV99 (discord: Emily) 02/05/2024 02:56

yep

=== @connorjclark (discord: connorclark) 02/05/2024 03:20

I understand mechanically what Own does, but is it useful here?
If OpenWebSocket tied ownership to the script automatically, is that bad?

=== @connorjclark (discord: connorclark) 02/05/2024 03:22

And if I did that, could I remove websocket Own entirely?
Probably wouldn't remove Own, just to match all the other user object types

=== @ Moosh 02/05/2024 03:42

Can't think of any reason I'd want a global websocket, though having it auto-owned would bother me a little just for being inconsistent. I don't think any other type does that?
aside from classes but those feel a little different

=== @EmilyV99 (discord: Emily) 02/05/2024 04:04

definitely don't remove it because it can be used to *transfer* ownership

=== @connorjclark (discord: connorclark) 02/05/2024 04:25

(replying to @ Moosh "Can't think of any reason I'dâ€¦"): Oh I figured a global websocket would be the default use case..
Does that mean in a global script or outside the run fn?

=== @EmilyV99 (discord: Emily) 02/05/2024 04:26

global is outside the run fn

=== @ Moosh 02/05/2024 04:26

Meant outside of the run function yeah.

=== @connorjclark (discord: connorclark) 02/05/2024 05:09

To be clear, the desired behavior here is that if you don't do Own, and the script ends, the websocket will remain open?

=== @ Moosh 02/05/2024 05:11

Until the quest itself is closed, yeah. That's what I'd assume would happen?

=== @connorjclark (discord: connorclark) 02/05/2024 05:12

Oh let me rephrase -is that behavior desired specifically, or is the preference more to just exactly match how all other pointers work
Same result either way just trying to understand

=== @ Moosh 02/05/2024 05:13

Mostly just for consistency yeah. Is there any harm in potentially leaving a websocket open when it's not being actively used?

=== @connorjclark (discord: connorclark) 02/05/2024 05:15

It's an extra connection open on the server, and I've set the user websocket limit to something low (3)

=== @connorjclark (discord: connorclark) 02/05/2024 05:18

In general I have an issue with how unintuitive object lifecycle/ownership is, and for a resource like a socket connection it starts to have a burden larger than just a burned pointer slot
But I get the argument about consistency

=== @ Moosh 02/05/2024 05:19

That's true...

=== @connorjclark (discord: connorclark) 02/05/2024 05:19

In this case you get a websocket via Game->OpenWebSocket, not WebSocket->Allocate - fwiw
So you didn't really allocate it, is what I'm saying
but now I'm bending over backwards maybe hehe

=== @ Moosh 02/05/2024 05:24

Most cases where Own() is a thing I do call Own() anyways. This would definitely be a case where I'd always own the object. So it does make sense

=== @ Moosh 02/05/2024 05:26

Whole thing's really a solution to a problem Zoria created originally by not having any system of ownership for objects created by scripts. Which then created a bunch of headache for users having to write their own. And then the precedent for objects not being owned by default was set there

=== @connorjclark (discord: connorclark) 02/05/2024 05:27

Yeah, it's all begging for a do over

=== @ Moosh 02/05/2024 05:28

@EmilyV99 (discord: Emily) there's no way to disown an object currently, right?
aside from ZScript classes which have GlobalObject()

=== @EmilyV99 (discord: Emily) 02/05/2024 05:29

(replying to @ Moosh "@EmilyV99 (discord: Emily) there'sâ€¦"): correct
and arrays IIRC might have something similar?

=== @connorjclark (discord: connorclark) 02/05/2024 05:40

`new user_class()` auto assigns ownership to the current script yeah?

=== @EmilyV99 (discord: Emily) 02/05/2024 05:43

yep
(replying to @ Moosh "aside from classes but thoseâ€¦"): ^

=== @connorjclark (discord: connorclark) 02/05/2024 05:50

https://discord.com/channels/876899628556091432/1203940694096482304

=== @connorjclark (discord: connorclark) 02/05/2024 06:03

^ Will stick with the consistent behavior re: ownership for Game->OpenWebSocket, and try a separate refactor to improve things for all builtin objects.

=== @connorjclark (discord: connorclark) 02/05/2024 06:04

Might as well rename it LoadWebSocket.

=== @connorjclark (discord: connorclark) 02/05/2024 07:57

Done!
