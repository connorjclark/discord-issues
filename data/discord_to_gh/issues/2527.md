## ‚ùåLayered Lock Blocks Don't Work by Default (#2527)
@connorjclark (discord: connorclark) opened this issue on 07/16/2023
Status: unknown
Tags: 
Source: #dev-discussion https://discord.com/channels/876899628556091432/1130254410296070295


=== @connorjclark (discord: connorclark) 07/16/2023 21:47

RE: vs code extension
Start of convo: https://discord.com/channels/876899628556091432/876908472728453161/1130093073603510312

=== @ Deathrider 07/16/2023 21:48

so the formatting 'works', although it does not seem to be formatting to my .clang-format file

=== @connorjclark (discord: connorclark) 07/16/2023 21:49

Yeah that makes sense, I messed something up.

=== @ Deathrider 07/16/2023 21:51

Ahh here we go, I do have it on my system path
![image](https://cdn.discordapp.com/attachments/1130254410296070295/1130255445223809064/image.png?ex=65e4f0e9&is=65d27be9&hm=aebc0151af8f8e74e87e3a962b5a14ffafbeaad258aceaa09afa832ad7e515a5&)
definitely like 99% there

=== @connorjclark (discord: connorclark) 07/16/2023 21:52

Whats your clang format file look like
Just wanna test with something

=== @ Deathrider 07/16/2023 21:52

```
# Docs:
# https://clang.llvm.org/docs/ClangFormatStyleOptions.html

IndentWidth: 3
NamespaceIndentation: All
IndentCaseLabels: true
AlignAfterOpenBracket: false
UseTab: ForIndentation
ColumnLimit: 999
AllowShortEnumsOnASingleLine: false
AllowShortCaseLabelsOnASingleLine: true
AllowShortFunctionsOnASingleLine: false

BreakBeforeBraces: Custom
BraceWrapping:
  BeforeElse: true
```
![image](https://cdn.discordapp.com/attachments/1130254410296070295/1130255722035294248/image.png?ex=65e4f12b&is=65d27c2b&hm=3265f94f49c16f1ed3e273637cb0c5ab8714dbcd8a33634ba8fb9daedaebb842&)

=== @connorjclark (discord: connorclark) 07/16/2023 21:55

Ah, you can't give `clang-format` a _path_ to a style. So let's just use it's feature of 
"load `.clang-format` file in nearest parent dir"

=== @ Deathrider 07/16/2023 21:55

that sounds like a good idea, that is how prettier and eslint work
if it finds a .prettierrc or .eslintrc they override any base configs so we would be following a standard

=== @EmilyV99 (discord: Emily) 07/16/2023 22:02

I'm not getting any formatting still?

![image](https://cdn.discordapp.com/attachments/1130254410296070295/1130258174226726994/image.png?ex=65e4f373&is=65d27e73&hm=9a8aae1e18ceafa328b18a425e51a82712559f18868288a2f8a83b256fd2fc86&)

=== @connorjclark (discord: connorclark) 07/16/2023 22:02

> Yeah that makes sense, I messed something up.
I'll update when I have `.clang-format` working

=== @EmilyV99 (discord: Emily) 07/16/2023 22:03

(replying to @ Deathrider "so the formatting 'works', al‚Ä¶"): ^ I'm not noticing anything though
but ok will wait for update

=== @connorjclark (discord: connorclark) 07/16/2023 22:03

oh, then yeah rn it should at least format w/ awful defaults

=== @EmilyV99 (discord: Emily) 07/16/2023 22:03

(did you want to get this in repo so I can work on some keyword stuff?)

=== @ Deathrider 07/16/2023 22:04

I will relink a site about that here: https://medium.com/@danromans/how-to-customize-semantic-token-colorization-with-visual-studio-code-ac3eab96141b#:~:text=Now%2C%20with%20the%20needed%20information
currently going to dig into this a little

=== @EmilyV99 (discord: Emily) 07/16/2023 22:04

yeah, that's for handling it per-theme
but I want to actually add keywords to the extension

=== @ Deathrider 07/16/2023 22:05

ohh, well in that case I will wait for that

=== @EmilyV99 (discord: Emily) 07/16/2023 22:05

because like
![image](https://cdn.discordapp.com/attachments/1130254410296070295/1130258956514758776/image.png?ex=65e4f42e&is=65d27f2e&hm=0cbc706c05a27acabd2e0526ebf83fbc88df66517b02050eab2ac8a044ed80cb&)
you can see the darker blue used on types, the lighter teal used on `this`, the other colors for string literals and comments
picking what colors to use, is themes job
....but, it's `darker blue used on types`- it's the extension's job to tell it *what words ARE types*
also, let me just throw some random stuff to keep list of in this thread:
- #option
- unless/until
- namespace
- @Author / annotations
- `CONFIG`/`DEFINE` typedefs (these are std.zh definitions so should probably be highlighted... would we be able to somehow detect all valid typedefs to color any custom type??)
- ^The ability to detect typedefs from the parser would be really cool, I'm guessing `zscript.exe` would need to somehow output that info though? seems like a lot of work. Could probably at least give the user an easy way to list words to use as types, which could have std.zh types as defaults?
- The ability to interact with the parser symbol tables (or a list that has info about them) would be very nice.
 - Being able to see, say, `this->Data` highlighted because it knows `this` is type `genericdata`, which has a member `Data` would be amazing- and it could then also have a description.
 - Likewise, a place to put descriptions for other types of things would be good, like annotations and what they take. I can definitely type up descriptions manually in a new format if we need.

=== @EmilyV99 (discord: Emily) 07/16/2023 22:11

--

=== @connorjclark (discord: connorclark) 07/16/2023 22:21

Re-published, and merged to main.

Emily, see the "for developers" section of the readme.

=== @ Deathrider 07/16/2023 22:25

fantastic, works as desired
confirmed that making changes to my personal file did change the formatter

=== @connorjclark (discord: connorclark) 07/16/2023 22:44

@EmilyV99 (discord: Emily) it should also show you the error message when it fails to format
@ Deathrider is it still eating tons of RAM?

=== @EmilyV99 (discord: Emily) 07/16/2023 22:48

(replying to @connorjclark (discord: connorclark) "@EmilyV99 (discord: Emily) it shou‚Ä¶"): ü§∑‚Äç‚ôÄÔ∏è I see nothing?

=== @connorjclark (discord: connorclark) 07/16/2023 22:48

Should show in popup bottom right
re: making the language server more powerful, here are all the things that are possible (with parser work): https://code.visualstudio.com/api/language-extensions/language-server-extension-guide#additional-language-server-features
We could also add custom commands to the command palette

Like: quick slot, open test mode, open zquest, etc...

=== @EmilyV99 (discord: Emily) 07/16/2023 22:50

*ooooooh*
this sounds super super fancy

=== @connorjclark (discord: connorclark) 07/16/2023 22:51

We could have a file we read from for common test screens you "bookmark"
Something like that
But, I'm pretty much close to burning out after all this so I'm gonna chill for a bit.

Good luck with the grammar stuff

=== @EmilyV99 (discord: Emily) 07/16/2023 22:53

(replying to @connorjclark (discord: connorclark) "@EmilyV99 (discord: Emily) it shou‚Ä¶"): I'm getting literally nothing here

=== @connorjclark (discord: connorclark) 07/16/2023 22:54

You can set a breakpoint in the extension.ts command for the formatter
And see what's happening

=== @EmilyV99 (discord: Emily) 07/16/2023 22:56

err, it's not formatting at all
it's just not recognizing it

=== @connorjclark (discord: connorclark) 07/16/2023 22:57

What version of the plugin do you have

=== @EmilyV99 (discord: Emily) 07/16/2023 22:57

...oh.
I'm stupid.

=== @connorjclark (discord: connorclark) 07/16/2023 22:57

And, did you remove any previous attempts at setting a formatter

=== @EmilyV99 (discord: Emily) 07/16/2023 22:57

I needed to relaunch VSCode.
I'm now getting shitty default formatting.

=== @ Deathrider 07/16/2023 22:58

(replying to @connorjclark (discord: connorclark) "@ Deathrider is it s‚Ä¶"): VS Code? I havent had it open but have had it jump to 700MB. I am hoping that was a freak thing with VSCode

=== @EmilyV99 (discord: Emily) 07/16/2023 22:58

(meta, MessageType.pins_add) 
(meta, MessageType.pins_add) 

=== @ Deathrider 07/16/2023 22:59

also I did find another text field that has that frame reduction thing you had (dmap title and intro). Shall I make a report for that?

=== @connorjclark (discord: connorclark) 07/16/2023 22:59

Yea
Ok if it jumps to all your ram again let me know

=== @EmilyV99 (discord: Emily) 07/16/2023 23:00

and, we didn't have it working for anything but the awful default format yet, or?

=== @connorjclark (discord: connorclark) 07/16/2023 23:00

Because we are sending the entire thing to zscript parser each keystroke. And we may need to get smarter and cancel previous stale edits to free up work
Emily read the readme
It all works now

=== @ Deathrider 07/16/2023 23:01

ohh wow

=== @connorjclark (discord: connorclark) 07/16/2023 23:01

Just put your config  file in the script folder

=== @EmilyV99 (discord: Emily) 07/16/2023 23:01


![image](https://cdn.discordapp.com/attachments/1130254410296070295/1130273146935713832/image.png?ex=65e50165&is=65d28c65&hm=ebf78ce81c4df3e912aa6f97cc4c67067f873a187fdc89834b37a904e6ddf607&)

![image](https://cdn.discordapp.com/attachments/1130254410296070295/1130273176509759498/image.png?ex=65e5016c&is=65d28c6c&hm=7fa5e042a67f1487fd66bc3d13971cebc5dbd2dc2591c4c46c9335ff3429b1bb&)
spot the problem lol

=== @ Deathrider 07/16/2023 23:02

oops

=== @EmilyV99 (discord: Emily) 07/16/2023 23:25

the formatter definitely just seems confused about some stuff though
`UseTab: Always` - it still uses spaces, and the formatting around scripts/enums are both fucked.
bleh

=== @ Deathrider 07/16/2023 23:31

I am just glad we have formatting
this can be greatly expanded on later on, thank yall for expanding on this

=== @EmilyV99 (discord: Emily) 07/16/2023 23:53

@connorjclark (discord: connorclark) What's up with this here? `[.]?`
Is that not just the character class containing `.`, and thus the same exact thing as `.?`?
![image](https://cdn.discordapp.com/attachments/1130254410296070295/1130286086946553937/image.png?ex=65e50d72&is=65d29872&hm=247643b5f19ef1fbca49706a5732f28f4ef720722754c241a07e5f57c3575b38&)

=== @EmilyV99 (discord: Emily) 07/16/2023 23:56

orr, err, no, it's escaping it, duh
...why does that escape it, firstly, and secondly, does `\.` not work for some reason?

=== @connorjclark (discord: connorclark) 07/16/2023 23:59

period inside character class means period, not any.

Yes, you can escape in regex then escape the escape in JSON. For obvious reasons I did not write it like that
https://stackoverflow.com/a/19976308/2788187

=== @EmilyV99 (discord: Emily) 07/17/2023 00:00

ü§∑‚Äç‚ôÄÔ∏è why not use `\\`, you have to do it for `\\b` and `\\d` there anyway

=== @connorjclark (discord: connorclark) 07/17/2023 00:07

I don't understand why this is worth discussing

=== @EmilyV99 (discord: Emily) 07/17/2023 00:07

idk
just kept discussing after the confusion was clarified

=== @connorjclark (discord: connorclark) 07/17/2023 00:08

I'm not gonna agree that being consistent is better than avoiding hard to read escaping lol
There is an alteranative yml format for this grammar definition file
But I was already too far in to make the switch

=== @EmilyV99 (discord: Emily) 07/17/2023 01:21

...Pretty sure `\\b` is just not working right?
It should match word boundaries, correct? So, the 0-length space between any two characters where at least one character is non-alphanumerical?

=== @EmilyV99 (discord: Emily) 07/17/2023 01:22

`\\b(->)\\b` matches the `->` in `Hero->X`, but if I type ` -> ` it does not match it- the boundary between the symbol and the whitespace is not being matched.
Even making an explicit whitespace match (which labels the whitespace as part of the character, not cool) - it became obvious this was a problem when `()` failed to match either the `(` or `)` character

=== @connorjclark (discord: connorclark) 07/17/2023 01:46

You're not missing anything - that's just how it works. https://regex101.com/r/o7cn81/1

=== @connorjclark (discord: connorclark) 07/17/2023 01:49

You'll find it useful to look at a real grammar. See https://github.com/microsoft/vscode-textmate/blob/main/test-cases/themes/syntaxes/c.json#L284

=== @EmilyV99 (discord: Emily) 07/17/2023 01:53

so, how do I define an operator token that actually works appropriately?
as it stands `a==b` would work but `a == b` would not

=== @connorjclark (discord: connorclark) 07/17/2023 01:54

?
![image](https://cdn.discordapp.com/attachments/1130254410296070295/1130316532065501355/image.png?ex=65e529cd&is=65d2b4cd&hm=761955492f1cfa807a60462bad267bff1322cf07f1560e4c789f566544013061&)

=== @EmilyV99 (discord: Emily) 07/17/2023 01:55

...oh, I just don't check a break
...would that not like, match the first 2 characters of `===` though?

=== @connorjclark (discord: connorclark) 07/17/2023 01:58

order implies precedence. put it first.
![image](https://cdn.discordapp.com/attachments/1130254410296070295/1130317580511494194/image.png?ex=65e52ac7&is=65d2b5c7&hm=80e415c4e63875ac7f6bdb7491799e71877ceaf8239c709a62723b543d7a91d4&)
(do we have ===?

=== @EmilyV99 (discord: Emily) 07/17/2023 01:58

except `===` is not an operator in zscript, so it should not match anything

=== @connorjclark (discord: connorclark) 07/17/2023 01:59

i dont know then

=== @EmilyV99 (discord: Emily) 07/17/2023 01:59

we would want `==` to be matched, but `===` to not
which . . . I thought was the point of `\\b`
but apparently not

=== @connorjclark (discord: connorclark) 07/17/2023 01:59

I think you're just discovering the limitations of this class of defining a grammar.

=== @EmilyV99 (discord: Emily) 07/17/2023 02:00

yeah

=== @connorjclark (discord: connorclark) 07/17/2023 02:04

https://regex101.com/r/Wza3DG/1

=== @EmilyV99 (discord: Emily) 07/17/2023 02:13

(replying to @connorjclark (discord: connorclark) "https://regex101.com/r/Wza3DG‚Ä¶"): 
![image](https://cdn.discordapp.com/attachments/1130254410296070295/1130321406421377144/image.png?ex=65e52e57&is=65d2b957&hm=94799ae2645dbe27702987de06ef57b32a3ab25661bb7e5556bb6111f589200e&)
let's see if it works

=== @connorjclark (discord: connorclark) 07/17/2023 02:14

I'll note that as you start reaching for more complex regex's, we slow down the highlighting. So make sure you are testing on big files.
It won't be worth it if it introduces huge lag.

=== @EmilyV99 (discord: Emily) 07/17/2023 02:16

woohoo, that looks like accurate operator boundaries

=== @EmilyV99 (discord: Emily) 07/17/2023 02:35


![image](https://cdn.discordapp.com/attachments/1130254410296070295/1130326993662128128/image.png?ex=65e5338b&is=65d2be8b&hm=77ddffd4bc0b9b0b110c13c6c7a3e60c8b791e1926a09039a50779ea91d4a84d&)
number literal validation when using decimals; extraneous decimals are errored, as are numbers ending in a decimal, and numbers with >4 digits after the decimal (overflow)
(note that `.0` here is shown as valid; which is, in fact, true of ZScript as well, number literals can begin with a dot.)
actually linking this shit to the parser would probably make shit like this easier than regex, but, meh, playing with this for now

=== @EmilyV99 (discord: Emily) 07/17/2023 02:53

(replying to @EmilyV99 (discord: Emily) ""): oh uh, err

![image](https://cdn.discordapp.com/attachments/1130254410296070295/1130331380660838530/image.png?ex=65e537a1&is=65d2c2a1&hm=3230dad26fc88f91a81cd72adb43b98b7243ddbd3b3c20047870ff7ba0084d38&)
`a==!b` would fail to differentiate the two operators, bleh
this is totally not worth bothering with

=== @connorjclark (discord: connorclark) 07/17/2023 02:54

(replying to @EmilyV99 (discord: Emily) "actually linking this shit to‚Ä¶"): the vscode side of that fyi https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#semanticTokensClientCapabilities

=== @EmilyV99 (discord: Emily) 07/17/2023 03:20

wooo
ok I cleaned up the regex some
and now I have not only everything matching token values
but, anything that matches no defined token (which includes a generic 'identifier' token) gets redded out

=== @EmilyV99 (discord: Emily) 07/17/2023 03:22

...which, redded out should only include wholly invalid tokens, not just tokens used wrongly

![image](https://cdn.discordapp.com/attachments/1130254410296070295/1130338829799268432/image.png?ex=65e53e91&is=65d2c991&hm=61cdf75aea6996a392671bfbe11684236a839c32dd024830cd7ca317bc6d20f5&)
For instance, while some of these numbers are wrong, they end up forming subsets of valid tokens (`.423214` is invalid, but `.4232` and `14` are separately valid)
but, `1Status`, is an identifier beginning with a number, something which is NEVER valid.

=== @EmilyV99 (discord: Emily) 07/17/2023 03:31

and, annotation validation
![image](https://cdn.discordapp.com/attachments/1130254410296070295/1130340910085963797/image.png?ex=65e54081&is=65d2cb81&hm=122f42e88e7a97c495644011a67a6e94faf5bd18f984ec472da300e42b54340e&)
(it just highlights a list of things with @ before them as keywords, then any thing else with @ before as error)

=== @EmilyV99 (discord: Emily) 07/17/2023 03:34

also, I notice this highlights top-left instead of on the error line? @connorjclark (discord: connorclark)
![image](https://cdn.discordapp.com/attachments/1130254410296070295/1130341615534358558/image.png?ex=65e54129&is=65d2cc29&hm=e3b348b1bc6403d6950c796310d6a1e2b746089ed0ba4a8604d944d8eb75be32&)
....this appears inline though?
![image](https://cdn.discordapp.com/attachments/1130254410296070295/1130341734581280808/image.png?ex=65e54146&is=65d2cc46&hm=5138d3e87ee9c35ad94b727bcdadac942e6961c2b2b8124fde2fb138ffd52cde&)
so, assuming you just don't have syntax (lexer) errors handled?
(uses a different error system, and a different string format for the line number)

=== @EmilyV99 (discord: Emily) 07/17/2023 03:46

(replying to @EmilyV99 (discord: Emily) "and, annotation validation"): ah, and similar for options
![image](https://cdn.discordapp.com/attachments/1130254410296070295/1130344873376100403/image.png?ex=65e54432&is=65d2cf32&hm=c0a41785ae6c7038f1ba88ac318fd2b0408f915dadd15d01a554954fd9f150f2&)

![image](https://cdn.discordapp.com/attachments/1130254410296070295/1130345066045657098/image.png?ex=65e54460&is=65d2cf60&hm=a40a358c66931d6b12b6be90e3350531d38aff362b6925ca3ecc1f7824155bba&)
Here I just make the valid options be a token themselves
and then any other identifier which has `option[ \t]+` to the immediate left is an error
(this is in a `hash` subenvironment that opens from `begin "#"` to `end "\n"`)

=== @EmilyV99 (discord: Emily) 07/17/2023 03:54

Why did this update here?
![image](https://cdn.discordapp.com/attachments/1130254410296070295/1130346658396373043/image.png?ex=65e545dc&is=65d2d0dc&hm=0d23c69b73b4893fbf2f73ab81bfef57f3a4350aaed8f0d981fc2eb1bc9efcd8&)

=== @EmilyV99 (discord: Emily) 07/17/2023 04:19

also, should probably add `(vscode)` as a target
i.e. `feat(vscode):`, `fix(vscode):`

=== @connorjclark (discord: connorclark) 07/17/2023 04:55

(replying to @EmilyV99 (discord: Emily) "Why did this update here?"): ignore or include, it doesnt matter

=== @connorjclark (discord: connorclark) 07/17/2023 04:59

but for why: because I edited package.json, and package-lock.json updates on `npm install`, and I didn't know that the version field would be part of it.
gotta bump version field for each publish
I'll fix the error parse problem you found and republish

=== @connorjclark (discord: connorclark) 07/19/2023 08:36

Anyone feel like supplying a default clang format configuration?
Since the default is so god awful

=== @connorjclark (discord: connorclark) 07/19/2023 08:39

I'm not finding a way to actualy apply a "default style, if none found on filesystem parent directories". But at the very least we could give a sample config in the extension README.

=== @EmilyV99 (discord: Emily) 07/19/2023 08:39

The problem I'm noticing is it doesn't understand some of our types of scopes at all it seems
no matter what I set I'm getting weird-ass indentations that are complete garbage
(seemingly because it does not understand what a script is?)

=== @connorjclark (discord: connorclark) 07/19/2023 08:41

Ah, we may be asking too much of it then.
Even the format off/on comments don't help?
(I know it's super lame to add them, but we could possibly inject them automatically then remove before writing back the formatted code...)
anything to avoid actually writing a formatter lol
maybe you'd be interested in using our parser to do that, but i'm not
(replying to @connorjclark (discord: connorclark) "I'm not finding a way to actu‚Ä¶"): oh we could just do the parent-directories-crawl ourselves to see if a config file is present already first

=== @ Deathrider 07/19/2023 13:12

(replying to @connorjclark (discord: connorclark) "Anyone feel like supplying a‚Ä¶"): You could use the one I provided
```
# Docs:
# https://clang.llvm.org/docs/ClangFormatStyleOptions.html

IndentWidth: 3
NamespaceIndentation: All
IndentCaseLabels: true
AlignAfterOpenBracket: false
UseTab: ForIndentation
ColumnLimit: 999
AllowShortEnumsOnASingleLine: false
AllowShortCaseLabelsOnASingleLine: true
AllowShortFunctionsOnASingleLine: false

BreakBeforeBraces: Custom
BraceWrapping:
  BeforeElse: true
```
I even had the docs so ppl can add their own rules

=== @ Deathrider 07/19/2023 13:53

Could probably remove some of the more opinionated stuff
Then again it shows the format of how to create the rules so idk

=== @EmilyV99 (discord: Emily) 08/05/2023 01:50

(meta, MessageType.pins_add) 

=== @ Majora 08/05/2023 01:52

oh right

=== @EmilyV99 (discord: Emily) 08/05/2023 10:02

OK, well, I understood enough about the VSCode extension stuff to add a new setting `alwaysInclude`, which takes an array of strings, and treats them as filepaths to add `#include "%s"\n` to the top of the tempfile before compilation

=== @EmilyV99 (discord: Emily) 08/05/2023 10:03

by default, I have it set to `["std.zh"]` to include the standard header- questmakers could add their project-specific main file here to not need to include it from every file.

=== @EmilyV99 (discord: Emily) 08/05/2023 10:08

(doing everything I do on this in a branch for now)

=== @connorjclark (discord: connorclark) 08/05/2023 10:08

https://discord.com/channels/876899628556091432/876908472728453161/1130255331348463696 ?

=== @EmilyV99 (discord: Emily) 08/05/2023 10:09

It's on a branch so we can discuss it more, but I feel like this is kinda necessary
how would you do this in the parser itself?

=== @connorjclark (discord: connorclark) 08/05/2023 10:10

I don't know anything beyond parser main fn lol
maybe can just decrement the line number from each error by how ever many lines you prepended by?
in vscode extension

=== @EmilyV99 (discord: Emily) 08/05/2023 10:10

ah, right, that's the issue
that would make sense?
...or, I could add them to the BOTTOM of the file?
(order doesn't matter to zscript)

=== @connorjclark (discord: connorclark) 08/05/2023 10:11

(replying to @EmilyV99 (discord: Emily) "(order doesn't matter to zscr‚Ä¶"): ...wow ok thats kinda great

=== @EmilyV99 (discord: Emily) 08/05/2023 10:12

It USED to
but then include order was REALLY complicated
and you could end up with stuff that effectively translated to this issue:
```cpp
const int A = B;
const int B = 5;
const int C = B;```
Whatever order you parse this in, it doesn't work
either A or C will error that B has yet to be declared
so, the only way to handle this situation was to make it not care about order- this is the entire `RegistrationVisitor` phase
It basically analyzes everything, but soft-fails anything that might be fixed by scanning another pass through the files
so, undeclared variable? that might be declared later, so just set it aside for now, and check it again on a second pass
...declaring a `void` variable? that can't be fixed by anything in the future, so that can immediately error still
undefined type, could be fixed by a typedef later, etc
and it just runs passes until it either `1. Makes no progress`, `2. Hits an arbitrary recursion limit`, `3. Finishes registering every AST node`
this was one of my first big parser *redesign* level features

=== @EmilyV99 (discord: Emily) 08/05/2023 10:17

(replying to @EmilyV99 (discord: Emily) "...or, I could add them to th‚Ä¶"): So, this does fix the issue, though bad syntax errors near end of file might get fucked up by it. Might do error line number reduction instead...

=== @connorjclark (discord: connorclark) 08/05/2023 10:22

sounds reasonable
you'll have to check it is for the entry file too
though I don't think currently I even parse for a file name
i guess you can ignore it, i don't even know what happens now if an error comes up from processing an include

=== @EmilyV99 (discord: Emily) 08/05/2023 10:25

also, you handled the lexer syntax error
but not manually-thrown syntax errors thrown via `yyerrmsg`
like unclosed QUOTEDSTRING

=== @EmilyV99 (discord: Emily) 08/05/2023 10:44

. . . you know, it's probably saner
to use 2 temp files?
have one be the always-includes, and an include of the other?

=== @EmilyV99 (discord: Emily) 08/05/2023 11:31

OK, I love being stupid and fucking up basic coding things
that took like an extra half hour just debugging my own PURE STUPIDITY lmao

=== @EmilyV99 (discord: Emily) 08/05/2023 11:32

Here we have this error being properly caught (this error's syntax was not caught before to give it proper location data)
![image](https://cdn.discordapp.com/attachments/1130254410296070295/1137347393856221224/image.png?ex=65ec48cd&is=65d9d3cd&hm=7c6c2f42dd2376677b45269696938a740dbc2f96b2407e15dc76f41d2bd9eaa5&)
also, I made an intentional typo in `std.zh` to create an artificial compile error

=== @EmilyV99 (discord: Emily) 08/05/2023 11:35

It didn't give me any error output in this file, while I had an error in this file
though once this file is fine, I get the fallback you set up here:
![image](https://cdn.discordapp.com/attachments/1130254410296070295/1137348316414353479/image.png?ex=65ec49a9&is=65d9d4a9&hm=84ae0ef25f7e7e2aaabaf2f1a6e58dca14e3f4f433f58ab368dbf05891b79d2b&)

![image](https://cdn.discordapp.com/attachments/1130254410296070295/1137348447297605682/image.png?ex=65ec49c8&is=65d9d4c8&hm=a52fbd0c6d6dcacbe33c86a6438579459732c3a0417bd2b44113584ba09f7601&)
just dumping the whole output in an error
....for now this is fine, it's better than what it did before
if you want to fancy up errors from dependencies, feel free
I'm just mostly doing this
![image](https://cdn.discordapp.com/attachments/1130254410296070295/1137348674943467591/image.png?ex=65ec49ff&is=65d9d4ff&hm=a2007ac72cfc5712aa91f2f1238021ae6c100ebfc75404dab02330f1b0b379af&)

=== @EmilyV99 (discord: Emily) 08/05/2023 11:44

Did handle a special error case for errors in the other temp file:
![image](https://cdn.discordapp.com/attachments/1130254410296070295/1137350512946188338/image.png?ex=65ec4bb5&is=65d9d6b5&hm=463e576071d31e71c2510b5080c197aa9b1d7f5e4bc657ff21529703f30aa1e2&)
in this case I added that gibberish as an `alwaysInclude` entry, which obviously creates an error at that include due to file not found
....hmm, I can probably make this spit out like this for any other errors as well.

=== @EmilyV99 (discord: Emily) 08/05/2023 11:54

(no these aren't showing on the include, they are showing at the top-left of the file)
![image](https://cdn.discordapp.com/attachments/1130254410296070295/1137353023698509884/image.png?ex=65ec4e0b&is=65d9d90b&hm=b84e83bae34904271665b57ed24cbea797b889e80290b1cdce32d4ba202b49cf&)

=== @EmilyV99 (discord: Emily) 08/05/2023 12:01

@connorjclark (discord: connorclark) `vscode-exp` branch if you'd like to take a look, just pushed. Feel free to reformat how it's outputting however, I've just got it giving sane-sounding errors that don't look buggy themselves.

=== @EmilyV99 (discord: Emily) 08/05/2023 12:29

. . . peeking into some docs trying to figure out how to do more fancy things, I noticed that this might be a problem
![image](https://cdn.discordapp.com/attachments/1130254410296070295/1137361855652827176/image.png?ex=65ec5645&is=65d9e145&hm=3aed315caffc910b8ce01bcf18644d5bfd64fa1c349ecb76a69f1a17e86dfc55&)

=== @EmilyV99 (discord: Emily) 08/06/2023 08:49

ahk, well
I just did some tweaks to the handling of `CONST_ASSERT` statements

=== @EmilyV99 (discord: Emily) 08/06/2023 09:58

and added an option for default include PATHS as well as default includes
and the "temp buffer" it's compiling is now printed out if the print compiler output option is on
and I've realized a complex issue

=== @EmilyV99 (discord: Emily) 08/06/2023 10:01

so TODO: in `async function processScript`, I need a way to get the absolute path of the original document, @connorjclark (discord: connorclark). Because if the user includes something that *includes the original document*, it will be duplicate-included with the tempfile version.... which will cause numerous errors.
To fix this, I need to handle something in the parser, to allow a commandline arg to *ignore* includes that resolve to a specified file, so that the original file can be ignored to avoid duplication errors.
...I should be able to handle most of this, except I don't see how to get an absolute path of the document from what I have available there. Any help you can offer, connor?

=== @connorjclark (discord: connorclark) 08/06/2023 10:11

it's the `textDocument.uri` but it is in URI format (so file:// protocol)
fyi in case you didnt figure this out yet, this is where you look to see w/e you console.log'd
![image](https://cdn.discordapp.com/attachments/1130254410296070295/1137689389363904552/image.png?ex=65e44ccf&is=65d1d7cf&hm=20017b4b047923090cd1edc062710fc45b56f06b6b1a2633c43326be491ecf1f&)

=== @connorjclark (discord: connorclark) 08/06/2023 10:13

```js
connection.console.log(textDocument.uri);
connection.console.log(new URL(textDocument.uri).pathname);
```

=== @connorjclark (discord: connorclark) 08/06/2023 10:14

i thinks it super noisy b/c i configured it to print protocol traffic but you can turn that off in your settings
![image](https://cdn.discordapp.com/attachments/1130254410296070295/1137690252539080746/image.png?ex=65e44d9d&is=65d1d89d&hm=eac15aed1159e4d8acc3a1309a5bd193595657db6a9e237921cf9b5c02fdda0e&)
i never figured out how to attach a debugger to the server, would be way easier
anyway, what you asked for is just this: `new URL(textDocument.uri).pathname`

=== @EmilyV99 (discord: Emily) 08/06/2023 10:15

ahk, lovely
stackoverflow answers gave me several functions that didn't exist when I looked lol
and yeah, I've been using the logging

=== @EmilyV99 (discord: Emily) 08/06/2023 10:17

so, here's what I've just accomplished, btw

![image](https://cdn.discordapp.com/attachments/1130254410296070295/1137690913989206117/image.png?ex=65e44e3b&is=65d1d93b&hm=efb858c0d579065cb15418c3d5b387feaed4414260b2ada7da86fcc56a546549&)
note that BOTH the `npc n = 1` and `npc y = 2` errors are highlighted at once - the temp buffer now adds `#option NO_ERROR_HALT on` as a default setting adjustment, which allows multiple error outputs to occur

=== @EmilyV99 (discord: Emily) 08/06/2023 10:19

and, I did a fair bit of work with `CONST_ASSERT` stuff. They now are *stored* instead of 'thrown' by the parser via a switch, and they get thrown at the end all together- except, based on a setting, it can *ignore* those errors and compile successfully regardless.

=== @EmilyV99 (discord: Emily) 08/06/2023 10:21

This is a good option as, if you're making a database script with no particular test quest, you might want to leave values set in ways that error CONST_ASSERTs- the point being so that the end user must set the values themselves, and the CONST_ASSERTS give them clear error messages as to what needs to be set.

However, if you're editing scripts for your quest project, you need to compile it for your quest, and you want to be alerted if any of those asserts fail, so you know what constants you still need to set.

Simple enough to manage.

=== @EmilyV99 (discord: Emily) 08/06/2023 10:22

(replying to @EmilyV99 (discord: Emily) ". . . peeking into some docs‚Ä¶"): also, `NO_ERROR_HALT` may actually be good enough for this? Or if not maybe tweakable enough... so maybe this fancy stuff will be possible. It looks SUPER complicated though and feels a bit beyond me...

=== @EmilyV99 (discord: Emily) 08/06/2023 10:31

(replying to @connorjclark (discord: connorclark) "anyway, what you asked for is‚Ä¶"): this gives `/c%3A/Users/Emily/Documents/ZC/ScriptBank/FFCElevator.zs`... just a little bit off...

=== @EmilyV99 (discord: Emily) 08/06/2023 10:40

ahk
by adding `vscode-uri` dependency, I can use `URI.parse(textDocument.uri).fsPath`, which gives me `c:\Users\Emily\Documents\ZC\ScriptBank\FFCElevator.zs`

=== @EmilyV99 (discord: Emily) 08/06/2023 12:01

oookay
and I had some issues with how we handled relative paths and paths including `/..`
but `std::filesystem::path` handles that stuff very nicely
Here's an output from a parsing attempt:```cpp
Attempting to compile buffer:
-----
#option NO_ERROR_HALT on
#option HEADER_GUARD on
#includepath "include"
#includepath "C:\Users\Emily\Documents\ZC\ScriptBank"
#include "FFCElevator.zs"
#include "include/std.zh"
#include "C:\Users\Emily\AppData\Local\Temp\tmp.zs"

-----
Compiling 'C:\Users\Emily\AppData\Local\Temp\tmp2.zs'
Pass 1: Parsing
Pass 2: Preprocessing
Pass 3: Registration
Pass 4: Analyzing Code
Pass 5: Generating object code
Pass 6: Assembling
Success!
Compile finished with exit code '0' (success)```

=== @EmilyV99 (discord: Emily) 08/06/2023 12:04

Note that `FFCElevator.zs` here is set to always be included... but it is ALSO the file I am editing, `C:\Users\Emily\AppData\Local\Temp\tmp.zs`! This would normalyl cause a duplciation issue, but the switch `-force_ignore C:\Users\Emily\Documents\ZC\ScriptBank\FFCElevator.zs` is being supplied

=== @EmilyV99 (discord: Emily) 08/06/2023 12:05

this causes the parser to check each include against that path, and any matching include is *disabled and ignored*. As such, the `#include "FFCElevator.zs"` here has no effect, and the tempfile DOES, compiling the most recent edits of the file.

=== @connorjclark (discord: connorclark) 08/06/2023 17:45

I haven't tested yet, but I see in the server code you look to be assuming windows style path in some regex normalization, is that right?

=== @EmilyV99 (discord: Emily) 08/06/2023 17:50

I'm checking for a Windows style path
Because the URI.fsPath handles it wrong

=== @EmilyV99 (discord: Emily) 08/06/2023 17:52

I would hope non-windows paths would be handled right by defaukt
but I have no good way to check

=== @connorjclark (discord: connorclark) 08/06/2023 18:04

it does not work
and yes, `cleanupFile` is changing from a native path to a windows format.
after removing that:

> "Error in temp file (check your ZScript Extension settings):\nError P083: Could not find included file 'var/folders/40/3t66ckdn5wdb01f456nd_r0r0000gn/T/tmp.zs'. Please check your include paths!",

=== @EmilyV99 (discord: Emily) 08/06/2023 18:06

ah, err,
just make that function switch to the correct slash for the filesystem
I would think

=== @connorjclark (discord: connorclark) 08/06/2023 18:07

you really should not need to do anything like this when working with paths

=== @EmilyV99 (discord: Emily) 08/06/2023 18:07

...it needs to be in the same format ZC uses for the matching filesystem
idk
didn't see a better way
and it was a lot of work to get it working at all for this issue not being a problem
(was also kinda tired af, so, might have missed something, but I dug through a lot)

=== @connorjclark (discord: connorclark) 08/06/2023 18:09

(replying to @connorjclark (discord: connorclark) "after removing that:

> "Erro‚Ä¶"): I got the inputs zscript is getting to be normal paths `/var/whatever/...` yet get this error
So is parser stripping the first char?

=== @EmilyV99 (discord: Emily) 08/06/2023 18:09

...maybe, probably in some function I copied

=== @connorjclark (discord: connorclark) 08/06/2023 18:23

it's existing broken code

![image](https://cdn.discordapp.com/attachments/1130254410296070295/1137813199312400514/image.png?ex=65e4c01e&is=65d24b1e&hm=1e2fe6155e1dd3b7d3f3f410914d03c83ebcd67a3296ec0edd55bf091d286847&)

=== @connorjclark (discord: connorclark) 08/06/2023 18:26

so this code is resolving a include path
but if it is absolute it should just skip this process

=== @EmilyV99 (discord: Emily) 08/06/2023 18:29

aye, probably. Don't have a detector for absolute paths or I would have used that.

=== @connorjclark (discord: connorclark) 08/06/2023 18:30

std::filesystem::path(importname).absolute()

=== @connorjclark (discord: connorclark) 08/06/2023 18:32

> ZQ_BUFFER Line 1 @ Column 1 - Line 27 @ Column 2 - Error S011: Script CircularMotion needs a void runl() function.

?

=== @EmilyV99 (discord: Emily) 08/06/2023 18:33

(replying to @connorjclark (discord: connorclark) "> ZQ_BUFFER Line 1 @ Column 1‚Ä¶"): ...you changed the config for the name of the void run function?
from `run` to `runl`?

![image](https://cdn.discordapp.com/attachments/1130254410296070295/1137815920438427789/image.png?ex=65e4c2a7&is=65d24da7&hm=94904095bbaf59a7db265031b11866c3d2563216bf7f0ecec50c80e7a2f94591&)

=== @connorjclark (discord: connorclark) 08/06/2023 18:34

Is this some default? B/c i changed nothing here

=== @EmilyV99 (discord: Emily) 08/06/2023 18:34

run is the default
you must have accidentally changed it?

=== @connorjclark (discord: connorclark) 08/06/2023 18:35

i guess this is a really old cfg in my debug folder

=== @EmilyV99 (discord: Emily) 08/06/2023 18:35

or a file storing the setting got corrupted or something
or is just old

=== @connorjclark (discord: connorclark) 08/06/2023 18:35

i recall changing this a long time ago
to test errors
thanks past self

![image](https://cdn.discordapp.com/attachments/1130254410296070295/1137816432978178151/image.png?ex=65e4c321&is=65d24e21&hm=1c16e8ff2fc850cd1538ee4663e23d98f40fd25bc612358b95a1991ee54b449b&)
wrong location
ok I've got paths working again, I'll push and let you take it from here

=== @EmilyV99 (discord: Emily) 08/06/2023 18:38

if the paths are working properly for all os's this should probably be merged and you should push an update for the extension

=== @connorjclark (discord: connorclark) 08/06/2023 18:38

The above is a big problem.
Line/col is wrong and filename is wrong
Also, you should test again on your end. I don't wanna do more testing on this today

=== @EmilyV99 (discord: Emily) 08/06/2023 18:39

oh shit why is it wrong

=== @connorjclark (discord: connorclark) 08/06/2023 18:40

also curious there is a trailing space in that filename
at least, in the error message

=== @EmilyV99 (discord: Emily) 08/06/2023 18:44

(replying to @connorjclark (discord: connorclark) "Also, you should test again o‚Ä¶"): Not much I can do when it works 100% on windows
![image](https://cdn.discordapp.com/attachments/1130254410296070295/1137818528905449562/image.png?ex=65e4c514&is=65d25014&hm=ac0b8b59674d6446f0aaa2fc4d76fc48f04117eec1622fefd4d03537a592de9b&)
(replying to @connorjclark (discord: connorclark) ""): ....the trailing space on the file name there is worrying.
. . . but, you're skipping `cleanupFile()` entirely
one of the things which it did being `trim()` the string?
maybe that's the only issue, is that it still needs to `trim()`

=== @connorjclark (discord: connorclark) 08/06/2023 18:48

yes that was it
i added a fixup commit
(you would squash before merging to main, `git rebase HEAD~10 -i --autosquash` just kinda does it for you since it is a "fixup" commit)

=== @EmilyV99 (discord: Emily) 08/06/2023 18:50

after what happened to Moosh I am reluctant to touch any git commands I'm not familiar with already lmao
`git rebase` fucked his branch up something nasty

=== @connorjclark (discord: connorclark) 08/06/2023 18:51

all autosquash does it present you with the normal interactive rebase interface but assigns fixups commits to the right place
anyway, fine, just don't merge it yourself and let me do it

=== @EmilyV99 (discord: Emily) 08/06/2023 18:52

"the normal interactive rebase interface"
sounds like what fucked moosh up
so
üëç more than happy letting you do it lol

=== @connorjclark (discord: connorclark) 08/06/2023 19:06

I suspect some combination of a merge commit being present (I think this tends to mess up rebasing) or rebasing with the wrong branch is what happened there
We may figure out what happened later tonight
