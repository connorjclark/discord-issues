## ‚ùåLayered Lock Blocks Don't Work by Default (#1518)
@ Orithan opened this issue on 04/07/2022
Status: fixed
Tags: 
Source: #old-bug-reports https://discord.com/channels/876899628556091432/961592870505160724


=== @ Orithan 04/07/2022 11:46

``\19\dmap\screen\register\value``: The ``value`` arg sets that corresponding register to ``value/10000``. SCCs cannot pick up floating point values, which makes you have to put in the numbers in increments of 10000 to make SCCs check it.

=== @ Orithan 04/07/2022 12:34

Apparently it magically fixed itself?

=== @ Orithan 04/07/2022 12:36

Regardless I found some spooky gremlins in SCCs
If you type in letters as part of the arg in the middle of an SCC by error, ZQ will corrupt the SCC
``\19\10\2C\0\1`` became ``\19\10\2\66\0\1\83\103`` when reloaded
This is in the current Nightly

=== @EmilyV99 (discord: Emily) 04/07/2022 12:49

well, yeah
that's since 2.50.2
because of how sccs work
not fixable
`C` is `66`

=== @ Orithan 04/07/2022 12:50

So accidentally typing letters into SCCs leads to SCC corruption and it cannot be fixed?

=== @EmilyV99 (discord: Emily) 04/07/2022 12:50

so `\19\10\2\66` is literally the same string as `\19\10\2C`
It's not any weird corruption
it's just doing what you type
when you enter a number after a slash
it's entering a direct ascii value
but any ascii values that are outside the range of normal text characters
are treated as sccs

=== @ Orithan 04/07/2022 12:51

``\23\61\0\0\1\90`` is switching to String 31

=== @EmilyV99 (discord: Emily) 04/07/2022 12:51

and after it starts an scc, it looks for that sccs parameters

=== @ Orithan 04/07/2022 12:51

Instead of String 90 as per the arg

=== @EmilyV99 (discord: Emily) 04/07/2022 12:51

??
fun

=== @ Orithan 04/07/2022 12:52

Replicated it?

=== @EmilyV99 (discord: Emily) 04/07/2022 12:52

no, I'm not on my desktop
so I can't touch anything right now
which code is `\23`?

=== @ Orithan 04/07/2022 12:54

``\23\dmap\screen\register\value\newstring - same as \3, but for a remote dmap/screen``

=== @EmilyV99 (discord: Emily) 04/07/2022 12:54

yay zoria
that'll be fun to look into
@arceusplayer11 (discord: Deedee) adding you to this thread

=== @ Orithan 04/07/2022 12:55


![image](https://cdn.discordapp.com/attachments/961592870505160724/961610059777966110/2022-04-07_22-52-36.mp4?ex=65e9b928&is=65d74428&hm=f0d01ef4911b58a3525d1b8d195cff15280e8c758802b8a6b8086ec7af0493f1&)

![image](https://cdn.discordapp.com/attachments/961592870505160724/961610236949577728/Untitled.png?ex=65e9b952&is=65d74452&hm=561c28dd11947c2c5768dacc131a9a6b9886b18254afa2f1660c00f3ed60125d&)

=== @arceusplayer11 (discord: Deedee) 04/07/2022 12:56

ughh.

=== @EmilyV99 (discord: Emily) 04/07/2022 12:56


![image](https://cdn.discordapp.com/attachments/961592870505160724/961610396521885716/unknown.png?ex=65e9b978&is=65d74478&hm=6dd9631fca2988c52d01d1ee6569329ed6ccaa487e347dd8fb4e0e72d0956804&)
what are all of these?
(don't have the reference on hand)

=== @ Orithan 04/07/2022 12:58

```
\2\newspeed - Text Speed. Changes the length of the delay between text characters appearing. 
If 0, text appears instantaneously. Argument 1 is the speed.
```
```
\19\dmap\screen\register\value - Sets Screen->D[reg] for dmap, screen, to value.
```
```
\29 - Immediately exits the current string. If there is a 'next string', it will begin immediately.
      The prompt to press 'A' to continue will be skipped.
```
```
\30 - Pauses the string and prompts the player to press A to continue
      (as normally occurs at the end of a string)
```
I noticed that \29 was not taking effect
So yay. I ended up playing with Zoria's janky stuff

=== @EmilyV99 (discord: Emily) 04/07/2022 12:59

(replying to @ Orithan "I noticed that \29 was not ta‚Ä¶"): oh?
You are having to press A twice to advance to string 90?

=== @ Orithan 04/07/2022 13:00

If you watch the video closely, you can see that I had to press A twice to advance to String 90 on the first read

=== @EmilyV99 (discord: Emily) 04/07/2022 13:00

that's odd
that's my recent addition
and it was working fine last I checked
So, do you use the manual re-ordering the strings much?
If so, does string 31 it's sending you to happen to be near the 90th position?

=== @ Orithan 04/07/2022 13:01

Okay I didn't have to
But the String->Next icon appeared afterwards
(replying to @EmilyV99 (discord: Emily) "So, do you use the manual re-‚Ä¶"): No
89 and 90 are back to back in the string editor

=== @EmilyV99 (discord: Emily) 04/07/2022 13:02

oh
zoria
you dumbass
It's eating one too many parameters
32 is the ascii value for spacebar
and sccs are stored at their value + 1 to avoid null char issues
so an ascii 32 (spacebar) is being read as `string 31`
fucking beautiful zoria

=== @ Orithan 04/07/2022 13:05

So I guess I'm waiting for the next nightly to use this SCC
AFIAK SCCs need a non-Null character afterwards to work

=== @EmilyV99 (discord: Emily) 04/07/2022 13:06

no, they don't
that one does
because of the bug
(replying to @ Orithan "But the String->Next icon app‚Ä¶"): How long does it appear for? Is it 1 frame?

=== @ Orithan 04/07/2022 13:08

No I have to press it again

=== @EmilyV99 (discord: Emily) 04/07/2022 13:08

...oh, wait, and is it NOT appearing when you have the `\30` active?

=== @ Orithan 04/07/2022 13:08

Did frame advance, confirmed it was not showing up for just one frame
It the icon appeared once when the ``\30`` is called and then I had to press the button again at the end of the string
It will also advance if the button is held

=== @arceusplayer11 (discord: Deedee) 04/07/2022 13:18

@EmilyV99 (discord: Emily) have moral support! <a:bunluv:876927395402223616>

=== @EmilyV99 (discord: Emily) 04/07/2022 13:22

<a:hugheart:884673091878391828>

=== @EmilyV99 (discord: Emily) 04/07/2022 13:37

so
(replying to @ Orithan "``\19\dmap\screen\register\va‚Ä¶"): this....
(replying to @ Orithan "Apparently it magically fixed‚Ä¶"): magically fixed itself
(replying to @ Orithan "If you type in letters as par‚Ä¶"): This is just how SCCs work, no bug to be had
(replying to @ Orithan "AFIAK SCCs need a non-Null ch‚Ä¶"): Turns out this was fucking true due to weird, should be fixed
(replying to @ Orithan "But the String->Next icon app‚Ä¶"): This should no longer appear when terminating a string with `\29`
(replying to @ Orithan "``\23\61\0\0\1\90`` is switch‚Ä¶"): and this should be fixed

=== @EmilyV99 (discord: Emily) 04/07/2022 13:39


https://cdn.discordapp.com/attachments/961592870505160724/961621321945587782/zquest.exe?ex=65e9c3a5&is=65d74ea5&hm=c65e32cf1dbf46c4ecbb70a90cfa22e381a878069dbc76aadf56e671f8ca4dda&
https://cdn.discordapp.com/attachments/961592870505160724/961621322620862464/zelda.exe?ex=65e9c3a5&is=65d74ea5&hm=21f2dd2bfabac2a0d642c2c85e86a1e9c463fb4e6a46b840e4d6510eeaa5d42c&

=== @ Orithan 04/07/2022 13:39

(replying to @EmilyV99 (discord: Emily) "magically fixed itself"): I recalled it only working if I check for 10000 until I did other things and then it works when I check for 1

=== @EmilyV99 (discord: Emily) 04/07/2022 13:41


![image](https://cdn.discordapp.com/attachments/961592870505160724/961621659851325530/unknown.png?ex=65e9c3f5&is=65d74ef5&hm=62126bb532006f85c87a9811b0103da0a4d774cf5b29cbf6718f1624e4a493c9&)
seems to use a raw value there

=== @ Orithan 04/07/2022 13:42

(replying to @EmilyV99 (discord: Emily) "This should no longer appear‚Ä¶"): This persists
(replying to @EmilyV99 (discord: Emily) "and this should be fixed"): This is fixed

=== @EmilyV99 (discord: Emily) 04/07/2022 13:43

(replying to @ Orithan "This persists"): Can't replicate
So, the screen->d
I think it may be /10000
which, is the only way it can ever possibly interact with decimal values
but uhhh
oh, I was gonna say the mapdata access looks fucked up
but that's fucked anyway because it needs to be dmap based
so nevermind
It does appear that `10000` in scc would be `1` in zscript
but, if that weren't how it worked, you would never be able to check anything decimal

=== @ Orithan 04/07/2022 13:47

(replying to @EmilyV99 (discord: Emily) "Can't replicate"): Even with the exact string and next string?

=== @EmilyV99 (discord: Emily) 04/07/2022 13:47

no, I didn't type everything out
but doing a `\30` to pause

=== @ Orithan 04/07/2022 13:47

Gonna try a few things

=== @EmilyV99 (discord: Emily) 04/07/2022 13:47

and then a `\29` to quit
frame advance shows no nextstring icon
and it definitely shouldn't
because I took the book that's set when `\29` is read
and made it so that if that's true, the draw call does not occur
it should be FORCIBLY skipping that draw

=== @ Orithan 04/07/2022 13:49

It's not running at all on my string

=== @EmilyV99 (discord: Emily) 04/07/2022 13:49

that's confusing

https://cdn.discordapp.com/attachments/961592870505160724/961623980396118047/str.qst?ex=65e9c61f&is=65d7511f&hm=f1ba86ffdc71f9f13c5ab7430a82021989064d53b90180882d4b7a4ac0bd43f2&

=== @ Orithan 04/07/2022 13:55

It works on your file

=== @EmilyV99 (discord: Emily) 04/07/2022 14:03

can you at all figure out what's making it work vs not?

=== @ Orithan 04/07/2022 14:05

The first place I'd look is quest rules

=== @EmilyV99 (discord: Emily) 04/07/2022 14:14

(meta) thread name was changed: üíäüîìString Control Code 19 (Set Screen D[] register) does not set right value.

=== @ Orithan 04/07/2022 14:17

String Control Code 29 is doing some reeeal cursed stuff on this quest
Did another string
Or was

=== @EmilyV99 (discord: Emily) 04/07/2022 14:20

oh hmm, could it be message speed 0?
it's probably message speed 0

=== @ Orithan 04/07/2022 14:23

Removed that and it still did not work

=== @EmilyV99 (discord: Emily) 04/07/2022 14:25


https://cdn.discordapp.com/attachments/961592870505160724/961632906898473010/zquest.exe?ex=65e9ce6f&is=65d7596f&hm=57a5cd8d5acfbd59d8abb3eaee104fdc492fd0cd6646686ff9af06415e3c659c&
https://cdn.discordapp.com/attachments/961592870505160724/961632907552780318/zelda.exe?ex=65e9ce6f&is=65d7596f&hm=dd909925fba6770de3cb500ad94ba28e9947ccb2e3703853ec0cce4878e661a1&
How about this?
Added several safeguards to the function
it shouldn't be able to do anything funky now

=== @ Orithan 04/07/2022 15:18

I just loaded and the strings with SCCs right before the Null string all became garbled
Geezus this is cursed...

=== @EmilyV99 (discord: Emily) 04/07/2022 15:19

? Garbled how?

=== @ Orithan 04/07/2022 15:20

And the garbling went away when I reloaded the file from jumping from another

=== @EmilyV99 (discord: Emily) 04/07/2022 15:20

????????????????????????????

=== @ Orithan 04/07/2022 15:20

The string table is cursed

=== @EmilyV99 (discord: Emily) 04/07/2022 15:20

Clearly

=== @EmilyV99 (discord: Emily) 04/07/2022 15:24

nice recording of ZCL

=== @ Orithan 04/07/2022 15:27


![image](https://cdn.discordapp.com/attachments/961592870505160724/961648468131201044/2022-04-08_01-24-42.compressed.mp4?ex=65e9dced&is=65d767ed&hm=b6a8ef960fe85b719369a3f916adb84a16741685d0f189808369a8af9f85b3cf&)
It's random values every time

=== @ Orithan 04/07/2022 15:29

And it's the same story when playing in ZC. First load its garbled, after reload its not

=== @EmilyV99 (discord: Emily) 04/07/2022 15:29

wh-what
@arceusplayer11 (discord: Deedee)
DEEDEE GET IN HERE
For the record, literally nothing I changed in this thread was in ZQuest

=== @ Orithan 04/07/2022 15:30

Like I said, this quest was made during alphas where the string table corruption issue was a thing
This might be a relic of that

=== @EmilyV99 (discord: Emily) 04/07/2022 15:31

well, it was last saved in a current build, yes?
if so, then it should *NEVER CHANGE ON RELOAD*

=== @ Orithan 04/07/2022 15:31

In an older build

=== @EmilyV99 (discord: Emily) 04/07/2022 15:31

ok
resave it in this build then?

=== @ Orithan 04/07/2022 15:31

The build it was last saved in was the build before the one you just sent

=== @EmilyV99 (discord: Emily) 04/07/2022 15:31

like
was it last saved today
or in a build when the string table stuff
if it was last saved in any build today

=== @ Orithan 04/07/2022 15:32

(replying to @EmilyV99 (discord: Emily) "was it last saved today"): Today

=== @EmilyV99 (discord: Emily) 04/07/2022 15:32

then yeah
that's a current build
so

=== @arceusplayer11 (discord: Deedee) 04/07/2022 15:32

wtf

=== @EmilyV99 (discord: Emily) 04/07/2022 15:32

that's REALLY not good
my fixes today aren't even in ZQ, so nothing should have changed
well, except the fix for #1517
but that is entirely unrelated to strings

=== @ Orithan 04/07/2022 15:33

Saving is not fixing it.

=== @EmilyV99 (discord: Emily) 04/07/2022 15:33

yeah, if you last saved today
then that wouldn't
thus the problem
the point was, had you last saved before or after deedee supposedly fixed corruption
if before, well, resave
if after, well, PANIC BUTTON WHAT THE FUCK

=== @ Orithan 04/07/2022 15:34

It first cropped up in the build you posted here right before this one

=== @EmilyV99 (discord: Emily) 04/07/2022 15:34

???

=== @ Orithan 04/07/2022 15:34

Its notable that it's not affecting the test quest you sent me
Its anything that has the /29

=== @EmilyV99 (discord: Emily) 04/07/2022 15:34


![image](https://cdn.discordapp.com/attachments/961592870505160724/961650268741722122/unknown.png?ex=65e9de9a&is=65d7699a&hm=6a8d305d744db3cbcd1289139bd25dae73031fa29a49ad1379d240daf9449816&)
these are my changes to ZQuest today
so
nothing new would be occurring in zquest from my builds today
other than the item loading thing being fixed

=== @arceusplayer11 (discord: Deedee) 04/07/2022 15:35

String stuff isn't my forte

=== @EmilyV99 (discord: Emily) 04/07/2022 15:35

(replying to @ Orithan "Its anything that has the /29"): What the fuck, why that specifically?

![image](https://cdn.discordapp.com/attachments/961592870505160724/961650516264374282/unknown.png?ex=65e9ded5&is=65d769d5&hm=da8b9b953265e960d431ae0b81b558375c4d9b5a65ee898224559840b6b60467&)
it's a 0 arg control code
it literally does nothing but exist as a single character

=== @ Orithan 04/07/2022 15:36

No it's not just the /29
It's specifically this string and one other
I am thinking this is a string table corruption error stemming from the builds where that was a problem

=== @EmilyV99 (discord: Emily) 04/07/2022 15:37

but that shouldn't change on reloading

=== @ Orithan 04/07/2022 15:38

Then ZQ must not be initializing the string table correctly on first load or something?

=== @EmilyV99 (discord: Emily) 04/07/2022 15:38

and if it did, it would be an issue fixable by resaving
"first load"
there is no difference
between a first or second load
if you load once then load again
they run identically

=== @ Orithan 04/07/2022 15:39

Then why is it garbling the strings on the first time I open ZQ on it?

=== @EmilyV99 (discord: Emily) 04/07/2022 15:39

That is a GREAT fucking question

=== @ Orithan 04/07/2022 15:39

It goes away when I reload the quest with that instance

=== @EmilyV99 (discord: Emily) 04/07/2022 15:39

What happens if you first load a different quest, then that quest?

=== @arceusplayer11 (discord: Deedee) 04/07/2022 15:39

if you re-save the quest (as a duplicate, just in case), and re-open that saved quest, does it still corrupt on opening

=== @ Orithan 04/07/2022 15:40

Yes.
Did that

=== @EmilyV99 (discord: Emily) 04/07/2022 15:40

Here's the thing
if it looks right in the editor
and you click save

=== @ Orithan 04/07/2022 15:40

(replying to @EmilyV99 (discord: Emily) "What happens if you first loa‚Ä¶"): The first time I load the quest on that instance it corrupts

=== @EmilyV99 (discord: Emily) 04/07/2022 15:40

it should not be ABLE to fucking garble it again

=== @ Orithan 04/07/2022 15:40

(replying to @EmilyV99 (discord: Emily) "it should not be ABLE to fuck‚Ä¶"): It does

=== @EmilyV99 (discord: Emily) 04/07/2022 15:40

So wait
If you load the quest
then load a completely different quest
then load the quest again
it still works?
(Even if the different quest also has strings with those IDs that have content?)

=== @ Orithan 04/07/2022 15:41

(replying to @EmilyV99 (discord: Emily) "it still works?"): It still works

=== @EmilyV99 (discord: Emily) 04/07/2022 15:41

(replying to @EmilyV99 (discord: Emily) "(Even if the different quest‚Ä¶"): ?

=== @ Orithan 04/07/2022 15:43

Loaded up an older version, still problems

=== @ Orithan 04/07/2022 15:44

Loaded up another quest, no problems on those string IDs

=== @EmilyV99 (discord: Emily) 04/07/2022 15:44

but like
load problem quest
load other quest with those string IDs
load problem quest
Does problem quest still load correctly as it's the second load?
or does it have garbled parts of the strings from the other quest?

=== @ Orithan 04/07/2022 15:47

What happened:
Started instance on other quest, no apparent issues
Loaded problem quest, no apparent issues
Loaded other quest again, no apparent issues

=== @EmilyV99 (discord: Emily) 04/07/2022 15:48

...it must be something to do with initializing the string table then, yeah
but that doesn't make any fucking sense
and like
that hasn't changed in a fair while

=== @ Orithan 04/07/2022 15:48

This time:
Started instance on problem quest, problems
Loaded other quest, no apparent issue
Loaded problem quest again, no apparent issues
I'm going to go with my gut feelings and think one of the builds you just posted broke this

=== @EmilyV99 (discord: Emily) 04/07/2022 15:50

I literally did not modify zquest
it literally cannot be
everything I modified about SCCs was 100% ZC-side

=== @ Orithan 04/07/2022 15:50

No it is not one of your builds
Which means I am going to get this file done and ship it off to Dimi to claim

=== @EmilyV99 (discord: Emily) 04/07/2022 15:51

give me one minute
I have one idea

=== @EmilyV99 (discord: Emily) 04/07/2022 15:53


https://cdn.discordapp.com/attachments/961592870505160724/961654991284731974/zquest.exe?ex=65e9e300&is=65d76e00&hm=d27caa3fe9bad645327fcdebf0e2be70709d8f48f1615af66a2294caa0182da0&
https://cdn.discordapp.com/attachments/961592870505160724/961654991867764756/zelda.exe?ex=65e9e300&is=65d76e00&hm=9b49bec6997641c1a8b0ebd1aef5d7a33dc9e7fa130c935906f3116da194a812&
I swear to fuck if this fixes it
I am gonna be so pissed at C++

=== @ Orithan 04/07/2022 15:54

Nope, doesn't fix

=== @EmilyV99 (discord: Emily) 04/07/2022 15:55

uhg
ok
then I have literally no clue

=== @ Orithan 04/07/2022 15:56

I swear to god if this is what kills 1 Screen Gollab...

=== @EmilyV99 (discord: Emily) 04/07/2022 15:57

Here's the thing
which is good news
if it's loading correctly, just not on the first time
that means the correct data is indeed stored in the .qst
uncorrupted
it just isn't loading right on the first load due to a current bug
so, something is wrong which COULD cause corruption, if you saved after a first load
but if you load twice so that the values are right, then you should be fine to do whatever and re-save
just, don't save while the values are garbled

=== @EmilyV99 (discord: Emily) 04/07/2022 15:59

Question, do you have more or less than 4096 strings in the string table?

=== @EmilyV99 (discord: Emily) 04/07/2022 16:01

@arceusplayer11 (discord: Deedee) definitely gonna need your help to look into this, because I have NO damned clue

=== @arceusplayer11 (discord: Deedee) 04/07/2022 16:02

@EmilyV99 (discord: Emily) I'll only look at it if you co-pilot/watch me stream and offer solutions
Last time I looked at it I had no fucking clue lmao

=== @EmilyV99 (discord: Emily) 04/07/2022 16:03

Frankly deedee, the problem here is that I know what I'm doing
and NOTHING IS WRONG

=== @ Orithan 04/07/2022 16:03

(replying to @EmilyV99 (discord: Emily) "Question, do you have more or‚Ä¶"): Less

=== @EmilyV99 (discord: Emily) 04/07/2022 16:03

(replying to @EmilyV99 (discord: Emily) "and NOTHING IS WRONG"): having someone who DOESN'T know how it works poke at it is probably the better way to get something done
because, fresh eyes, and all that
@ Orithan we're gonna need the quest file

=== @ Orithan 04/07/2022 16:04

Am gonna package it soon
It will have to be over Google Docs because its over my upload filesize limit (THANKS DISCORD)

=== @ Orithan 04/07/2022 16:06

It's now affecting more strings

=== @arceusplayer11 (discord: Deedee) 04/07/2022 16:06

okay, so just to recap
when you open the quest once, it garbles up the string editor
but if you reopen it a *second* time, it's fixed?

=== @ Orithan 04/07/2022 16:07

On a couple of strings

=== @arceusplayer11 (discord: Deedee) 04/07/2022 16:07

What happens if you reopen it a third time?

=== @EmilyV99 (discord: Emily) 04/07/2022 16:07

opening a different quest first then the problem quest also works
it has nothing to do with opening the quest twice, and everything to do with it being the first thing ZQ loads on launch
that's basically everything I can gather from this
but
that would imply to me
that `MsgStrings[]` is being initialized wrong
but
it
it just
it isn't
so I have no clue

=== @ Orithan 04/07/2022 16:13

This problem also extends to ZC as well

=== @EmilyV99 (discord: Emily) 04/07/2022 16:14

That actually makes sense
all the allocation code is shared
as is quest loader code

=== @ Orithan 04/07/2022 16:19

File:
https://drive.google.com/file/d/1bJWgqx9zor7pjahVeCr65WTmSwXo_Gvw/view?usp=sharing
Its very late on my end and I need sleep. Nini

=== @EmilyV99 (discord: Emily) 04/07/2022 16:20

my sleep cycle matches yours lol
struggling to stay awake as long as I have

=== @ Orithan 04/07/2022 16:21

I stayed up a couple hours longer than I should have trying to pinpoint these issues

=== @arceusplayer11 (discord: Deedee) 04/07/2022 16:23

(replying to @EmilyV99 (discord: Emily) "struggling to stay awake as l‚Ä¶"): go to bed

=== @arceusplayer11 (discord: Deedee) 04/07/2022 16:45

@EmilyV99 (discord: Emily) live update; it's reading the string fine in qst.cpp readstring
so it's breaking somewhere else

=== @arceusplayer11 (discord: Deedee) 04/07/2022 16:48

Saving it while it's garbled does save the garbled mess as well

=== @arceusplayer11 (discord: Deedee) 04/07/2022 16:55

@EmilyV99 (discord: Emily) you still there?
the copyText function in zdefs.h, line 3639 is where the data is getting jumbled
```void copyText(MsgStr const& other)
    {
        s = other.s;
        s.shrink_to_fit();
        nextstring=other.nextstring;
    }```
`other.s` is the correct string when debugging
but `s` is corrupted immediately after the assign; debugger seems to think it's even happening before the shrink_to_fit
so immediate thought is the way it's assigning is wrong

=== @arceusplayer11 (discord: Deedee) 04/07/2022 17:00

I don't see why it'd be wrong though

=== @arceusplayer11 (discord: Deedee) 04/07/2022 17:06

This function is definitely where things are getting fucked up though; why it's doing it here and whether or not it's being caused by something elsewhere I don't know
It's certainly setting the size right and setting the right amount of characters

=== @arceusplayer11 (discord: Deedee) 04/07/2022 17:07

I think, anyways.
is it?
I think that's one character too many, fuck.
But either way, I breakpointed it and stuff; the value of s doesn't change at all after that *until* I change the string in the editor afterwards, so it's not getting corrupted any further after this function
I'm rambling, but that's cause I don't know how C++ strings work or where to begin looking for the root cause

=== @arceusplayer11 (discord: Deedee) 04/07/2022 20:00

in any case Emily, whenever you get up, I haven't touched it at all. You'd know more about C++ than me, you're more likely to think of some dumb reason why this wouldn't work than I would

=== @EmilyV99 (discord: Emily) 04/08/2022 00:14

(replying to @arceusplayer11 (discord: Deedee) "so immediate thought is the w‚Ä¶"): What the FUCK?

=== @ Orithan 04/08/2022 00:51

If this is of any help, string 107 in the quest file was behaving fine until I changed some String->Next things in the editor.
After then I wrote it as [TBD], saved and quit ZQ
I returned to ZQ to find that it was bugging out and kept bugging out since

=== @ Orithan 04/08/2022 00:54

I highly suspect something is going wrong with the saving process that is corrupting data when I reload with ZQ

=== @EmilyV99 (discord: Emily) 04/08/2022 00:55

No, or else it wouldn't ever load back correctly
If it were an issue in saving, it wouldn't be random at all, it would be broken every load

=== @ Orithan 04/08/2022 00:55

Explain how String 107 was behaving correctly until I did what I did?

=== @EmilyV99 (discord: Emily) 04/08/2022 00:55

It could be an issue with some character specifically
Deedee found where it is breaking already

=== @ Orithan 04/08/2022 00:56

The other string that was bugging out was a string of ellipses.

=== @EmilyV99 (discord: Emily) 04/08/2022 00:56

It just.... is breaking inside a standard C++ function, not a ZC function

=== @ Orithan 04/08/2022 00:56

105 just contained ellipses and an SCC.

=== @EmilyV99 (discord: Emily) 04/08/2022 00:56

Which scc

=== @ Orithan 04/08/2022 00:57

``\3\0\1\106``
Its not in the file anymore because I removed it
107 never contained SCCs

=== @EmilyV99 (discord: Emily) 04/08/2022 00:57

Huh
Odd
I have one idea to try to fix it, which I'll check when my pizza gets here

=== @ Orithan 04/08/2022 00:58

String 112, which isn't in this file, bugged out and it had the ``\30`` and ``\29`` sccs, notably with the ``\29`` being at the very end
String 105 bugged out and the scc was the end of the string

=== @ Orithan 04/08/2022 01:01

I'm going to see if I can replicate this behaviour in new strings on a test branch of this file

=== @ Orithan 04/08/2022 01:20


![image](https://cdn.discordapp.com/attachments/961592870505160724/961797652817793084/2022-04-08_11-18-25.mp4?ex=65ea67dd&is=65d7f2dd&hm=c9bc2e7e181623de58583d4f6a30f3010fa93fde15c2f1fb5b2ead8e4e859b9a&)
This happens after I clear the strings while they loaded the correct stuff and saved

=== @ Orithan 04/08/2022 01:21

Tl;dr: It garbles the strings into random SCCs after the first time I type stuff into the string and exit back to the string editor after clearing it.

=== @EmilyV99 (discord: Emily) 04/08/2022 01:28

what the fuck

https://cdn.discordapp.com/attachments/961592870505160724/961799823449817118/zquest.exe?ex=65ea69e3&is=65d7f4e3&hm=7b2172715f02b5cb2aa49032118857b8504818e3e70013e62981c3635179ed80&
https://cdn.discordapp.com/attachments/961592870505160724/961799824053784596/zelda.exe?ex=65ea69e3&is=65d7f4e3&hm=508e37e8988c3a316b63404763042f424a27c00e8203834d13f696b3efc0279c&
does this do anything?

=== @ Orithan 04/08/2022 01:31

Does nothing

=== @EmilyV99 (discord: Emily) 04/08/2022 01:34

I'm SO fucking confused
2+2=71 would be less confusing than this

=== @ Orithan 04/08/2022 01:35

I'm going to see if I can pinpoint what things I type that cause this issue

=== @ Orithan 04/08/2022 02:24

I've been able to reliably replicate this bug in new strings

=== @ Orithan 04/08/2022 02:26

It appears putting certain characters or SCCs at the end of a string causes problems
Putting a ``.`` at the end of the string causes that string to bug out like this

=== @ Orithan 04/08/2022 02:30

Now any new string I am adding is bugging out

=== @ Orithan 04/08/2022 02:32

I am really scared now that the string table as a whole has become corrupted
I don't care if the strings themselves are not actually corrupted, there is some corruption going on here
And its affecting _every_ new string I make

=== @EmilyV99 (discord: Emily) 04/08/2022 02:34

but reloading twice still fixes it?

=== @ Orithan 04/08/2022 02:34

Yes

=== @EmilyV99 (discord: Emily) 04/08/2022 02:34

the actual .qst file is not corrupted then

=== @ Orithan 04/08/2022 02:34

The strings are being stored correctly, but there must be some sort of corruption going on.

=== @EmilyV99 (discord: Emily) 04/08/2022 02:35

something is wrong in loading them

=== @ Orithan 04/08/2022 02:35

(replying to @EmilyV99 (discord: Emily) "the actual .qst file is not c‚Ä¶"): How come it's happening with only strings from this quest?

=== @EmilyV99 (discord: Emily) 04/08/2022 02:35

I have no fucking clue
It has to be something specific to replicate

=== @ Orithan 04/08/2022 02:36

When was the new string editor added?

=== @EmilyV99 (discord: Emily) 04/08/2022 02:36

feb 25th nightly
alpha is 104

=== @ Orithan 04/08/2022 02:38

So right after Alpha 103's release

=== @ Orithan 04/08/2022 02:39

I'm gonna do some digging to see if this is related to the String Editor corruption

=== @EmilyV99 (discord: Emily) 04/08/2022 02:40

oh of course it is
that should be obvious

=== @ Orithan 04/08/2022 03:12

(replying to @EmilyV99 (discord: Emily) "something is wrong in loading‚Ä¶"): This has to be specifically because its running into corrupted data from the quest file

=== @EmilyV99 (discord: Emily) 04/08/2022 03:13

but then it couldn't load properly the second time
if the .qst is corrupted it is unreadable

=== @ Orithan 04/08/2022 03:13

Why is it quest file specific?

=== @EmilyV99 (discord: Emily) 04/08/2022 03:14

it probably isn't
it probabably requires some specific weird thing in order to trigger

=== @EmilyV99 (discord: Emily) 04/08/2022 03:17

(meta) thread name was changed: üíäüîìString editor issues

=== @EmilyV99 (discord: Emily) 04/08/2022 03:32


https://cdn.discordapp.com/attachments/961592870505160724/961830863518191636/zquest.exe?ex=65ea86cb&is=65d811cb&hm=d21012b25b78d4602074c453082002043a048c8899b5a3df89148bbe08446bf3&

=== @ Orithan 04/08/2022 03:32

As it turns out, it _isn't_ related to string data corruption.

=== @EmilyV99 (discord: Emily) 04/08/2022 03:32

Oh? Have you found something?

=== @ Orithan 04/08/2022 03:33

I grabbed a version of 1 Screen Gollab dating from prior to Alpha 103. Made a bunch of strings and saved it in this version
The majority of them are garbled

=== @EmilyV99 (discord: Emily) 04/08/2022 03:33

fun
good to have that confirmed at least

=== @ Orithan 04/08/2022 03:33

None of these have SCCs

=== @EmilyV99 (discord: Emily) 04/08/2022 03:33

open the zquest I posted above
but
delete allegro.log first
load the quest once, garbled
send me allegro.log
delete allegro.log
load the quest again fixed
and send allegro.log again
it should be printing like 20 lines per message string, so it should be a fair bit of output
I just added a fuckton of traces

=== @ Orithan 04/08/2022 03:37

For the garbled load
https://cdn.discordapp.com/attachments/961592870505160724/961832120790179870/allegro.log?ex=65ea87f7&is=65d812f7&hm=3c24cd48dec0e1464df7c176ed150bafada82b75a9aa3ce223b3e5d571c44ba8&
For the fixed load
https://cdn.discordapp.com/attachments/961592870505160724/961832257356714005/allegro.log?ex=65ea8818&is=65d81318&hm=c6811c48adc2f435215f0b15cc945732086befdf0ad4b55414d72afd8248e138&

=== @EmilyV99 (discord: Emily) 04/08/2022 03:39

which string indexes are garbled?

=== @ Orithan 04/08/2022 03:40

I'll record a video

=== @EmilyV99 (discord: Emily) 04/08/2022 03:41

oh
well I see a printout

![image](https://cdn.discordapp.com/attachments/961592870505160724/961833159425667112/unknown.png?ex=65ea88ef&is=65d813ef&hm=c03753037a7fbfa67d3750e8d82a357585ea3b6b99fca3a22e6c0b28db7acdc4&)
the `buffer` val has overrun from the previous string
...which, where I'm printing that, makes sense
that is corrected before the `stringval` printout
....and then the `copied string` is just fucking wrong
for a string of `"Last test"`
like
there aren't even any fucking special characters in that

![image](https://cdn.discordapp.com/attachments/961592870505160724/961833642324279296/unknown.png?ex=65ea8962&is=65d81462&hm=a35532d0eb8b412b2a6597181c95a1f987dea3a2706108d9abfe65524ad75171&)
this shows the same buffer issue, which is expected, but corrects it
and then *works* for the copy
like
what
the actual fuck

=== @ Orithan 04/08/2022 03:43


![image](https://cdn.discordapp.com/attachments/961592870505160724/961833730241073183/2022-04-08_13-40-13.compressed.mp4?ex=65ea8977&is=65d81477&hm=a4b7807bf3ad9ec42a79f62c3c9f9bb64246eb826bc20c31ef000aa8d2effdba&)

=== @EmilyV99 (discord: Emily) 04/08/2022 03:44

For the record, the problem here
seems to be that doing `string var = otherstr` is just not working
which
is internal c++ code
and not anything of ours
so how the fuck is it broken

=== @ Orithan 04/08/2022 03:45

I'm gonna do the same in a build prior to the March 25th nightly

=== @EmilyV99 (discord: Emily) 04/08/2022 03:47

are the test strings the same in the drive file you posted earlier?

=== @ Orithan 04/08/2022 03:47

No

=== @EmilyV99 (discord: Emily) 04/08/2022 03:47

mind posting it again then

=== @ Orithan 04/08/2022 03:47

The Drive file?

=== @EmilyV99 (discord: Emily) 04/08/2022 03:47

whatever you just sent allegro.log output from

=== @ Orithan 04/08/2022 03:47


https://cdn.discordapp.com/attachments/961592870505160724/961834766309666866/GGG_Unjoker1.qst?ex=65ea8a6e&is=65d8156e&hm=f65b8e2795b3c9e598a177e47e0d014351b20ba401dfd7d01e1f543fe14c2a3e&
This is the test file I did the Allegro.log output from

=== @EmilyV99 (discord: Emily) 04/08/2022 03:48

k

=== @ Orithan 04/08/2022 03:49

The test strings are random nonsense that spilled from my mind

=== @EmilyV99 (discord: Emily) 04/08/2022 03:51

I'm trying something stupid
let's hope it works

=== @EmilyV99 (discord: Emily) 04/08/2022 03:53

changing fucking zdefs.h makes it take FOREVER to fucking compile uhhhhg

=== @EmilyV99 (discord: Emily) 04/08/2022 03:54

what the fuck
it didn't work
gaaah

=== @ Orithan 04/08/2022 04:16

Tried to replicate this issue in Alpha 103. This is absent from Alpha 103
Gonna try Alpha 104 now

=== @EmilyV99 (discord: Emily) 04/08/2022 04:17

it would be absent in A103, no new string stuff

=== @ Orithan 04/08/2022 04:28

This issue is absent from the Feburary 25th Nightly which introduced the new string editor

=== @EmilyV99 (discord: Emily) 04/08/2022 04:37

I
I think I fixed it?
What the fuck

=== @EmilyV99 (discord: Emily) 04/08/2022 04:40


![image](https://cdn.discordapp.com/attachments/961592870505160724/961847989008220200/unknown.png?ex=65ea96be&is=65d821be&hm=f5bc9b69333981f353d353dbd4adae34d0a4cbf5ae8507b235c3dfca4c0aa0df&)
So, this used to be `s = other.s;`
which is a string assignment
which.... is basic C++, and should work without problems
thus the confusion as to why it wasn't working
Upon trying `s.assign(other.s)` it also didn't work
same with `s.assign(other.s.c_str())`, which uses a null-terminated ("C-style") string for the assignment
Doing `s.resize(0)` in an effort to clear the string first did nothing
...adding a trace revealed that it was, in fact, already cleared properly!
On a whim, I asked `What if I resize it to the size it needs to be? The assign should do that for me, but, why not try it?`
and fucking suddenly
I don't see the issue anymore

=== @ Orithan 04/08/2022 04:42

The issue can be traced back as far as the 4/4/2022 Nightly

=== @EmilyV99 (discord: Emily) 04/08/2022 04:42


https://cdn.discordapp.com/attachments/961592870505160724/961848544824803368/zquest.exe?ex=65ea9743&is=65d82243&hm=e0ae8504dca89c4549289e195c1dd193114e7c3390904fea5cf1e6603dacd91e&
https://cdn.discordapp.com/attachments/961592870505160724/961848545449750529/zelda.exe?ex=65ea9743&is=65d82243&hm=47dba4d78c13be3e7f530d704dfbe0f0fceb9ed968bc0c74d74423ec8c6ac793&

=== @ Orithan 04/08/2022 04:42

I suspect the fix Dimi made somehow broke this

=== @EmilyV99 (discord: Emily) 04/08/2022 04:43

yeah, I would guess
but it definitely isn't her fault
because like

=== @ Orithan 04/08/2022 04:43

Oh totally

=== @EmilyV99 (discord: Emily) 04/08/2022 04:43

whatever this is, should not be possible

=== @ Orithan 04/08/2022 04:43

I don't fault her for this

=== @EmilyV99 (discord: Emily) 04/08/2022 04:43

I fixed it with a workaround hack
and the core problem
just
should not be possible
this is cursed bullshit

=== @ Orithan 04/08/2022 04:43

Methinks its Black Box Windows shenanigans
But how?

=== @EmilyV99 (discord: Emily) 04/08/2022 04:44

<:nekoshrug:869489800271503400>
(meta, MessageType.pins_add) 
anyway, if you can just confirm that it isn't fixed ONLY for me or some shit
that would be wonderful
because at this level of cursed bullshit, I think we just have to excpect everything to go wrong
Also, curious if @connorjclark (discord: connorclark) or @ Saffith have any ideas about this
because like
I have no idea why assigning an std::string to another std::string would fail
but work if you add a manual resize call first

=== @ Orithan 04/08/2022 04:46

It's fixed on my end

=== @EmilyV99 (discord: Emily) 04/08/2022 04:46

For reference,
`s = other.s;` -> garbled garbage character values
```s.resize(other.s.size());
s.assign(other.s.c_str());```->works
where `s` and `other.s` are strings
curious if resizing before a standard `=` assignment would work
or if the `.c_str()` is necessary
but frankly don't care enough

![image](https://cdn.discordapp.com/attachments/961592870505160724/961849889174728724/unknown.png?ex=65ea9883&is=65d82383&hm=b9bd54f9c589eefdc6acb43b9e1ac8cbd948a46eaedb28fb3fef8a52368d6551&)
(meta) thread name was changed: ‚úÖüîíString editor issues

=== @ Orithan 04/08/2022 04:49

Uhh... BitDefender is registering ZC and ZQ as infected

=== @ NightmareJames 04/08/2022 04:49

Hello

=== @ Orithan 04/08/2022 04:49

This specific build

=== @EmilyV99 (discord: Emily) 04/08/2022 04:50

(replying to @ Orithan "Uhh... BitDefender is registe‚Ä¶"): fun!
<:nkoSigh:585926650273988632>

=== @ Orithan 04/08/2022 04:50

...It hit ZLauncher and ZQ

=== @EmilyV99 (discord: Emily) 04/08/2022 04:50

pfffft fun
ZC?

=== @ Orithan 04/08/2022 04:51

Wasn't touched

=== @EmilyV99 (discord: Emily) 04/08/2022 04:51

wait, I didn't give you a new zlauncher

=== @ Orithan 04/08/2022 04:51

Nope.

=== @EmilyV99 (discord: Emily) 04/08/2022 04:51

wtf

=== @ Orithan 04/08/2022 04:51

It registered as a threat the moment I clicked Test Quest

=== @EmilyV99 (discord: Emily) 04/08/2022 04:51

oh
that uhh
makes some sense
it isn't liking ZCL/ZQ trying to launch processes

=== @ Orithan 04/08/2022 04:52

What prevented previous builds from getting flagged?

=== @EmilyV99 (discord: Emily) 04/08/2022 04:52

not a clue, nothing's changed there
perhaps something changed on BitDefender's end
or perhaps some random bit of the binary in the code changed in a way that happens to be creating a false flag

=== @ Orithan 04/08/2022 04:53

It's not affecting the previous nightly

=== @EmilyV99 (discord: Emily) 04/08/2022 04:53

because, all a .exe is is a ton of binary numbers
I have no idea what else would cause a new flagging

=== @connorjclark (discord: connorclark) 04/08/2022 04:55

@EmilyV99 (discord: Emily) how was MsgStr made? I think using malloc to instate a std::string member is a bug b/c std::string sets up some memory in its ctor, which malloc approach skips
this seems to corroborate https://stackoverflow.com/a/33210759/2788187

=== @EmilyV99 (discord: Emily) 04/08/2022 04:55

(replying to @connorjclark (discord: connorclark) "@EmilyV99 (discord: Emily) how was‚Ä¶"): yes, but it is nulled after that

=== @ Orithan 04/08/2022 04:55

It's telling me I need permission to move anything to the current folder

=== @EmilyV99 (discord: Emily) 04/08/2022 04:55

???

=== @ Orithan 04/08/2022 04:55

I try doing this as Administrator and am denied

=== @EmilyV99 (discord: Emily) 04/08/2022 04:55

uhhh
that sounds like BitDefender itself is being a virus

=== @connorjclark (discord: connorclark) 04/08/2022 04:55

and I see some calls to malloc for this class so I think thats the problem. the resize is fixing it because std::string is then owning its own memory again as it expects

=== @EmilyV99 (discord: Emily) 04/08/2022 04:56

(replying to @connorjclark (discord: connorclark) "and I see some calls to mallo‚Ä¶"): `resize(0)` did not fix it

=== @connorjclark (discord: connorclark) 04/08/2022 04:56

(just a guess)
huh idk then

=== @EmilyV99 (discord: Emily) 04/08/2022 04:56

and, printing the string before resize
it was printing `\"%s\"` -> `""`
so, size 0, just an empty string
but then upon assigning to it
it suddenly was garbled as hell
I removed all `memset` calls clearing the `MsgStr` class
replacing them with a `.clear()` call, which did `s = "";`
because, I figured memset/malloc might be an issue
but once `s = "";` ran and it printed as `""`, I figure that wouldn't be the issue anymore
even if it were, I would think `resize(0)` would fix it

=== @ Orithan 04/08/2022 04:58

It's also killed my Firefox stuff

=== @connorjclark (discord: connorclark) 04/08/2022 04:58

but still, a class with std::string fields shouldnt be made with malloc. if you do `new` then std::string ctors gets called as expected. otherwise malloc is just zeroes and who knows what setup std::string ctor does is missing. my assumption is that some ammount of .resize or .assign triggers the same setup code its `ctor` would

i'm just regurgiated shit i googled here's my source https://stackoverflow.com/a/3411902/2788187

=== @ Orithan 04/08/2022 04:58

Nothing loads on Firefox

=== @EmilyV99 (discord: Emily) 04/08/2022 04:59

uhhhh
I have no clue @ Orithan
Pretty sure the cleanly build exe isn't infected
so I'd suspect BitDefender itself to be an issue

=== @ Orithan 04/08/2022 04:59

It isn't I am positive it is a false flag

=== @EmilyV99 (discord: Emily) 04/08/2022 05:00

when an antivirus decides to become a virus itself, always fun

=== @EmilyV99 (discord: Emily) 04/08/2022 05:03

(replying to @connorjclark (discord: connorclark) "but still, a class with std::‚Ä¶"): eh, weird
at least this seems to work now

=== @ Orithan 04/08/2022 05:07

(replying to @EmilyV99 (discord: Emily) "when an antivirus decides to‚Ä¶"): It outright nuked my Firefox because it thought it was part of the supposed attack
My Firefox just won't do anything now

=== @EmilyV99 (discord: Emily) 04/08/2022 05:16

Wow

=== @ Orithan 04/08/2022 05:18

Trying to search up this issue
It is also noted that I had the whole Zelda Classic folder whitelisted from the antivirus

=== @ Orithan 04/08/2022 05:21

The culprit appears to be Advanced Threat Defense but then it's not giving me access to whitelisting stuff from it
https://www.reddit.com/r/BitDefender/comments/phkyml/atc4detection_is_terrible_and_ignores_the/

=== @EmilyV99 (discord: Emily) 04/08/2022 05:23

Sounds like time for a new antivirus to me

=== @ Orithan 04/08/2022 05:23

It's not the first time it's gone scorched earth on me over a download

=== @ Orithan 04/08/2022 05:24

The first time it happened it was an exe that was designed to get around Windows' forcing of Edge to be default browser when that was stealthily added to Windows 10, except it didn't cause any collateral damage.
(replying to @EmilyV99 (discord: Emily) "Sounds like time for a new an‚Ä¶"): What other antiviruses are good?

=== @EmilyV99 (discord: Emily) 04/08/2022 05:25

Uhh
This is a good question
Norton hasn't served me wrong, though I never have had to actually pay for it

=== @ Orithan 04/08/2022 05:26

Norton is one of the worst

=== @EmilyV99 (discord: Emily) 04/08/2022 05:27

Given your current predicament, it clearly is better than BitDefender

=== @ Orithan 04/08/2022 05:27

I was recommended BitDefender because it was the best antivirus but now I question that after it nuked my Firefox because I downloaded ZC stuff with it.

=== @ Orithan 04/08/2022 05:35

https://www.d7xtech.com/bad-av/
```
The first type:  ‚ÄúInfected‚Äù

Often these ‚Äòfalse positives‚Äô directly state the file is infected, typically with something ‚Äògeneric‚Äô in the name.  Many times this is due to the software compression applied to the executable (program) file, in order to reduce file size and perhaps to help make the software ‚Äúportable‚Äù (meaning it doesn‚Äôt require ‚Äòinstallation‚Äô on a PC, but can run from wherever you downloaded it to.)

Tools used to compress executable files (aka ‚Äòexe packers‚Äô or similar) can greatly reduce file size, saving space but also internet bandwidth in distribution efforts, ultimately reducing overhead costs.  They can also obscure source code that is visible (using the right tools) inside the program, providing protection against decompilation and other techniques of ‚Äòreverse-engineering‚Äô the software, which software crackers would use in theft of the product, such as ‚Äòpiracy‚Äô (through usage and/or distribution) but also with theft of the intellectual property itself by direct source code reproduction.

Of course, the above also makes it more difficult for an Anti-whatever vendor to make a determination about the software‚Äôs intent ‚Äì more often than not they don‚Äôt care to properly unpack and examine the executable, but rather mark it as malicious simply because that type of compression is detected.
```

=== @EmilyV99 (discord: Emily) 04/08/2022 05:37

Pffffft
That's fun
That's like just saying "All zip files are malicious because they are compressed"
To be fair, GDrive basically does exactly that
But it's error isn't that the zip is infected, rather it specifically says `yeah we can't scan this, so, no idea if it's good or bad`

=== @ Orithan 04/08/2022 07:00

(replying to @EmilyV99 (discord: Emily) "Norton hasn't served me wrong‚Ä¶"): Have you ever noticed your computer throttling with Norton?

=== @EmilyV99 (discord: Emily) 04/08/2022 07:11

no

=== @ Orithan 04/08/2022 07:14

Well there are reports of Norton using your system resources to mine bitcoin

=== @EmilyV99 (discord: Emily) 04/08/2022 07:26

oh that's fun

=== @ Saffith 04/10/2022 03:22

I didn't get around to committing it, but I tried changing MsgStrings to a vector so it would initialize strings properly, and it seemed to work without issues. Didn't take much work, either.
But I still want to test it a little more.

=== @EmilyV99 (discord: Emily) 04/10/2022 05:37

currently it's set up using `new[]` and `delete[]`
